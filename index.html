<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>erhabene</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@300;400;500;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
<style>
:root {
  --lavender: #c9b8e8;
  --lavender-light: #e8e0f5;
  --lavender-soft: #f3eff9;
  --milk-blue: #b8d4e8;
  --milk-blue-light: #daeaf5;
  --milk-blue-soft: #eef5fb;
  --beige: #f0e8d8;
  --beige-dark: #d4c4a8;
  --beige-soft: #faf6f0;
  --text-dark: #3d3450;
  --text-mid: #6b5f7a;
  --text-light: #a89bb5;
  --white: #fefefe;
  --shadow: rgba(180,160,210,0.18);
  --shadow-deep: rgba(100,80,140,0.12);
  --bubble-user: linear-gradient(135deg, #c9b8e8, #b8c8e8);
  --bubble-ai: rgba(255,255,255,0.9);
  --sidebar-bg: linear-gradient(180deg, #f3eff9 0%, #eef5fb 50%, #faf6f0 100%);
  --header-bg: rgba(243,239,249,0.95);
  --nav-active: #c9b8e8;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  font-family: 'Zen Kaku Gothic New', sans-serif;
  background: var(--beige-soft);
  color: var(--text-dark);
  height: 100dvh;
  overflow: hidden;
  display: flex;
}

/* ‚îÄ‚îÄ‚îÄ SETUP SCREEN ‚îÄ‚îÄ‚îÄ */
#setup-screen {
  position: fixed; inset: 0;
  background: linear-gradient(160deg, #f3eff9 0%, #eef5fb 40%, #faf6f0 100%);
  display: flex; align-items: center; justify-content: center;
  z-index: 9999;
  flex-direction: column;
  gap: 2rem;
}

.setup-card {
  background: rgba(255,255,255,0.82);
  backdrop-filter: blur(20px);
  border-radius: 28px;
  padding: 3rem;
  width: min(460px, 92vw);
  box-shadow: 0 8px 40px var(--shadow), 0 2px 8px var(--shadow-deep);
  border: 1px solid rgba(201,184,232,0.3);
}

.setup-logo {
  font-family: 'Cormorant Garamond', serif;
  font-size: 2.8rem;
  font-weight: 300;
  font-style: italic;
  color: var(--text-dark);
  text-align: center;
  margin-bottom: 0.3rem;
  letter-spacing: 0.05em;
}
.setup-tagline {
  text-align: center;
  font-size: 0.78rem;
  color: var(--text-light);
  letter-spacing: 0.15em;
  text-transform: uppercase;
  margin-bottom: 2.2rem;
}

.setup-field { margin-bottom: 1.2rem; }
.setup-label {
  display: block;
  font-size: 0.78rem;
  color: var(--text-mid);
  margin-bottom: 0.5rem;
  letter-spacing: 0.08em;
}
.setup-input, .setup-select {
  width: 100%;
  padding: 0.85rem 1.1rem;
  border: 1.5px solid var(--lavender-light);
  border-radius: 14px;
  background: var(--lavender-soft);
  color: var(--text-dark);
  font-family: inherit;
  font-size: 0.9rem;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.setup-input:focus, .setup-select:focus {
  border-color: var(--lavender);
  box-shadow: 0 0 0 3px rgba(201,184,232,0.2);
}
.setup-select option { background: white; }

.setup-btn {
  width: 100%;
  padding: 1rem;
  background: linear-gradient(135deg, #c9b8e8, #b8cce8);
  border: none;
  border-radius: 16px;
  color: white;
  font-family: inherit;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s;
  margin-top: 0.5rem;
  letter-spacing: 0.05em;
}
.setup-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(180,160,220,0.4); }
.setup-btn:active { transform: translateY(0); }

/* ‚îÄ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ‚îÄ */
#app { display: flex; width: 100%; height: 100dvh; }

/* ‚îÄ‚îÄ‚îÄ LEFT NAV (Desktop) ‚îÄ‚îÄ‚îÄ */
#side-nav {
  width: 68px;
  background: var(--lavender-soft);
  border-right: 1px solid rgba(201,184,232,0.2);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 1.2rem 0;
  gap: 0.3rem;
  z-index: 100;
  flex-shrink: 0;
}

.nav-logo {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.1rem;
  font-style: italic;
  color: var(--lavender);
  margin-bottom: 1rem;
  writing-mode: horizontal-tb;
}

.nav-btn {
  width: 46px; height: 46px;
  border-radius: 14px;
  border: none;
  background: transparent;
  color: var(--text-light);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.3rem;
  transition: background 0.2s, color 0.2s;
  position: relative;
}
.nav-btn:hover { background: var(--lavender-light); color: var(--text-dark); }
.nav-btn.active { background: var(--lavender); color: white; }
.nav-btn .badge {
  position: absolute; top: 6px; right: 6px;
  width: 8px; height: 8px;
  background: #e8a0b8;
  border-radius: 50%;
}

.nav-spacer { flex: 1; }

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
#sidebar {
  width: 300px;
  background: var(--sidebar-bg);
  border-right: 1px solid rgba(201,184,232,0.25);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow: hidden;
}

.sidebar-header {
  padding: 1.2rem 1.2rem 0.8rem;
  border-bottom: 1px solid rgba(201,184,232,0.2);
}
.sidebar-title {
  font-size: 1rem;
  font-weight: 700;
  color: var(--text-dark);
  margin-bottom: 0.7rem;
}
.sidebar-search {
  display: flex; align-items: center;
  background: rgba(255,255,255,0.7);
  border-radius: 12px;
  padding: 0.5rem 0.8rem;
  gap: 0.5rem;
  border: 1px solid rgba(201,184,232,0.2);
}
.sidebar-search input {
  border: none; background: none; outline: none;
  font-family: inherit; font-size: 0.85rem;
  color: var(--text-dark); flex: 1;
}
.sidebar-search span { color: var(--text-light); font-size: 0.9rem; }

.sidebar-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
.sidebar-list::-webkit-scrollbar { width: 3px; }
.sidebar-list::-webkit-scrollbar-thumb { background: var(--lavender-light); border-radius: 2px; }

.chat-item {
  display: flex; align-items: center; gap: 0.8rem;
  padding: 0.75rem 0.8rem;
  border-radius: 16px;
  cursor: pointer;
  transition: background 0.15s;
  position: relative;
}
.chat-item:hover { background: rgba(255,255,255,0.6); }
.chat-item.active { background: rgba(255,255,255,0.85); box-shadow: 0 2px 8px var(--shadow); }

.chat-avatar {
  width: 46px; height: 46px; border-radius: 16px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 1.4rem; flex-shrink: 0;
  overflow: hidden; position: relative;
}
.chat-avatar img { width: 100%; height: 100%; object-fit: cover; }
.chat-avatar-status {
  position: absolute; bottom: 2px; right: 2px;
  width: 10px; height: 10px; border-radius: 50%;
  background: #a8d8a8; border: 2px solid white;
}

.chat-meta { flex: 1; min-width: 0; }
.chat-name { font-size: 0.9rem; font-weight: 500; color: var(--text-dark); }
.chat-preview { font-size: 0.78rem; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 0.15rem; }
.chat-time { font-size: 0.7rem; color: var(--text-light); }
.chat-unread {
  background: var(--lavender);
  color: white;
  border-radius: 10px;
  font-size: 0.7rem;
  padding: 0.15rem 0.45rem;
  font-weight: 500;
  min-width: 20px; text-align: center;
}

.add-chat-btn {
  margin: 0.5rem;
  padding: 0.7rem;
  background: linear-gradient(135deg, rgba(201,184,232,0.3), rgba(184,212,232,0.3));
  border: 1.5px dashed rgba(201,184,232,0.5);
  border-radius: 14px;
  color: var(--text-light);
  cursor: pointer;
  text-align: center;
  font-size: 0.82rem;
  font-family: inherit;
  transition: all 0.2s;
}
.add-chat-btn:hover { background: rgba(201,184,232,0.2); color: var(--text-mid); border-style: solid; }

/* ‚îÄ‚îÄ‚îÄ MAIN AREA ‚îÄ‚îÄ‚îÄ */
#main-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ‚îÄ‚îÄ‚îÄ CHAT HEADER ‚îÄ‚îÄ‚îÄ */
#chat-header {
  padding: 0.9rem 1.2rem;
  background: var(--header-bg);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(201,184,232,0.2);
  display: flex;
  align-items: center;
  gap: 0.9rem;
  flex-shrink: 0;
}

.header-avatar {
  width: 40px; height: 40px; border-radius: 13px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem; overflow: hidden; flex-shrink: 0;
}
.header-avatar img { width: 100%; height: 100%; object-fit: cover; }
.header-info { flex: 1; }
.header-name { font-size: 0.95rem; font-weight: 500; color: var(--text-dark); }
.header-status { font-size: 0.72rem; color: var(--text-light); }

.header-actions { display: flex; gap: 0.4rem; }
.header-btn {
  width: 36px; height: 36px; border-radius: 11px;
  border: none; background: transparent; cursor: pointer;
  color: var(--text-light); font-size: 1rem;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.15s, color 0.15s;
}
.header-btn:hover { background: var(--lavender-light); color: var(--text-dark); }

/* ‚îÄ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ‚îÄ */
#messages-area {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
  scroll-behavior: smooth;
}
#messages-area::-webkit-scrollbar { width: 4px; }
#messages-area::-webkit-scrollbar-thumb { background: var(--lavender-light); border-radius: 2px; }

.msg-group { display: flex; flex-direction: column; gap: 0.22rem; margin-bottom: 0.6rem; }
.msg-group.user { align-items: flex-end; }
.msg-group.ai { align-items: flex-start; }

.msg-row {
  display: flex;
  align-items: flex-end;
  gap: 0.5rem;
  max-width: 78%;
}
.msg-group.user .msg-row { flex-direction: row-reverse; }
.msg-group.ai .msg-row { }

.msg-avatar {
  width: 30px; height: 30px; border-radius: 10px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 0.9rem; flex-shrink: 0; overflow: hidden;
}
.msg-avatar img { width: 100%; height: 100%; object-fit: cover; }
.msg-avatar-spacer { width: 30px; flex-shrink: 0; }

.msg-bubble {
  padding: 0.65rem 0.95rem;
  border-radius: 18px;
  font-size: 0.9rem;
  line-height: 1.55;
  max-width: 100%;
  word-break: break-word;
  position: relative;
  animation: bubblePop 0.2s cubic-bezier(0.34,1.56,0.64,1);
}

@keyframes bubblePop {
  from { transform: scale(0.85); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.msg-group.ai .msg-bubble {
  background: var(--bubble-ai);
  color: var(--text-dark);
  border-radius: 4px 18px 18px 18px;
  box-shadow: 0 2px 8px var(--shadow);
  border: 1px solid rgba(201,184,232,0.15);
}

.msg-group.user .msg-bubble {
  background: var(--bubble-user);
  color: white;
  border-radius: 18px 18px 4px 18px;
  box-shadow: 0 2px 8px rgba(180,160,220,0.3);
}

/* only first bubble in group shows avatar */
.msg-group .msg-row:not(:first-child) .msg-avatar { visibility: hidden; }

.msg-time {
  font-size: 0.65rem;
  color: var(--text-light);
  padding: 0 0.3rem;
  margin-bottom: 0.15rem;
}

.msg-status { font-size: 0.65rem; color: var(--milk-blue); }

.date-divider {
  display: flex; align-items: center; gap: 0.8rem;
  margin: 1rem 0 0.5rem;
}
.date-divider::before, .date-divider::after {
  content: ''; flex: 1;
  height: 1px; background: rgba(201,184,232,0.3);
}
.date-divider span {
  font-size: 0.7rem; color: var(--text-light);
  background: rgba(201,184,232,0.15);
  padding: 0.2rem 0.7rem;
  border-radius: 10px;
}

/* IMAGE MESSAGES */
.msg-image {
  max-width: 220px; border-radius: 14px;
  overflow: hidden; cursor: pointer;
}
.msg-image img { width: 100%; display: block; }

/* STICKER / EMOTE */
.msg-sticker {
  font-size: 0.82rem;
  color: var(--text-mid);
  font-style: italic;
  padding: 0.4rem 0.8rem;
  background: rgba(201,184,232,0.15);
  border-radius: 12px;
  border: 1px solid rgba(201,184,232,0.25);
}

/* TYPING INDICATOR */
.typing-indicator {
  display: flex; gap: 5px; align-items: center;
  padding: 0.7rem 1rem;
}
.typing-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--lavender);
  animation: typingPulse 1.2s ease infinite;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingPulse {
  0%, 80%, 100% { transform: scale(0.7); opacity: 0.5; }
  40% { transform: scale(1); opacity: 1; }
}

/* ‚îÄ‚îÄ‚îÄ CHAT IMAGE UPLOAD ‚îÄ‚îÄ‚îÄ */
.chat-img-thumb {
  position: relative;
  width: 52px; height: 52px;
  border-radius: 10px;
  overflow: hidden;
  flex-shrink: 0;
  border: 1.5px solid rgba(201,184,232,0.4);
}
.chat-img-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
.chat-img-thumb .thumb-del {
  position: absolute; top: 2px; right: 2px;
  width: 18px; height: 18px;
  background: rgba(60,40,80,0.7);
  border: none; border-radius: 50%;
  color: white; font-size: 0.65rem;
  cursor: pointer; display: flex;
  align-items: center; justify-content: center;
  line-height: 1;
}


#input-area {
  padding: 0.8rem 1rem;
  background: var(--header-bg);
  backdrop-filter: blur(12px);
  border-top: 1px solid rgba(201,184,232,0.2);
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  flex-shrink: 0;
}

.input-toolbar {
  display: flex;
  gap: 0.3rem;
}
.toolbar-btn {
  width: 32px; height: 32px; border-radius: 9px;
  border: none; background: transparent; cursor: pointer;
  color: var(--text-light); font-size: 0.95rem;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.toolbar-btn:hover { background: var(--lavender-light); color: var(--text-dark); }
.toolbar-btn.active { background: var(--lavender); color: white; }

.input-row {
  display: flex; align-items: flex-end; gap: 0.7rem;
}

#msg-input {
  flex: 1;
  min-height: 42px; max-height: 120px;
  padding: 0.65rem 1rem;
  border: 1.5px solid rgba(201,184,232,0.3);
  border-radius: 20px;
  background: rgba(255,255,255,0.8);
  font-family: inherit;
  font-size: 0.9rem;
  color: var(--text-dark);
  outline: none;
  resize: none;
  line-height: 1.5;
  transition: border-color 0.2s, box-shadow 0.2s;
}
#msg-input:focus {
  border-color: var(--lavender);
  box-shadow: 0 0 0 3px rgba(201,184,232,0.15);
}
#msg-input::placeholder { color: var(--text-light); }

#send-btn {
  width: 42px; height: 42px;
  border-radius: 14px;
  border: none;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  color: white;
  font-size: 1rem;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: transform 0.15s, box-shadow 0.15s;
  flex-shrink: 0;
}
#send-btn:hover { transform: scale(1.08); box-shadow: 0 4px 12px rgba(180,160,220,0.4); }
#send-btn:active { transform: scale(0.95); }

/* ‚îÄ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ */
.page { display: none; flex: 1; flex-direction: column; overflow: hidden; }
.page.active { display: flex; }

/* ‚îÄ‚îÄ‚îÄ CHARACTERS PAGE ‚îÄ‚îÄ‚îÄ */
#chars-grid {
  flex: 1; overflow-y: auto;
  padding: 1.2rem;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 1rem;
  align-content: start;
}

.char-card {
  background: rgba(255,255,255,0.85);
  border-radius: 20px;
  padding: 1.2rem 0.9rem;
  text-align: center;
  cursor: pointer;
  box-shadow: 0 2px 12px var(--shadow);
  border: 1.5px solid rgba(201,184,232,0.15);
  transition: transform 0.2s, box-shadow 0.2s;
}
.char-card:hover { transform: translateY(-3px); box-shadow: 0 6px 24px var(--shadow); }

.char-card-avatar {
  width: 72px; height: 72px; border-radius: 22px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 2rem; margin: 0 auto 0.8rem;
  overflow: hidden;
}
.char-card-avatar img { width: 100%; height: 100%; object-fit: cover; }
.char-card-name { font-size: 0.88rem; font-weight: 500; color: var(--text-dark); }
.char-card-desc { font-size: 0.73rem; color: var(--text-light); margin-top: 0.2rem; }

.char-add-card {
  border: 2px dashed rgba(201,184,232,0.4);
  background: rgba(201,184,232,0.06);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 0.5rem;
  color: var(--text-light);
  font-size: 0.82rem;
  cursor: pointer;
  border-radius: 20px;
  min-height: 130px;
  transition: all 0.2s;
}
.char-add-card:hover { border-color: var(--lavender); color: var(--text-mid); background: rgba(201,184,232,0.1); }

/* ‚îÄ‚îÄ‚îÄ SOCIAL PAGE ‚îÄ‚îÄ‚îÄ */
#social-page { background: var(--beige-soft); }

.social-tabs {
  display: flex;
  padding: 0 1rem;
  gap: 0.5rem;
  border-bottom: 1px solid rgba(201,184,232,0.2);
  background: var(--header-bg);
  flex-shrink: 0;
}
.social-tab {
  padding: 0.9rem 1.2rem;
  border: none; background: none;
  font-family: inherit; font-size: 0.88rem;
  color: var(--text-light); cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}
.social-tab.active { color: var(--lavender); border-bottom-color: var(--lavender); font-weight: 500; }

.social-feed { flex: 1; overflow-y: auto; padding: 1rem; }

.post-card {
  background: rgba(255,255,255,0.88);
  border-radius: 20px;
  padding: 1.2rem;
  margin-bottom: 1rem;
  box-shadow: 0 2px 10px var(--shadow);
  border: 1px solid rgba(201,184,232,0.12);
}
.post-header { display: flex; align-items: center; gap: 0.7rem; margin-bottom: 0.8rem; }
.post-avatar {
  width: 38px; height: 38px; border-radius: 12px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 1.1rem; overflow: hidden;
}
.post-avatar img { width: 100%; height: 100%; object-fit: cover; }
.post-author { font-size: 0.88rem; font-weight: 500; color: var(--text-dark); }
.post-time { font-size: 0.72rem; color: var(--text-light); }
.post-content { font-size: 0.88rem; color: var(--text-dark); line-height: 1.6; }
.post-image { margin-top: 0.8rem; border-radius: 14px; overflow: hidden; }
.post-image img { width: 100%; display: block; }
.post-actions {
  display: flex; gap: 1rem; margin-top: 0.8rem;
  padding-top: 0.8rem;
  border-top: 1px solid rgba(201,184,232,0.15);
}
.post-action-btn {
  background: none; border: none; cursor: pointer;
  font-size: 0.8rem; color: var(--text-light); font-family: inherit;
  display: flex; align-items: center; gap: 0.3rem;
  transition: color 0.15s;
}
.post-action-btn:hover { color: var(--lavender); }

.post-comments { margin-top: 0.7rem; display: flex; flex-direction: column; gap: 0.5rem; }
.comment-item {
  display: flex; gap: 0.6rem; align-items: flex-start;
}
.comment-avatar {
  width: 28px; height: 28px; border-radius: 9px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 0.8rem; flex-shrink: 0;
}
.comment-bubble {
  background: var(--lavender-soft);
  border-radius: 4px 14px 14px 14px;
  padding: 0.5rem 0.8rem;
  font-size: 0.82rem; color: var(--text-dark);
  line-height: 1.5;
}
.comment-name { font-weight: 500; font-size: 0.75rem; color: var(--lavender); margin-bottom: 0.1rem; }

.post-compose {
  background: rgba(255,255,255,0.88);
  border-radius: 20px;
  padding: 1rem;
  margin-bottom: 1rem;
  box-shadow: 0 2px 10px var(--shadow);
  border: 1px solid rgba(201,184,232,0.12);
}
.compose-input {
  width: 100%; min-height: 70px;
  border: none; outline: none; resize: none;
  font-family: inherit; font-size: 0.88rem;
  color: var(--text-dark); background: transparent;
  line-height: 1.6;
}
.compose-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 0.6rem; }
.compose-char-select {
  padding: 0.4rem 0.7rem;
  border: 1px solid var(--lavender-light);
  border-radius: 10px;
  font-family: inherit; font-size: 0.78rem;
  color: var(--text-mid);
  background: var(--lavender-soft);
  outline: none;
}
.compose-post-btn {
  padding: 0.45rem 1.1rem;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  border: none; border-radius: 12px;
  color: white; font-family: inherit;
  font-size: 0.82rem; cursor: pointer;
}

/* PLURK style */
.plurk-timeline {
  position: relative;
  padding-left: 1.5rem;
}
.plurk-timeline::before {
  content: '';
  position: absolute; left: 0.4rem; top: 0; bottom: 0;
  width: 2px; background: linear-gradient(to bottom, var(--lavender-light), transparent);
  border-radius: 1px;
}
.plurk-item {
  position: relative;
  margin-bottom: 1rem;
}
.plurk-dot {
  position: absolute; left: -1.15rem; top: 0.8rem;
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--lavender);
  border: 2px solid white;
  box-shadow: 0 0 0 2px rgba(201,184,232,0.3);
}

/* ‚îÄ‚îÄ‚îÄ DIARY PAGE ‚îÄ‚îÄ‚îÄ */
#diary-page { background: var(--beige-soft); }

.diary-header {
  padding: 1rem 1.2rem;
  background: var(--header-bg);
  border-bottom: 1px solid rgba(201,184,232,0.2);
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0;
}
.diary-month {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.3rem; font-weight: 300;
  color: var(--text-dark); font-style: italic;
}
.diary-nav-btn {
  width: 32px; height: 32px; border-radius: 10px;
  border: none; background: transparent; cursor: pointer;
  color: var(--text-light); font-size: 1rem;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.diary-nav-btn:hover { background: var(--lavender-light); color: var(--text-dark); }

.diary-calendar {
  display: grid; grid-template-columns: repeat(7, 1fr);
  padding: 0.8rem 1rem;
  gap: 0.3rem;
  border-bottom: 1px solid rgba(201,184,232,0.15);
  flex-shrink: 0;
}
.cal-day-name {
  text-align: center; font-size: 0.7rem;
  color: var(--text-light); padding: 0.2rem;
}
.cal-day {
  text-align: center; padding: 0.4rem;
  border-radius: 10px; font-size: 0.82rem;
  color: var(--text-mid); cursor: pointer;
  transition: all 0.15s; position: relative;
}
.cal-day:hover { background: var(--lavender-light); }
.cal-day.today { background: var(--lavender); color: white; font-weight: 500; }
.cal-day.has-entry::after {
  content: ''; position: absolute;
  bottom: 3px; left: 50%; transform: translateX(-50%);
  width: 4px; height: 4px; border-radius: 50%;
  background: var(--milk-blue);
}
.cal-day.selected { background: var(--lavender-soft); border: 1.5px solid var(--lavender); }

.diary-content { flex: 1; overflow-y: auto; padding: 1.2rem; }
.diary-entry {
  background: rgba(255,255,255,0.88);
  border-radius: 20px;
  padding: 1.5rem;
  box-shadow: 0 2px 12px var(--shadow);
  border: 1px solid rgba(201,184,232,0.15);
}
.diary-entry-date {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.1rem; font-style: italic;
  color: var(--text-mid);
}
.diary-entry-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 0.8rem;
}
.diary-regen-btn {
  padding: 0.3rem 0.75rem;
  background: var(--lavender-soft);
  border: 1.5px solid var(--lavender-light);
  border-radius: 20px;
  font-family: inherit; font-size: 0.72rem;
  color: var(--text-mid); cursor: pointer;
  transition: all 0.15s; white-space: nowrap;
}
.diary-regen-btn:hover {
  background: var(--lavender-light);
  color: var(--text-dark);
  border-color: var(--lavender);
}
.diary-entry-char {
  display: flex; align-items: center; gap: 0.6rem;
  margin-bottom: 1rem; padding-bottom: 0.8rem;
  border-bottom: 1px solid rgba(201,184,232,0.15);
}
.diary-char-avatar {
  width: 32px; height: 32px; border-radius: 10px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 0.9rem; overflow: hidden;
}
.diary-char-avatar img { width: 100%; height: 100%; object-fit: cover; }
.diary-char-name { font-size: 0.82rem; font-weight: 500; color: var(--lavender); }
.diary-entry-text {
  font-size: 0.88rem; color: var(--text-dark);
  line-height: 1.8; white-space: pre-wrap;
}
.diary-empty {
  text-align: center; color: var(--text-light);
  font-size: 0.88rem; padding: 3rem 1rem;
  font-style: italic;
}

/* Diary style picker buttons */
.diary-style-btn {
  padding: 0.35rem 0.8rem;
  border-radius: 20px;
  border: 1.5px solid var(--lavender-light);
  background: var(--lavender-soft);
  font-family: inherit;
  font-size: 0.75rem;
  color: var(--text-mid);
  cursor: pointer;
  transition: all 0.15s;
}
.diary-style-btn:hover { border-color: var(--lavender); color: var(--text-dark); }
.diary-style-btn.active {
  background: var(--lavender);
  border-color: var(--lavender);
  color: white;
  font-weight: 500;
}

/* ‚îÄ‚îÄ‚îÄ LOREBOOK (SillyTavern Style) ‚îÄ‚îÄ‚îÄ */
.lb-entry {
  border: 1.5px solid rgba(201,184,232,0.22);
  border-radius: 14px;
  overflow: hidden;
  background: white;
  transition: box-shadow 0.2s, border-color 0.2s;
}
.lb-entry:hover { box-shadow: 0 2px 12px rgba(180,160,210,0.13); }
.lb-entry.lb-open {
  border-color: var(--lavender);
  box-shadow: 0 4px 20px rgba(180,160,210,0.18);
}

.lb-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.6rem 0.85rem;
  cursor: pointer;
  background: var(--lavender-soft);
  user-select: none;
  gap: 0.5rem;
  transition: background 0.15s;
}
.lb-entry.lb-open .lb-header { background: rgba(201,184,232,0.2); border-bottom: 1px solid rgba(201,184,232,0.2); }
.lb-header:hover { background: rgba(201,184,232,0.18); }

.lb-entry-left { display: flex; align-items: center; gap: 0.5rem; min-width: 0; flex: 1; }
.lb-entry-right { display: flex; align-items: center; gap: 0.45rem; flex-shrink: 0; }

/* Enable toggle (nice visual switch) */
.lb-toggle {
  width: 28px; height: 16px;
  border-radius: 8px;
  border: none;
  background: var(--lavender-light);
  position: relative;
  cursor: pointer;
  flex-shrink: 0;
  transition: background 0.2s;
  padding: 0;
}
.lb-toggle.on { background: var(--lavender); }
.lb-toggle::after {
  content: '';
  position: absolute; top: 2px; left: 2px;
  width: 12px; height: 12px;
  border-radius: 50%; background: white;
  transition: transform 0.2s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.lb-toggle.on::after { transform: translateX(12px); }

.lb-badge { font-size: 0.63rem; padding: 0.12rem 0.4rem; border-radius: 6px; font-weight: 700; letter-spacing: 0.03em; }
.lb-const { background: rgba(168,216,168,0.35); color: #3d7a3d; }
.lb-sel   { background: rgba(184,212,232,0.45); color: #3d6080; }

.lb-name { font-size: 0.84rem; color: var(--text-dark); font-weight: 600;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
.lb-keys-preview { font-size: 0.7rem; color: var(--text-light); max-width: 120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.lb-order { font-size: 0.65rem; color: var(--lavender); font-family: monospace;
  background: rgba(201,184,232,0.25); padding: 0.1rem 0.4rem; border-radius: 5px; }
.lb-del-btn { background: none; border: none; cursor: pointer; color: rgba(200,136,136,0.7);
  font-size: 1rem; line-height: 1; padding: 0.1rem 0.2rem; border-radius: 6px; transition: all 0.15s; }
.lb-del-btn:hover { color: #e87878; background: rgba(232,120,120,0.08); }

.lb-body {
  padding: 1rem 1.1rem 0.9rem;
  border-top: none;
  display: flex; flex-direction: column; gap: 0.75rem;
  background: linear-gradient(to bottom, rgba(243,239,249,0.3), white);
}

.lb-row-2col { display: flex; gap: 0.65rem; }
.lb-row-flags { display: flex; gap: 0.6rem; flex-wrap: wrap; align-items: flex-end; }
.lb-field { display: flex; flex-direction: column; gap: 0.28rem; flex: 1; }
.lb-label {
  font-size: 0.69rem; color: var(--text-light); font-weight: 600;
  letter-spacing: 0.06em; text-transform: uppercase;
}
.lb-input {
  padding: 0.5rem 0.75rem;
  border: 1.5px solid var(--lavender-light);
  border-radius: 10px;
  font-family: inherit; font-size: 0.83rem;
  color: var(--text-dark); background: var(--lavender-soft);
  outline: none; width: 100%;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.lb-input:focus { border-color: var(--lavender); box-shadow: 0 0 0 3px rgba(201,184,232,0.15); }
.lb-select {
  padding: 0.5rem 0.75rem;
  border: 1.5px solid var(--lavender-light);
  border-radius: 10px;
  font-family: inherit; font-size: 0.83rem;
  color: var(--text-dark); background: var(--lavender-soft);
  outline: none; width: 100%;
  transition: border-color 0.15s;
}
.lb-select:focus { border-color: var(--lavender); }
.lb-textarea {
  padding: 0.6rem 0.85rem;
  border: 1.5px solid var(--lavender-light);
  border-radius: 10px;
  font-family: inherit; font-size: 0.83rem;
  color: var(--text-dark); background: var(--lavender-soft);
  outline: none; resize: vertical; min-height: 100px; line-height: 1.6; width: 100%;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.lb-textarea:focus { border-color: var(--lavender); box-shadow: 0 0 0 3px rgba(201,184,232,0.15); }

/* Flags section */
.lb-flags-group {
  display: flex; flex-wrap: wrap; gap: 0.5rem;
  padding: 0.65rem 0.8rem;
  background: rgba(201,184,232,0.07);
  border-radius: 10px;
  border: 1px solid rgba(201,184,232,0.15);
}
.lb-checkbox-label {
  display: flex; align-items: center; gap: 0.4rem;
  font-size: 0.76rem; color: var(--text-mid); cursor: pointer; white-space: nowrap;
  padding: 0.2rem 0.5rem;
  border-radius: 8px;
  transition: background 0.15s;
}
.lb-checkbox-label:hover { background: rgba(201,184,232,0.2); }
.lb-checkbox-label input { accent-color: var(--lavender); cursor: pointer; }

.lb-save-btn {
  flex: 1; padding: 0.6rem; background: linear-gradient(135deg,var(--lavender),var(--milk-blue));
  border: none; border-radius: 11px; color: white;
  font-family: inherit; font-size: 0.85rem; cursor: pointer; font-weight: 500;
  transition: opacity 0.15s, transform 0.15s;
}
.lb-save-btn:hover { opacity: 0.9; transform: translateY(-1px); }
.lb-cancel-btn {
  padding: 0.6rem 1rem;
  background: var(--lavender-soft); border: 1.5px solid var(--lavender-light);
  border-radius: 11px; color: var(--text-mid);
  font-family: inherit; font-size: 0.85rem; cursor: pointer;
  transition: background 0.15s;
}
.lb-cancel-btn:hover { background: rgba(201,184,232,0.2); }

/* ST info bar inside lorebook */
.lb-st-info {
  display: flex; gap: 0.5rem; align-items: center;
  padding: 0.5rem 0.7rem;
  background: rgba(201,184,232,0.1);
  border-radius: 8px;
  font-size: 0.7rem; color: var(--text-light);
  border: 1px dashed rgba(201,184,232,0.3);
}

/* Lorebook modal count badge */
#lb-count {
  background: rgba(201,184,232,0.2);
  border-radius: 20px;
  padding: 0.15rem 0.6rem;
  font-size: 0.72rem;
  color: var(--lavender);
  font-weight: 500;
}

/* ‚îÄ‚îÄ‚îÄ SETTINGS PAGE ‚îÄ‚îÄ‚îÄ */
#settings-page { background: var(--beige-soft); overflow-y: auto; }

.settings-section {
  padding: 1.2rem;
  border-bottom: 1px solid rgba(201,184,232,0.12);
}
.settings-section-title {
  font-size: 0.72rem; color: var(--text-light);
  letter-spacing: 0.12em; text-transform: uppercase;
  margin-bottom: 0.8rem;
}
.settings-item {
  background: rgba(255,255,255,0.85);
  border-radius: 14px;
  padding: 0.9rem 1rem;
  margin-bottom: 0.5rem;
  display: flex; align-items: center; gap: 0.8rem;
  cursor: pointer;
  border: 1px solid rgba(201,184,232,0.1);
  transition: background 0.15s;
}
.settings-item:hover { background: rgba(255,255,255,0.95); }
.settings-item-icon { width: 32px; height: 32px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
.settings-item-label { flex: 1; font-size: 0.88rem; color: var(--text-dark); }
.settings-item-value { font-size: 0.78rem; color: var(--text-light); }
.settings-item-arrow { color: var(--text-light); font-size: 0.8rem; }

.toggle-switch {
  width: 42px; height: 24px;
  background: var(--lavender-light);
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: background 0.2s;
}
.toggle-switch.on { background: var(--lavender); }
.toggle-switch::after {
  content: '';
  position: absolute; top: 3px; left: 3px;
  width: 18px; height: 18px;
  border-radius: 50%; background: white;
  transition: transform 0.2s;
  box-shadow: 0 1px 4px rgba(0,0,0,0.15);
}
.toggle-switch.on::after { transform: translateX(18px); }

/* ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(61,52,80,0.4);
  backdrop-filter: blur(8px);
  z-index: 800;
  display: none; align-items: center; justify-content: center;
  padding: 1rem;
}
.modal-overlay.open { display: flex; }

.modal {
  background: white;
  border-radius: 24px;
  padding: 1.8rem;
  width: min(480px, 96vw);
  max-height: 90dvh;
  overflow-y: auto;
  box-shadow: 0 12px 48px var(--shadow-deep);
  animation: modalIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes modalIn {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
.modal-title { font-size: 1.1rem; font-weight: 700; color: var(--text-dark); margin-bottom: 1.2rem; }
.modal-field { margin-bottom: 1rem; }
.modal-label { display: block; font-size: 0.78rem; color: var(--text-mid); margin-bottom: 0.4rem; }
.modal-input, .modal-select, .modal-textarea {
  width: 100%; padding: 0.75rem 1rem;
  border: 1.5px solid var(--lavender-light);
  border-radius: 12px;
  font-family: inherit; font-size: 0.88rem;
  color: var(--text-dark);
  background: var(--lavender-soft);
  outline: none;
}
.modal-textarea { min-height: 90px; resize: vertical; }
.modal-actions { display: flex; gap: 0.5rem; margin-top: 1.2rem; }
.modal-btn {
  flex: 1; padding: 0.8rem;
  border-radius: 14px; border: none;
  font-family: inherit; font-size: 0.88rem;
  cursor: pointer; transition: all 0.15s;
}
.modal-btn.primary {
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  color: white;
}
.modal-btn.secondary {
  background: var(--lavender-soft);
  color: var(--text-mid);
  border: 1px solid var(--lavender-light);
}
.modal-btn:hover { opacity: 0.9; }

/* TABS inside modal */
.modal-tabs { display: flex; gap: 0.3rem; margin-bottom: 1rem; }
.modal-tab {
  flex: 1; padding: 0.5rem;
  border-radius: 10px; border: none;
  font-family: inherit; font-size: 0.78rem;
  cursor: pointer; transition: all 0.15s;
  background: var(--lavender-soft);
  color: var(--text-light);
}
.modal-tab.active {
  background: var(--lavender);
  color: white;
}
.modal-tab-content { display: none; }
.modal-tab-content.active { display: block; }

/* ‚îÄ‚îÄ‚îÄ MEMORY PANEL ‚îÄ‚îÄ‚îÄ */
#memory-panel {
  width: 260px;
  background: rgba(243,239,249,0.95);
  border-left: 1px solid rgba(201,184,232,0.2);
  display: none;
  flex-direction: column;
  flex-shrink: 0;
}
#memory-panel.open { display: flex; }

.memory-header {
  padding: 1rem 1rem 0.8rem;
  border-bottom: 1px solid rgba(201,184,232,0.15);
}
.memory-title { font-size: 0.88rem; font-weight: 500; color: var(--text-dark); }
.memory-list { flex: 1; overflow-y: auto; padding: 0.8rem; }
.memory-category {
  margin-bottom: 1rem;
}
.memory-cat-title {
  font-size: 0.68rem; color: var(--text-light);
  letter-spacing: 0.1em; text-transform: uppercase;
  margin-bottom: 0.4rem;
}
.memory-item {
  background: rgba(255,255,255,0.8);
  border-radius: 10px;
  padding: 0.5rem 0.7rem;
  margin-bottom: 0.35rem;
  font-size: 0.78rem;
  color: var(--text-dark);
  line-height: 1.4;
  border: 1px solid rgba(201,184,232,0.1);
  position: relative;
}
.memory-item .del-mem {
  position: absolute; right: 0.4rem; top: 0.3rem;
  font-size: 0.65rem; color: var(--text-light);
  cursor: pointer;
}
.memory-item .del-mem:hover { color: #e8a0b8; }

.memory-add-btn {
  margin: 0 0.8rem 0.8rem;
  padding: 0.5rem;
  background: rgba(201,184,232,0.15);
  border: 1.5px dashed rgba(201,184,232,0.35);
  border-radius: 10px;
  font-family: inherit; font-size: 0.78rem;
  color: var(--text-light); cursor: pointer;
  transition: all 0.2s;
}
.memory-add-btn:hover { background: rgba(201,184,232,0.25); color: var(--text-mid); }

/* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
.empty-state {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 1rem; color: var(--text-light);
  padding: 2rem;
}
.empty-state-icon { font-size: 3rem; opacity: 0.4; }
.empty-state-text { font-size: 0.88rem; text-align: center; line-height: 1.6; }
.empty-state-sub { font-size: 0.78rem; opacity: 0.7; }

/* ‚îÄ‚îÄ‚îÄ CONTEXT MENU ‚îÄ‚îÄ‚îÄ */
.ctx-menu {
  position: fixed;
  background: white;
  border-radius: 14px;
  box-shadow: 0 8px 32px var(--shadow), 0 2px 8px var(--shadow-deep);
  border: 1px solid rgba(201,184,232,0.2);
  z-index: 900;
  overflow: hidden;
  min-width: 160px;
  animation: ctxIn 0.15s ease;
  display: none;
}
.ctx-menu.open { display: block; }
@keyframes ctxIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.ctx-item {
  padding: 0.65rem 1rem;
  font-size: 0.85rem; color: var(--text-dark);
  cursor: pointer; transition: background 0.1s;
  display: flex; align-items: center; gap: 0.5rem;
}
.ctx-item:hover { background: var(--lavender-soft); }
.ctx-item.danger { color: #e87878; }
.ctx-divider { height: 1px; background: rgba(201,184,232,0.2); margin: 0.2rem 0; }

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
.toast {
  position: fixed;
  bottom: calc(env(safe-area-inset-bottom) + 80px);
  left: 50%; transform: translateX(-50%) translateY(20px);
  background: rgba(61,52,80,0.9);
  color: white; font-size: 0.82rem;
  padding: 0.6rem 1.2rem; border-radius: 20px;
  opacity: 0; transition: all 0.3s;
  z-index: 1000; white-space: nowrap;
  pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ‚îÄ‚îÄ‚îÄ BOTTOM NAV (Mobile) ‚îÄ‚îÄ‚îÄ */
#bottom-nav {
  display: none;
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--header-bg);
  backdrop-filter: blur(12px);
  border-top: 1px solid rgba(201,184,232,0.2);
  padding: 0.5rem 0 calc(0.5rem + env(safe-area-inset-bottom));
  z-index: 200;
  justify-content: space-around;
}
.bottom-nav-btn {
  display: flex; flex-direction: column; align-items: center; gap: 0.2rem;
  background: none; border: none; cursor: pointer;
  padding: 0.3rem 0.6rem;
  color: var(--text-light); font-size: 0.62rem;
  transition: color 0.15s;
}
.bottom-nav-btn .icon { font-size: 1.3rem; }
.bottom-nav-btn.active { color: var(--lavender); }

/* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
@media (max-width: 768px) {
  #side-nav { display: none; }
  #sidebar {
    position: fixed; inset: 0 0 60px 0;
    width: 100%; z-index: 150;
    transform: translateX(-100%);
    transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
  }
  #sidebar.mobile-open { transform: translateX(0); }
  #bottom-nav { display: flex; }
  #main-area { padding-bottom: 60px; }
  #memory-panel { position: fixed; inset: 0; z-index: 300; width: 100%; }
  .page { padding-bottom: 0; }
}

@media (min-width: 769px) {
  #app { }
}

/* Scrollbar global */
* { scrollbar-width: thin; scrollbar-color: rgba(201,184,232,0.3) transparent; }

/* ‚îÄ‚îÄ‚îÄ THEATER PAGE ‚îÄ‚îÄ‚îÄ */
#theater-page { background: var(--beige-soft); }

/* ‚îÄ‚îÄ‚îÄ ACHIEVEMENTS ‚îÄ‚îÄ‚îÄ */
#achievements-page { background: var(--beige-soft); }
.achievement-stat-card {
  background: rgba(255,255,255,0.88);
  border-radius: 16px;
  padding: 0.8rem;
  text-align: center;
  box-shadow: 0 2px 8px var(--shadow);
  border: 1px solid rgba(201,184,232,0.12);
}
.achievement-stat-num {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.8rem; font-weight: 300;
  color: var(--lavender);
}
.achievement-stat-label {
  font-size: 0.65rem; color: var(--text-light);
  letter-spacing: 0.06em; margin-top: 0.2rem;
}
.achievement-item {
  background: rgba(255,255,255,0.88);
  border-radius: 16px;
  padding: 1rem;
  display: flex; align-items: center; gap: 0.9rem;
  box-shadow: 0 2px 8px var(--shadow);
  border: 1px solid rgba(201,184,232,0.12);
  transition: all 0.2s;
  position: relative; overflow: hidden;
}
.achievement-item.locked {
  opacity: 0.5; filter: grayscale(0.6);
}
.achievement-item.unlocked {
  border-color: rgba(201,184,232,0.4);
  box-shadow: 0 4px 16px rgba(180,160,210,0.2);
}
.achievement-item.unlocked::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--lavender), var(--milk-blue));
}
.achievement-icon {
  width: 48px; height: 48px; border-radius: 14px;
  background: linear-gradient(135deg, var(--lavender-soft), var(--milk-blue-soft));
  display: flex; align-items: center; justify-content: center;
  font-size: 1.5rem; flex-shrink: 0;
  border: 1.5px solid rgba(201,184,232,0.2);
}
.achievement-item.unlocked .achievement-icon {
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  border-color: transparent;
}
.achievement-info { flex: 1; }
.achievement-name {
  font-size: 0.88rem; font-weight: 600; color: var(--text-dark);
  margin-bottom: 0.2rem;
}
.achievement-desc { font-size: 0.75rem; color: var(--text-light); line-height: 1.4; }
.achievement-progress {
  margin-top: 0.4rem;
  height: 4px; background: rgba(201,184,232,0.2);
  border-radius: 2px; overflow: hidden;
}
.achievement-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--lavender), var(--milk-blue));
  border-radius: 2px;
  transition: width 0.6s ease;
}
.achievement-badge {
  font-size: 0.65rem; font-weight: 700;
  padding: 0.2rem 0.5rem; border-radius: 8px;
  background: var(--lavender); color: white;
  white-space: nowrap; flex-shrink: 0;
}
.achievement-item.locked .achievement-badge {
  background: var(--lavender-light); color: var(--text-light);
}

/* ‚îÄ‚îÄ‚îÄ ANNIVERSARY ITEM ‚îÄ‚îÄ‚îÄ */
.anniversary-item {
  background: rgba(255,255,255,0.85);
  border-radius: 14px;
  padding: 0.8rem 1rem;
  display: flex; align-items: center; gap: 0.8rem;
  border: 1px solid rgba(201,184,232,0.15);
  margin-bottom: 0.4rem;
}
.anniversary-icon {
  font-size: 1.3rem; flex-shrink: 0;
}
.anniversary-info { flex: 1; }
.anniversary-name { font-size: 0.85rem; font-weight: 500; color: var(--text-dark); }
.anniversary-days {
  font-size: 0.72rem; color: var(--lavender);
  margin-top: 0.1rem;
}
.anniversary-del {
  background: none; border: none; cursor: pointer;
  color: var(--text-light); font-size: 0.9rem;
  padding: 0.2rem; border-radius: 6px;
  transition: color 0.15s;
}
.anniversary-del:hover { color: #e87878; }

/* ‚îÄ‚îÄ‚îÄ INLINE MESSAGE EDIT ‚îÄ‚îÄ‚îÄ */
.msg-edit-area {
  width: 100%;
  padding: 0.5rem 0.8rem;
  border: 1.5px solid var(--lavender);
  border-radius: 14px;
  font-family: inherit; font-size: 0.88rem;
  color: var(--text-dark);
  background: rgba(255,255,255,0.9);
  outline: none; resize: none;
  min-height: 40px; max-height: 120px;
  line-height: 1.5;
}
.msg-edit-actions {
  display: flex; gap: 0.4rem; margin-top: 0.3rem; justify-content: flex-end;
}
.msg-edit-btn {
  padding: 0.3rem 0.8rem;
  border-radius: 10px; border: none;
  font-family: inherit; font-size: 0.78rem;
  cursor: pointer; transition: all 0.15s;
}
.msg-edit-btn.confirm {
  background: var(--lavender); color: white;
}
.msg-edit-btn.cancel {
  background: var(--lavender-soft); color: var(--text-mid);
  border: 1px solid var(--lavender-light);
}

/* ‚îÄ‚îÄ Message Hover Actions ‚îÄ‚îÄ */
.msg-row {
  position: relative;
}
.msg-actions {
  position: absolute;
  top: 50%; transform: translateY(-50%);
  display: flex; gap: 0.2rem; align-items: center;
  opacity: 0; pointer-events: none;
  transition: opacity 0.15s;
  z-index: 10;
  background: rgba(255,255,255,0.95);
  border: 1px solid rgba(201,184,232,0.3);
  border-radius: 12px; padding: 0.25rem 0.3rem;
  box-shadow: 0 2px 10px rgba(180,160,210,0.15);
  backdrop-filter: blur(8px);
}
.msg-actions-left  { right: calc(100% + 6px); }
.msg-actions-right { left: calc(100% + 6px); }
@media (hover: hover) {
  .msg-row:hover .msg-actions { opacity: 1; pointer-events: auto; }
}
/* Mobile: shown via JS after long press */
.msg-actions.mobile-show { opacity: 1; pointer-events: auto; }
.msg-action-btn {
  background: none; border: none; cursor: pointer;
  font-size: 0.82rem; padding: 0.2rem 0.3rem;
  border-radius: 7px; line-height: 1;
  transition: background 0.12s;
  color: var(--text-mid);
}
.msg-action-btn:hover { background: var(--lavender-soft); }
.msg-action-btn.danger:hover { background: #fff0f0; }

/* ‚îÄ‚îÄ Persona UI ‚îÄ‚îÄ */
.persona-card {
  display: flex; align-items: center; gap: 0.9rem;
  background: rgba(255,255,255,0.88);
  border: 1.5px solid rgba(201,184,232,0.2);
  border-radius: 16px; padding: 0.9rem;
  transition: border-color 0.15s;
}
.persona-card:hover { border-color: rgba(201,184,232,0.5); }
.persona-card.active-persona { border-color: var(--lavender); background: var(--lavender-soft); }
.persona-avatar {
  width: 52px; height: 52px; border-radius: 16px;
  background: linear-gradient(135deg,var(--lavender),var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 1.6rem; overflow: hidden; flex-shrink: 0;
}
.persona-avatar img { width: 100%; height: 100%; object-fit: cover; }
.persona-tag {
  font-size: 0.67rem; background: rgba(201,184,232,0.25);
  color: var(--lavender); padding: 0.12rem 0.45rem;
  border-radius: 8px; white-space: nowrap;
}

/* ‚îÄ‚îÄ Lorebook Tabs ‚îÄ‚îÄ */
.lb-scope-badge {
  display: inline-flex; align-items: center; gap: 0.3rem;
  font-size: 0.68rem; padding: 0.2rem 0.6rem;
  border-radius: 8px; font-weight: 500;
}
.lb-scope-badge.global { background: rgba(100,180,100,0.12); color: #4a9a4a; }
.lb-scope-badge.char   { background: rgba(201,184,232,0.25); color: var(--lavender); }
.lb-scope-badge.chat   { background: rgba(100,150,220,0.12); color: #4470bb; }
</style>
</head>
<body>

<!-- SETUP SCREEN -->
<div id="setup-screen">
  <div class="setup-card">
    <div class="setup-logo">erhabene</div>
    <div class="setup-tagline">your intimate ai companion</div>
    
    <div class="setup-field">
      <label class="setup-label">üîë Google AI API Key</label>
      <input class="setup-input" type="password" id="api-key-input" placeholder="AIza..." autocomplete="off">
    </div>
    
    <div class="setup-field">
      <label class="setup-label">ü§ñ Ê®°ÂûãÂêçÁ®±ÔºàÂèØËá™Ë°åËº∏ÂÖ•Ôºâ</label>
      <input class="setup-input" type="text" id="model-custom-input-setup"
        placeholder="‰æãÔºögemini-3-flash-preview"
        list="model-datalist-setup"
        value="gemini-3-flash-preview">
      <datalist id="model-datalist-setup">
        <option value="gemini-3-flash-preview">Gemini 3 Flash PreviewÔºàÊúÄÊñ∞Ôºâ</option>
        <option value="gemini-3-pro-preview">Gemini 3 Pro PreviewÔºàÊúÄÊñ∞Ôºâ</option>
        <option value="gemini-3-flash-exp">Gemini 3 Flash Exp</option>
        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
      </datalist>
      <div style="font-size:0.72rem;color:var(--text-light);margin-top:0.4rem;">Áõ¥Êé•Ëº∏ÂÖ• API Ê®°Âûã IDÔºåÊàñÂæû‰∏ãÊãâÊ∏ÖÂñÆÈÅ∏Êìá</div>
    </div>
    <!-- hidden select for backward compat -->
    <select id="model-select" style="display:none">
      <option value="gemini-3-flash-preview">Gemini 3 Flash Preview</option>
    </select>
    
    <button class="setup-btn" onclick="enterApp()">ÈÄ≤ÂÖ• erhabene ‚ú¶</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none;">
  
  <!-- Side Nav -->
  <nav id="side-nav">
    <div class="nav-logo">e</div>
    <button class="nav-btn active" onclick="switchPage('chat')" title="ËÅäÂ§©" id="nav-chat">üí¨</button>
    <button class="nav-btn" onclick="switchPage('chars')" title="ËßíËâ≤" id="nav-chars">üå∏</button>
    <button class="nav-btn" onclick="switchPage('social')" title="Á§æÁæ§" id="nav-social">‚ú¶</button>
    <button class="nav-btn" onclick="switchPage('diary')" title="Êó•Ë®ò" id="nav-diary">üìî</button>
    <button class="nav-btn" onclick="switchPage('theater')" title="Â∞èÂäáÂ†¥" id="nav-theater">üé≠</button>
    <button class="nav-btn" onclick="switchPage('achievements')" title="ÊàêÂ∞±" id="nav-achievements">üèÜ</button>
    <div class="nav-spacer"></div>
    <button class="nav-btn" onclick="openModal('memory-modal')" title="Èï∑ÊúüË®òÊÜ∂">üß†</button>
    <button class="nav-btn" onclick="openModal('lorebook-modal')" title="Lorebook">üìö</button>
    <button class="nav-btn" onclick="switchPage('settings')" title="Ë®≠ÂÆö" id="nav-settings">‚öôÔ∏è</button>
  </nav>

  <!-- Sidebar -->
  <aside id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title" id="sidebar-title">ËÅäÂ§©</div>
      <div class="sidebar-search">
        <span>üîç</span>
        <input placeholder="ÊêúÂ∞ã..." id="sidebar-search-input">
      </div>
    </div>
    <div class="sidebar-list" id="sidebar-list"></div>
    <button class="add-chat-btn" id="sidebar-add-btn" onclick="showAddChatOrChar()">Ôºã Êñ∞Â¢ûÂ∞çË©±</button>
  </aside>

  <!-- Main Area -->
  <div id="main-area">
    
    <!-- CHAT PAGE -->
    <div class="page active" id="chat-page">
      <div id="chat-header" style="display:none;">
        <div class="header-avatar" id="header-avatar">üå∏</div>
        <div class="header-info">
          <div class="header-name" id="header-name">ÈÅ∏ÊìáËßíËâ≤</div>
          <div class="header-status" id="header-status">‚Äî ÈªûÊìäËßíËâ≤ÈñãÂßãËÅäÂ§© ‚Äî</div>
        </div>
        <div class="header-actions">
          <button class="header-btn" onclick="toggleMemoryPanel()" title="Ë®òÊÜ∂">üß†</button>
          <button class="header-btn" onclick="openModal('char-info-modal')" title="ËßíËâ≤Ë≥áË®ä">üë§</button>
          <button class="header-btn" onclick="openChatOptions()" title="Êõ¥Â§ö">‚ãØ</button>
        </div>
      </div>
      
      <div id="messages-area">
        <div class="empty-state" id="empty-chat">
          <div class="empty-state-icon">üå∏</div>
          <div class="empty-state-text">erhabene</div>
          <div class="empty-state-sub">ÈÅ∏Êìá‰∏ÄÂÄãËßíËâ≤ÈñãÂßãÂ∞çË©±Ôºå<br>ÊàñÊñ∞Â¢û‰Ω†ÁöÑÁ¨¨‰∏ÄÂÄãËßíËâ≤Âç°</div>
        </div>
      </div>
      
      <div id="input-area" style="display:none;">
        <div class="input-toolbar">
          <button class="toolbar-btn" onclick="triggerImageGen()" title="ÁîüÊàêÂúñÁâá">üñºÔ∏è</button>
          <button class="toolbar-btn" onclick="document.getElementById('chat-img-upload').click()" title="‰∏äÂÇ≥ÂúñÁâá">üì∑</button>
          <input type="file" id="chat-img-upload" accept="image/*" style="display:none" onchange="handleChatImageUpload(event)">
          <button class="toolbar-btn" onclick="openStickerPicker()" title="(Ë°®ÊÉÖ)">üé≠</button>
          <button class="toolbar-btn" onclick="openModal('preset-modal')" title="Preset">üìã</button>
          <button class="toolbar-btn" id="memory-toggle-btn" onclick="toggleMemoryPanel()" title="Ë®òÊÜ∂">üß†</button>
          <button class="toolbar-btn" onclick="triggerAutoMsgNow()" title="ËÆìËßíËâ≤Á´ãÂàªÂÇ≥Ë®äÊÅØ" style="margin-left:auto;">üí¨‚ú®</button>
        </div>
        <!-- Image preview strip -->
        <div id="chat-img-preview-strip" style="display:none;padding:0.4rem 0;display:flex;flex-wrap:wrap;gap:0.4rem;align-items:center;"></div>
        <div class="input-row">
          <textarea id="msg-input" placeholder="ÂÇ≥Ë®äÊÅØ..." rows="1"
            onkeydown="handleInputKey(event)"
            oninput="autoResize(this)"></textarea>
          <button id="send-btn" onclick="sendMessage()">‚û§</button>
        </div>
      </div>
    </div>

    <!-- CHARACTERS PAGE -->
    <div class="page" id="chars-page">
      <div id="chat-header" style="padding:1rem 1.2rem; border-bottom:1px solid rgba(201,184,232,0.2); background:var(--header-bg); display:flex; align-items:center; justify-content:space-between;">
        <div style="font-size:1rem;font-weight:700;color:var(--text-dark)">ËßíËâ≤ÁÆ°ÁêÜ</div>
        <div style="display:flex;gap:0.5rem;">
          <button class="header-btn" onclick="openImportModal()" title="ÂåØÂÖ•ËßíËâ≤Âç°">üìÇ</button>
          <button class="header-btn" onclick="openModal('add-char-modal')" title="Êñ∞Â¢ûËßíËâ≤">Ôºã</button>
        </div>
      </div>
      <div id="chars-grid"></div>
    </div>

    <!-- SOCIAL PAGE -->
    <div class="page" id="social-page">
      <div class="social-tabs">
        <button class="social-tab active" onclick="switchSocialTab('plurk', this)">üåä ÂôóÊµ™</button>
        <button class="social-tab" onclick="switchSocialTab('ig', this)">üì∑ Instagram</button>
      </div>
      <div class="social-feed" id="social-feed"></div>
    </div>

    <!-- DIARY PAGE -->
    <div class="page" id="diary-page">
      <div class="diary-header">
        <button class="diary-nav-btn" onclick="changeMonth(-1)">‚Äπ</button>
        <div class="diary-month" id="diary-month-label"></div>
        <button class="diary-nav-btn" onclick="changeMonth(1)">‚Ä∫</button>
      </div>
      <div class="diary-calendar" id="diary-calendar"></div>
      <div class="diary-content" id="diary-content">
        <div class="diary-empty">ÈªûÊìäÊó•ÊúüÊü•ÁúãËßíËâ≤Êó•Ë®ò</div>
      </div>
    </div>

    <!-- THEATER PAGE Â∞èÂäáÂ†¥ -->
    <div class="page" id="theater-page">
      <div class="diary-header">
        <div style="font-size:1rem;font-weight:700;color:var(--text-dark);">üé≠ Â∞èÂäáÂ†¥</div>
        <div style="font-size:0.72rem;color:var(--text-light);">Áç®Á´ãÊïò‰∫ã„Éª‰∏çÂΩ±ÈüøËÅäÂ§©</div>
      </div>
      <div style="flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:1rem;">
        <div style="background:rgba(255,255,255,0.88);border-radius:20px;padding:1.2rem;box-shadow:0 2px 10px var(--shadow);border:1px solid rgba(201,184,232,0.12);">
          <div class="modal-label" style="margin-bottom:0.6rem;">ÈÅ∏ÊìáËßíËâ≤</div>
          <select class="modal-select" id="theater-char-select" style="margin-bottom:0.8rem;"></select>
          <div class="modal-label" style="margin-bottom:0.6rem;">ÂäáÂ†¥ÊÉÖÂ¢ÉÊèèËø∞</div>
          <textarea class="modal-textarea" id="theater-prompt" style="min-height:90px;margin-bottom:0.8rem;" placeholder="‰æãÔºöÊàëÂÄëÂú®ÂíñÂï°Âª≥Á™ÅÁÑ∂‰∏ãËµ∑Â§ßÈõ®ÔºåË¢´Ëø´Èï∑ÊôÇÈñìÁ≠âÂæÖ...&#10;‰æãÔºöËßíËâ≤Âú®Êàë‰∏çÁü•ÊÉÖÁöÑÊÉÖÊ≥Å‰∏ã‰∏ÄÁõ¥ÊöóÊàÄËëóÊàë...&#10;‰æãÔºöÊàëÁîüÊ∞£‰∫ÜÔºåËßíËâ≤Ë©¶ÂúñÂìÑÊàë..."></textarea>
          <div class="modal-label" style="margin-bottom:0.6rem;">ÊñáÈ¢®</div>
          <div style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:0.8rem;" id="theater-style-picker">
            <button onclick="setTheaterStyle('none',this)" class="diary-style-btn" data-style="none">ÔºàÁÑ°ÔºâËá™Áî±ÁôºÊèÆ</button>
            <button onclick="setTheaterStyle('romantic',this)" class="diary-style-btn active">üíï Êµ™Êº´ÁîúËúú</button>
            <button onclick="setTheaterStyle('dark',this)" class="diary-style-btn">üåë Èô∞ÊöóÊ∑±Ê≤â</button>
            <button onclick="setTheaterStyle('spicy',this)" class="diary-style-btn">üî• Ëâ≤Ëâ≤Êí©‰∫∫</button>
            <button onclick="setTheaterStyle('funny',this)" class="diary-style-btn">üòÇ ËºïÈ¨ÜÊêûÁ¨ë</button>
            <button onclick="setTheaterStyle('angsty',this)" class="diary-style-btn">üíî ËôêÂøÉËôêÊàÄ</button>
          </div>
          <button onclick="generateTheater()" style="width:100%;padding:0.8rem;background:linear-gradient(135deg,var(--lavender),var(--milk-blue));border:none;border-radius:14px;color:white;font-family:inherit;font-size:0.9rem;cursor:pointer;font-weight:500;">‚ú® ÁîüÊàêÂ∞èÂäáÂ†¥</button>
        </div>
        <div id="theater-result" style="display:none;background:rgba(255,255,255,0.95);border-radius:20px;padding:1.5rem;box-shadow:0 2px 12px var(--shadow);border:1px solid rgba(201,184,232,0.15);">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
            <div style="font-size:0.78rem;color:var(--lavender);font-weight:500;" id="theater-result-title">‚ú® Â∞èÂäáÂ†¥</div>
            <button onclick="regenerateTheater()" class="diary-regen-btn">üîÑ ÈáçÊñ∞ÁîüÊàê</button>
          </div>
          <div id="theater-result-text" style="font-size:0.9rem;color:var(--text-dark);line-height:1.9;white-space:pre-wrap;"></div>
        </div>
      </div>
    </div>

    <!-- ACHIEVEMENTS PAGE ÊàêÂ∞±Á≥ªÁµ± -->
    <div class="page" id="achievements-page">
      <div class="diary-header">
        <div style="font-size:1rem;font-weight:700;color:var(--text-dark);">üèÜ ÊàêÂ∞±Á≥ªÁµ±</div>
        <button onclick="refreshAchievements()" class="diary-nav-btn" title="Âà∑Êñ∞ÊàêÂ∞±">üîÑ</button>
      </div>
      <div style="flex:1;overflow-y:auto;padding:1rem;">
        <div style="margin-bottom:1rem;">
          <select class="modal-select" id="achievement-char-select" onchange="renderAchievements()" style="width:100%;"></select>
        </div>
        <div id="achievement-stats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.6rem;margin-bottom:1rem;"></div>
        <div id="achievement-list" style="display:flex;flex-direction:column;gap:0.7rem;"></div>
      </div>
    </div>

    <!-- SETTINGS PAGE -->
    <div class="page" id="settings-page" style="overflow-y:auto;">
      <div style="padding:1rem 1.2rem; background:var(--header-bg); border-bottom:1px solid rgba(201,184,232,0.2); font-size:1rem; font-weight:700; color:var(--text-dark);">Ë®≠ÂÆö</div>
      
      <div class="settings-section">
        <div class="settings-section-title">API Ë®≠ÂÆö</div>
        <div class="settings-item" onclick="openApiSettings()">
          <div class="settings-item-icon" style="background:var(--lavender-soft)">üîë</div>
          <div class="settings-item-label">API Key</div>
          <div class="settings-item-value" id="api-key-display">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
          <div class="settings-item-arrow">‚Ä∫</div>
        </div>
        <div class="settings-item" onclick="openModal('model-settings-modal')">
          <div class="settings-item-icon" style="background:var(--milk-blue-soft)">ü§ñ</div>
          <div class="settings-item-label">Ê®°ÂûãÈÅ∏Êìá</div>
          <div class="settings-item-value" id="current-model-display"></div>
          <div class="settings-item-arrow">‚Ä∫</div>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-section-title">ËßíËâ≤Ëàá Persona</div>
        <div class="settings-item" onclick="openModal('persona-modal')">
          <div class="settings-item-icon" style="background:var(--beige)">üé≠</div>
          <div class="settings-item-label">ÊàëÁöÑ Persona</div>
          <div class="settings-item-value" id="persona-display">Êú™Ë®≠ÂÆö</div>
          <div class="settings-item-arrow">‚Ä∫</div>
        </div>
        <div class="settings-item" onclick="openModal('preset-modal')">
          <div class="settings-item-icon" style="background:var(--lavender-soft)">üìã</div>
          <div class="settings-item-label">Preset / ÊèêÁ§∫Ë©û</div>
          <div class="settings-item-arrow">‚Ä∫</div>
        </div>
        <div class="settings-item" onclick="openModal('lorebook-modal')">
          <div class="settings-item-icon" style="background:var(--milk-blue-soft)">üìö</div>
          <div class="settings-item-label">Lorebook</div>
          <div class="settings-item-arrow">‚Ä∫</div>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-section-title">ËßíËâ≤Ëá™ÂãïÂÇ≥Ë®ä</div>
        <div class="settings-item">
          <div class="settings-item-icon" style="background:var(--lavender-soft)">üí¨</div>
          <div class="settings-item-label">Ë∂ÖÊôÇËá™ÂãïÂÇ≥Ë®ä</div>
          <div class="toggle-switch" id="automsg-toggle" onclick="toggleAutoMsg()"></div>
        </div>
        <div class="settings-item" style="cursor:default;">
          <div class="settings-item-icon" style="background:var(--milk-blue-soft)">‚è±Ô∏è</div>
          <div class="settings-item-label">ÁÑ°ÂõûË¶ÜÂπæÂ∞èÊôÇÂæåËá™ÂãïÁôº</div>
          <input type="number" id="automsg-hours-input" min="1" max="24" value="3"
            onchange="saveAutoMsgHours()"
            style="width:56px;border:1.5px solid var(--lavender-light);border-radius:8px;padding:0.3rem 0.5rem;font-family:inherit;font-size:0.85rem;color:var(--text-dark);background:var(--lavender-soft);text-align:center;outline:none;">
          <span style="font-size:0.78rem;color:var(--text-light);">Â∞èÊôÇ</span>
        </div>
        <div class="settings-item" onclick="triggerAutoMsgNow()" style="cursor:pointer;">
          <div class="settings-item-icon" style="background:#f0fff0">üì®</div>
          <div class="settings-item-label">Á´ãÂç≥ËÆìËßíËâ≤ÂÇ≥‰∏ÄÂâáË®äÊÅØ</div>
          <div class="settings-item-arrow">‚Ä∫</div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">ÁèæÂØ¶ÈÄ£Âãï</div>
        <div class="settings-item">
          <div class="settings-item-icon" style="background:#fff0f0">üéÇ</div>
          <div class="settings-item-label">ÁîüÊó•ÊèêÈÜí</div>
          <input type="date" id="birthday-input" style="border:none;background:none;font-family:inherit;font-size:0.8rem;color:var(--text-light);outline:none;">
        </div>
        <div class="settings-item" onclick="toggleRealWorldEvents()">
          <div class="settings-item-icon" style="background:#f0fff0">üíå</div>
          <div class="settings-item-label">ÁØÄÊó•‰∏ªÂãïÈÇÄÁ¥Ñ</div>
          <div class="toggle-switch" id="realworld-toggle"></div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">üíç Á¥ÄÂøµÊó•ÁÆ°ÁêÜ</div>
        <div id="anniversary-list" style="display:flex;flex-direction:column;gap:0.5rem;margin-bottom:0.8rem;"></div>
        <div class="settings-item" onclick="openAnniversaryModal()" style="border:1.5px dashed rgba(201,184,232,0.4);background:rgba(201,184,232,0.06);">
          <div class="settings-item-icon" style="background:var(--lavender-soft)">Ôºã</div>
          <div class="settings-item-label" style="color:var(--text-light)">Êñ∞Â¢ûÁ¥ÄÂøµÊó•</div>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-section-title">Ë≥áÊñôÁÆ°ÁêÜ</div>
        <div class="settings-item" onclick="exportBackup()">
          <div class="settings-item-icon" style="background:var(--lavender-soft)">üíæ</div>
          <div class="settings-item-label">ÂåØÂá∫ÂÇô‰ªΩ</div>
          <div class="settings-item-arrow">‚Ä∫</div>
        </div>
        <div class="settings-item" onclick="importBackup()">
          <div class="settings-item-icon" style="background:var(--milk-blue-soft)">üì•</div>
          <div class="settings-item-label">ÂåØÂÖ•ÂÇô‰ªΩ</div>
          <div class="settings-item-arrow">‚Ä∫</div>
        </div>
        <div class="settings-item" onclick="confirmClearAll()">
          <div class="settings-item-icon" style="background:#fff0f0">üóëÔ∏è</div>
          <div class="settings-item-label" style="color:#e87878">Ê∏ÖÈô§ÊâÄÊúâË≥áÊñô</div>
          <div class="settings-item-arrow">‚Ä∫</div>
        </div>
      </div>
    </div>

  </div>

  <!-- Memory Panel -->
  <div id="memory-panel">
    <div class="memory-header">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="memory-title">üß† Èï∑ÊúüË®òÊÜ∂</div>
        <button onclick="toggleMemoryPanel()" style="background:none;border:none;cursor:pointer;color:var(--text-light);font-size:1.1rem;">√ó</button>
      </div>
    </div>
    <div class="memory-list" id="memory-list"></div>
    <button class="memory-add-btn" onclick="addMemoryItem()">Ôºã Êñ∞Â¢ûË®òÊÜ∂</button>
  </div>

</div>

<!-- ‚îÄ‚îÄ‚îÄ CONTEXT MENU ‚îÄ‚îÄ‚îÄ -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-item" onclick="ctxAction('copy')">üìã Ë§áË£Ω</div>
  <div class="ctx-item" onclick="ctxAction('edit')">‚úèÔ∏è Á∑®ËºØ</div>
  <div class="ctx-divider"></div>
  <div class="ctx-item" onclick="ctxAction('regen')">üîÑ ÈáçÊñ∞ÁîüÊàê</div>
  <div class="ctx-divider"></div>
  <div class="ctx-item danger" onclick="ctxAction('delete')">üóëÔ∏è Âà™Èô§Ë®äÊÅØ</div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ -->
<div class="toast" id="toast"></div>

<!-- ‚îÄ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ‚îÄ -->
<nav id="bottom-nav">
  <button class="bottom-nav-btn active" onclick="switchPage('chat')" id="bnav-chat">
    <span class="icon">üí¨</span><span>ËÅäÂ§©</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('chars')" id="bnav-chars">
    <span class="icon">üå∏</span><span>ËßíËâ≤</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('social')" id="bnav-social">
    <span class="icon">‚ú¶</span><span>Á§æÁæ§</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('diary')" id="bnav-diary">
    <span class="icon">üìî</span><span>Êó•Ë®ò</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('theater')" id="bnav-theater">
    <span class="icon">üé≠</span><span>Â∞èÂäáÂ†¥</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('achievements')" id="bnav-achievements">
    <span class="icon">üèÜ</span><span>ÊàêÂ∞±</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('settings')" id="bnav-settings">
    <span class="icon">‚öôÔ∏è</span><span>Ë®≠ÂÆö</span>
  </button>
</nav>

<!-- ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ -->

<!-- ADD / EDIT CHAR MODAL -->
<div class="modal-overlay" id="add-char-modal">
  <div class="modal">
    <div class="modal-title" id="add-char-modal-title">üå∏ Êñ∞Â¢ûËßíËâ≤</div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchModalTab(this,'char-manual')">ÊâãÂãïÂª∫Á´ã</button>
      <button class="modal-tab" onclick="switchModalTab(this,'char-import')">ÂåØÂÖ•ËßíËâ≤Âç°</button>
    </div>
    <div class="modal-tab-content active" id="char-manual">
      <div class="modal-field">
        <label class="modal-label">ËßíËâ≤ÂêçÁ®±</label>
        <input class="modal-input" id="char-name-input" placeholder="‰æãÔºöÂ∞èÈõ®">
      </div>
      <div class="modal-field">
        <label class="modal-label">È†≠ÂÉè</label>
        <div style="display:flex;align-items:center;gap:0.7rem;margin-bottom:0.5rem;">
          <div id="char-avatar-preview" style="width:48px;height:48px;border-radius:14px;background:var(--lavender-soft);border:1.5px solid var(--lavender-light);display:flex;align-items:center;justify-content:center;font-size:1.8rem;overflow:hidden;flex-shrink:0;"></div>
          <div style="flex:1;">
            <input class="modal-input" id="char-avatar-input" placeholder="üå∏ ÊàñË≤º‰∏äÂúñÁâá URL" style="margin-bottom:0.4rem;">
            <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;font-size:0.78rem;color:var(--text-mid);background:var(--lavender-soft);border:1px solid var(--lavender-light);border-radius:10px;padding:0.35rem 0.7rem;width:fit-content;">
              üì∑ ‰∏äÂÇ≥ÂúñÁâá
              <input type="file" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)">
            </label>
          </div>
        </div>
      </div>
      <div class="modal-field">
        <label class="modal-label">ËßíËâ≤ÊèèËø∞ (Character Card)</label>
        <textarea class="modal-textarea" id="char-desc-input" placeholder="ÊèèËø∞ËßíËâ≤ÁöÑÂÄãÊÄß„ÄÅËÉåÊôØ„ÄÅË™™Ë©±ÊñπÂºè..."></textarea>
      </div>
      <div class="modal-field">
        <label class="modal-label">ÈñãÂ†¥ÁôΩ (First Message)</label>
        <textarea class="modal-textarea" id="char-first-msg-input" style="min-height:70px" placeholder="ËßíËâ≤ÁöÑÁ¨¨‰∏ÄÂè•Ë©±..."></textarea>
      </div>
      <div class="modal-field">
        <label class="modal-label">Á∂ÅÂÆö Persona</label>
        <select class="modal-select" id="char-persona-select">
          <option value="">‰∏çÁ∂ÅÂÆö</option>
        </select>
      </div>
    </div>
    <div class="modal-tab-content" id="char-import">
      <div style="padding:1rem;text-align:center;color:var(--text-light);">
        <p style="margin-bottom:1rem;font-size:0.88rem;">ÊîØÊè¥ SillyTavern ËßíËâ≤Âç°Ê†ºÂºè</p>
        <label style="cursor:pointer;">
          <div style="padding:1.5rem;border:2px dashed rgba(201,184,232,0.4);border-radius:14px;">
            <div style="font-size:2rem;margin-bottom:0.5rem;">üìÇ</div>
            <div style="font-size:0.85rem;">ÈªûÊìäÈÅ∏Êìá .json Êàñ .png Ê™îÊ°à</div>
          </div>
          <input type="file" accept=".json,.png" style="display:none" onchange="importCharCard(event)">
        </label>
      </div>
    </div>
    <div class="modal-actions" style="flex-wrap:wrap;gap:0.4rem;">
      <button class="modal-btn secondary" onclick="closeModal('add-char-modal')" style="flex:1;min-width:80px;">ÂèñÊ∂à</button>
      <button id="delete-char-btn" class="modal-btn secondary" onclick="deleteCharFromModal()" style="flex:1;min-width:80px;color:#e87878;display:none;">üóëÔ∏è Âà™Èô§ËßíËâ≤</button>
      <button id="save-char-btn" class="modal-btn primary" onclick="saveChar()" style="flex:2;min-width:100px;">Âª∫Á´ãËßíËâ≤</button>
    </div>
  </div>
</div>

<!-- PRESET MODAL -->
<div class="modal-overlay" id="preset-modal">
  <div class="modal">
    <div class="modal-title">üìã Preset ÊèêÁ§∫Ë©ûË®≠ÂÆö</div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchModalTab(this,'preset-system')">System Prompt</button>
      <button class="modal-tab" onclick="switchModalTab(this,'preset-jailbreak')">Ë∂äÁçÑÊèêÁ§∫Ë©û</button>
      <button class="modal-tab" onclick="switchModalTab(this,'preset-regex')">Regex</button>
    </div>
    <div class="modal-tab-content active" id="preset-system">
      <div class="modal-field">
        <label class="modal-label">‰∏ªË¶Å System Prompt</label>
        <textarea class="modal-textarea" id="system-prompt-input" style="min-height:140px" placeholder="You are {{char}}, talking to {{user}}. Reply in Traditional Chinese..."></textarea>
      </div>
      <div class="modal-field">
        <label class="modal-label">Context Template</label>
        <select class="modal-select" id="context-template-select">
          <option>È†êË®≠ (LINE ËÅäÂ§©È¢®Ê†º)</option>
          <option>Â≠∏Ë°ì/Ê≠£Âºè</option>
          <option>ÂâµÊÑèÂØ´‰Ωú</option>
          <option>Ëá™Ë®Ç...</option>
        </select>
      </div>
    </div>
    <div class="modal-tab-content" id="preset-jailbreak">
      <div class="modal-field">
        <label class="modal-label">Ë∂äÁçÑÊèêÁ§∫Ë©û (Ê≥®ÂÖ•Âà∞ Context Êú´Â∞æ)</label>
        <textarea class="modal-textarea" id="jailbreak-input" style="min-height:140px" placeholder="[Â†¥ÊôØÊèèËø∞ÔºåÂπ´Âä© AI Êõ¥Â•ΩÂú∞ÊâÆÊºîËßíËâ≤...]"></textarea>
      </div>
      <div class="modal-field">
        <label class="modal-label">Ê≥®ÂÖ•‰ΩçÁΩÆ</label>
        <select class="modal-select" id="jailbreak-position">
          <option value="before_char">ËßíËâ≤ÊèèËø∞‰πãÂâç</option>
          <option value="after_char">ËßíËâ≤ÊèèËø∞‰πãÂæå</option>
          <option value="before_last">ÊúÄÂæå‰∏ÄÂâáË®äÊÅØ‰πãÂâç</option>
          <option value="system">System Â±§</option>
        </select>
      </div>
    </div>
    <div class="modal-tab-content" id="preset-regex">
      <div class="modal-field">
        <label class="modal-label">Regex Ë¶èÂâá (ÊØèË°å‰∏ÄÊ¢ùÔºåÊ†ºÂºè: pattern ‚Üí replacement)</label>
        <textarea class="modal-textarea" id="regex-input" style="min-height:140px;font-family:monospace;font-size:0.8rem;" placeholder="\\*\\*(.*?)\\*\\* ‚Üí $1&#10;\*.*?\* ‚Üí "></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('preset-modal')">ÂèñÊ∂à</button>
      <button class="modal-btn primary" onclick="savePreset()">ÂÑ≤Â≠ò</button>
    </div>
  </div>
</div>

<!-- LOREBOOK MODAL -->
<div class="modal-overlay" id="lorebook-modal">
  <div class="modal" style="width:min(660px,96vw);max-height:90dvh;padding:1.5rem;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.8rem;">
      <div style="display:flex;align-items:center;gap:0.6rem;">
        <div style="font-size:1.3rem;">üìö</div>
        <div>
          <div class="modal-title" style="margin:0;font-size:1rem;">Lorebook / World Info</div>
          <div style="font-size:0.68rem;color:var(--text-light);letter-spacing:0.05em;">SillyTavern Áõ∏ÂÆπÊ†ºÂºè</div>
        </div>
      </div>
      <div id="lb-count"></div>
    </div>
    <!-- Scope Tabs -->
    <div class="modal-tabs" style="margin-bottom:0.8rem;">
      <button class="modal-tab active" id="lb-tab-global" onclick="switchLbTab('global',this)">üåç ÂÖ®Âüü Lorebook</button>
      <button class="modal-tab" id="lb-tab-char" onclick="switchLbTab('char',this)">üå∏ ËßíËâ≤ Lorebook</button>
      <button class="modal-tab" id="lb-tab-chat" onclick="switchLbTab('chat',this)">üí¨ ËÅäÂ§© Lorebook</button>
    </div>
    <!-- Scope description -->
    <div class="lb-st-info" style="margin-bottom:0.8rem;" id="lb-scope-info">
      <span>üåç</span><span>ÂÖ®ÂüüÔºöÂ∞çÊâÄÊúâÂ∞çË©±ÁîüÊïà ¬∑ ÈóúÈçµÂ≠óËß∏ÁôºËá™ÂãïÊ≥®ÂÖ• ¬∑ Constant Ê∞∏ÈÅ†Ê≥®ÂÖ•</span>
    </div>
    <!-- Char selector (for char tab) -->
    <div id="lb-char-selector" style="display:none;margin-bottom:0.8rem;">
      <select class="lb-select" id="lb-char-sel" onchange="renderLorebookList()">
        <option value="">ÈÅ∏ÊìáËßíËâ≤...</option>
      </select>
    </div>
    <div id="lorebook-list" style="margin-bottom:0.8rem;max-height:calc(90dvh - 260px);overflow-y:auto;display:flex;flex-direction:column;gap:0.5rem;padding-right:2px;"></div>
    <div style="display:flex;gap:0.5rem;">
      <button onclick="addLorebookEntry()" style="flex:1;padding:0.65rem;background:var(--lavender-soft);border:1.5px dashed rgba(201,184,232,0.5);border-radius:12px;font-family:inherit;font-size:0.85rem;color:var(--text-mid);cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center;gap:0.4rem;">Ôºã Êñ∞Â¢ûÊ¢ùÁõÆ</button>
      <button class="modal-btn primary" onclick="saveLorebook()" style="flex:0 0 auto;padding:0.65rem 1.4rem;">ÂÆåÊàê</button>
    </div>
  </div>
</div>
<!-- PERSONA MODAL -->
<div class="modal-overlay" id="persona-modal">
  <div class="modal" style="width:min(560px,96vw);max-height:90dvh;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem;">
      <div class="modal-title" style="margin:0;">üé≠ ÊàëÁöÑ Persona</div>
      <button onclick="openAddPersonaPanel()" style="padding:0.4rem 0.9rem;background:linear-gradient(135deg,var(--lavender),var(--milk-blue));border:none;border-radius:10px;color:white;font-family:inherit;font-size:0.78rem;cursor:pointer;" id="persona-add-btn">Ôºã Êñ∞Â¢û</button>
    </div>
    <!-- Persona List -->
    <div id="persona-list" style="max-height:calc(90dvh - 220px);overflow-y:auto;display:flex;flex-direction:column;gap:0.6rem;margin-bottom:1rem;"></div>
    <!-- Add/Edit Panel -->
    <div id="persona-edit-panel" style="display:none;background:var(--lavender-soft);border-radius:16px;padding:1.1rem;border:1.5px solid rgba(201,184,232,0.3);margin-bottom:0.8rem;">
      <div style="font-size:0.82rem;font-weight:600;color:var(--lavender);margin-bottom:0.8rem;" id="persona-panel-title">Ôºã Êñ∞Â¢û Persona</div>
      <div style="display:flex;gap:0.8rem;margin-bottom:0.8rem;align-items:flex-start;">
        <!-- Avatar -->
        <div style="display:flex;flex-direction:column;align-items:center;gap:0.4rem;flex-shrink:0;">
          <div id="persona-avatar-preview" style="width:60px;height:60px;border-radius:18px;background:var(--lavender-light);display:flex;align-items:center;justify-content:center;font-size:2rem;overflow:hidden;border:2px solid rgba(201,184,232,0.4);cursor:pointer;" onclick="document.getElementById('persona-avatar-file').click()">üé≠</div>
          <input type="file" id="persona-avatar-file" accept="image/*" style="display:none" onchange="handlePersonaAvatarUpload(event)">
          <div style="font-size:0.62rem;color:var(--text-light);">ÈªûÊìä‰∏äÂÇ≥</div>
        </div>
        <div style="flex:1;display:flex;flex-direction:column;gap:0.5rem;">
          <input class="lb-input" id="persona-name-input" placeholder="Persona ÂêçÁ®±Ôºà‰Ω†ÁöÑËßíËâ≤ÂêçÔºâ" style="font-weight:500;">
          <textarea class="lb-textarea" id="persona-desc-input" placeholder="ÊèèËø∞‰Ω†Ëá™Â∑±ÁöÑÂÄãÊÄß„ÄÅË™™Ë©±ÊñπÂºè„ÄÅËÉåÊôØ..." style="min-height:60px;font-size:0.82rem;"></textarea>
        </div>
      </div>
      <!-- Bound chars -->
      <div style="margin-bottom:0.7rem;">
        <div style="font-size:0.72rem;color:var(--text-light);margin-bottom:0.4rem;letter-spacing:0.05em;">Á∂ÅÂÆöËßíËâ≤ÔºàÂèØÂ§öÈÅ∏Ôºâ</div>
        <div id="persona-char-checkboxes" style="display:flex;flex-wrap:wrap;gap:0.4rem;"></div>
      </div>
      <div style="display:flex;gap:0.4rem;">
        <button onclick="cancelPersonaEdit()" class="msg-edit-btn cancel" style="flex:1;">ÂèñÊ∂à</button>
        <button onclick="savePersonaFromPanel()" class="msg-edit-btn confirm" style="flex:2;">‚úì ÂÑ≤Â≠ò</button>
      </div>
    </div>
    <div class="modal-actions" style="margin-top:0;">
      <button class="modal-btn secondary" onclick="closeModal('persona-modal')">ÈóúÈñâ</button>
    </div>
  </div>
</div>

<!-- MODEL SETTINGS MODAL -->
<div class="modal-overlay" id="model-settings-modal">
  <div class="modal">
    <div class="modal-title">ü§ñ Ê®°ÂûãË®≠ÂÆö</div>
    <div class="modal-field">
      <label class="modal-label">API Key</label>
      <input class="modal-input" type="password" id="api-key-update" placeholder="AIza...">
    </div>
    <div class="modal-field">
      <label class="modal-label">Ê®°ÂûãÂêçÁ®±ÔºàÂèØËá™Ë°åËº∏ÂÖ•‰ªªÊÑèÊ®°Âûã IDÔºâ</label>
      <input class="modal-input" type="text" id="model-custom-input"
        placeholder="‰æãÔºögemini-3-flash-preview"
        list="model-datalist-settings">
      <datalist id="model-datalist-settings">
        <option value="gemini-3-flash-preview">Gemini 3 Flash PreviewÔºàÊúÄÊñ∞Ôºâ</option>
        <option value="gemini-3-pro-preview">Gemini 3 Pro PreviewÔºàÊúÄÊñ∞Ôºâ</option>
        <option value="gemini-3-flash-exp">Gemini 3 Flash Exp</option>
        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
      </datalist>
      <div style="font-size:0.72rem;color:var(--text-light);margin-top:0.35rem;">Áõ¥Êé•Ëº∏ÂÖ•Ê®°Âûã ID Âç≥ÂèØ‰ΩøÁî®‰ªª‰Ωï Gemini ÁâàÊú¨</div>
      <!-- hidden for backward compat -->
      <select id="model-update-select" style="display:none">
        <option value="gemini-3-flash-preview">gemini-3-flash-preview</option>
        <option value="gemini-3-pro-preview">gemini-3-pro-preview</option>
        <option value="gemini-2.0-flash">gemini-2.0-flash</option>
        <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp</option>
      </select>
    </div>
    <div class="modal-field">
      <label class="modal-label">Temperature</label>
      <input type="range" min="0" max="2" step="0.1" value="1.0" id="temp-slider" oninput="document.getElementById('temp-val').textContent=this.value" style="width:100%">
      <span id="temp-val" style="font-size:0.8rem;color:var(--text-light)">1.0</span>
    </div>
    <div class="modal-field">
      <label class="modal-label">Max Output Tokens</label>
      <input class="modal-input" type="number" id="max-tokens-input" value="2048" min="100" max="8192">
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('model-settings-modal')">ÂèñÊ∂à</button>
      <button class="modal-btn primary" onclick="saveModelSettings()">ÂÑ≤Â≠ò</button>
    </div>
  </div>
</div>

<!-- IMAGE PREVIEW MODAL -->
<div class="modal-overlay" id="image-preview-modal" onclick="closeModal('image-preview-modal')">
  <div style="max-width:90vw;max-height:90vh;">
    <img id="preview-img" style="max-width:100%;max-height:90vh;border-radius:18px;display:block;">
  </div>
</div>

<!-- SOCIAL COMPOSE MODAL -->
<div class="modal-overlay" id="social-compose-modal">
  <div class="modal">
    <div class="modal-title" id="social-compose-title">‚ú¶ ËÆìËßíËâ≤ÁôºÊñá</div>
    <div class="modal-field">
      <label class="modal-label">ÁôºÊñáËßíËâ≤</label>
      <select class="modal-select" id="social-post-char-select"></select>
    </div>
    <div class="modal-field">
      <label class="modal-label">ÁôºÊñáÂÖßÂÆπÊèêÁ§∫</label>
      <textarea class="modal-textarea" id="social-post-prompt" placeholder="ÊèèËø∞‰Ω†Â∏åÊúõËßíËâ≤Áôº‰ªÄÈ∫º‰∏ªÈ°åÁöÑÊñáÁ´†...ÔºàÁïôÁ©∫ËÆìËßíËâ≤Ëá™Áî±ÁôºÊèÆÔºâ"></textarea>
    </div>
    <div class="modal-field">
      <label class="modal-label">ÂúñÁâáÁîüÊàê</label>
      <select class="modal-select" id="social-image-option">
        <option value="none">‰∏çÁîüÊàêÂúñÁâá</option>
        <option value="auto">Ê†πÊìöÂÖßÂÆπËá™ÂãïÁîüÊàê</option>
        <option value="selfie">Ëá™ÊãçÈ¢®Ê†º</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('social-compose-modal')">ÂèñÊ∂à</button>
      <button class="modal-btn primary" onclick="aiPostSocial()">ÁôºÂ∏É</button>
    </div>
  </div>
</div>

<!-- CHAR INFO MODAL (quick view) -->
<div class="modal-overlay" id="char-info-modal">
  <div class="modal">
    <div style="text-align:center;margin-bottom:1rem;">
      <div id="char-info-avatar" style="width:80px;height:80px;border-radius:24px;background:linear-gradient(135deg,var(--lavender),var(--milk-blue));display:flex;align-items:center;justify-content:center;font-size:2.5rem;margin:0 auto 0.8rem;overflow:hidden;"></div>
      <div id="char-info-name" style="font-size:1.2rem;font-weight:700;color:var(--text-dark);"></div>
    </div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchModalTab(this,'ci-desc')">ÊèèËø∞</button>
      <button class="modal-tab" onclick="switchModalTab(this,'ci-chats')">ËÅäÂ§©Á™ó</button>
      <button class="modal-tab" onclick="switchModalTab(this,'ci-export')">ÂåØÂá∫</button>
    </div>
    <div class="modal-tab-content active" id="ci-desc">
      <div id="char-info-desc" style="font-size:0.85rem;color:var(--text-mid);line-height:1.7;max-height:200px;overflow-y:auto;"></div>
    </div>
    <div class="modal-tab-content" id="ci-chats">
      <div id="char-info-chats" style="display:flex;flex-direction:column;gap:0.5rem;"></div>
      <button onclick="newChatWithChar()" style="width:100%;margin-top:0.8rem;padding:0.6rem;background:var(--lavender-soft);border:1.5px dashed rgba(201,184,232,0.4);border-radius:12px;font-family:inherit;font-size:0.82rem;color:var(--text-mid);cursor:pointer;">Ôºã Êñ∞ÈñãËÅäÂ§©Á™ó</button>
    </div>
    <div class="modal-tab-content" id="ci-export">
      <div style="display:flex;flex-direction:column;gap:0.5rem;">
        <button class="modal-btn secondary" onclick="exportCharAsJson()">ÂåØÂá∫ÁÇ∫ JSON ËßíËâ≤Âç°</button>
        <button class="modal-btn secondary" onclick="exportChatHistory()">ÂåØÂá∫ËÅäÂ§©Ë®òÈåÑ</button>
        <button class="modal-btn secondary" onclick="exportChatAsST()">ÂåØÂá∫ÁÇ∫ ST Ê†ºÂºè</button>
      </div>
    </div>
    <div class="modal-actions" style="flex-wrap:wrap;gap:0.4rem;">
      <button class="modal-btn secondary" onclick="closeModal('char-info-modal')" style="flex:1;">ÈóúÈñâ</button>
      <button class="modal-btn secondary" onclick="deleteChar(state.activeCharId)" style="flex:1;color:#e87878;">üóëÔ∏è Âà™Èô§ËßíËâ≤</button>
      <button class="modal-btn primary" onclick="editChar()" style="flex:2;">‚úèÔ∏è Á∑®ËºØËßíËâ≤</button>
    </div>
  </div>
</div>

<!-- ANNIVERSARY MODAL -->
<div class="modal-overlay" id="anniversary-modal">
  <div class="modal">
    <div class="modal-title">üíç Êñ∞Â¢ûÁ¥ÄÂøµÊó•</div>
    <div class="modal-field">
      <label class="modal-label">Á¥ÄÂøµÊó•È°ûÂûã</label>
      <select class="modal-select" id="anniv-type" onchange="toggleAnnivCustomField()">
        <option value="confession">üíå ÂëäÁôΩÊó•</option>
        <option value="dating">üíï ‰∫§ÂæÄÁ¥ÄÂøµÊó•</option>
        <option value="wedding">üíç ÁµêÂ©öÁ¥ÄÂøµÊó•</option>
        <option value="firstmeet">üå∏ ÂàùÊ¨°Áõ∏ÈÅá</option>
        <option value="custom">‚ú® Ëá™Ë®Ç</option>
      </select>
    </div>
    <div class="modal-field" id="anniv-custom-field" style="display:none;">
      <label class="modal-label">Ëá™Ë®ÇÂêçÁ®±</label>
      <input class="modal-input" id="anniv-custom-name" placeholder="‰æãÔºöÁ¨¨‰∏ÄÊ¨°Á¥ÑÊúÉ">
    </div>
    <div class="modal-field">
      <label class="modal-label">Á∂ÅÂÆöËßíËâ≤</label>
      <select class="modal-select" id="anniv-char-select"></select>
    </div>
    <div class="modal-field">
      <label class="modal-label">Êó•Êúü</label>
      <input class="modal-input" type="date" id="anniv-date">
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('anniversary-modal')">ÂèñÊ∂à</button>
      <button class="modal-btn primary" onclick="saveAnniversary()">ÂÑ≤Â≠ò</button>
    </div>
  </div>
</div>

<script src="app.js"></script>
</body>
</html>
