<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>erhabene</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@300;400;500;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
<style>
:root {
  --lavender: #c9b8e8;
  --lavender-light: #e8e0f5;
  --lavender-soft: #f3eff9;
  --milk-blue: #b8d4e8;
  --milk-blue-light: #daeaf5;
  --milk-blue-soft: #eef5fb;
  --beige: #f0e8d8;
  --beige-dark: #d4c4a8;
  --beige-soft: #faf6f0;
  --text-dark: #3d3450;
  --text-mid: #6b5f7a;
  --text-light: #a89bb5;
  --white: #fefefe;
  --shadow: rgba(180,160,210,0.18);
  --shadow-deep: rgba(100,80,140,0.12);
  --bubble-user: linear-gradient(135deg, #c9b8e8, #b8c8e8);
  --bubble-ai: rgba(255,255,255,0.9);
  --sidebar-bg: linear-gradient(180deg, #f3eff9 0%, #eef5fb 50%, #faf6f0 100%);
  --header-bg: rgba(243,239,249,0.95);
  --nav-active: #c9b8e8;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  font-family: 'Zen Kaku Gothic New', sans-serif;
  background: var(--beige-soft);
  color: var(--text-dark);
  height: 100dvh;
  overflow: hidden;
  display: flex;
}

/* â”€â”€â”€ SETUP SCREEN â”€â”€â”€ */
#setup-screen {
  position: fixed; inset: 0;
  background: linear-gradient(160deg, #f3eff9 0%, #eef5fb 40%, #faf6f0 100%);
  display: flex; align-items: center; justify-content: center;
  z-index: 9999;
  flex-direction: column;
  gap: 2rem;
}

.setup-card {
  background: rgba(255,255,255,0.82);
  backdrop-filter: blur(20px);
  border-radius: 28px;
  padding: 3rem;
  width: min(460px, 92vw);
  box-shadow: 0 8px 40px var(--shadow), 0 2px 8px var(--shadow-deep);
  border: 1px solid rgba(201,184,232,0.3);
}

.setup-logo {
  font-family: 'Cormorant Garamond', serif;
  font-size: 2.8rem;
  font-weight: 300;
  font-style: italic;
  color: var(--text-dark);
  text-align: center;
  margin-bottom: 0.3rem;
  letter-spacing: 0.05em;
}
.setup-tagline {
  text-align: center;
  font-size: 0.78rem;
  color: var(--text-light);
  letter-spacing: 0.15em;
  text-transform: uppercase;
  margin-bottom: 2.2rem;
}

.setup-field { margin-bottom: 1.2rem; }
.setup-label {
  display: block;
  font-size: 0.78rem;
  color: var(--text-mid);
  margin-bottom: 0.5rem;
  letter-spacing: 0.08em;
}
.setup-input, .setup-select {
  width: 100%;
  padding: 0.85rem 1.1rem;
  border: 1.5px solid var(--lavender-light);
  border-radius: 14px;
  background: var(--lavender-soft);
  color: var(--text-dark);
  font-family: inherit;
  font-size: 0.9rem;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.setup-input:focus, .setup-select:focus {
  border-color: var(--lavender);
  box-shadow: 0 0 0 3px rgba(201,184,232,0.2);
}
.setup-select option { background: white; }

.setup-btn {
  width: 100%;
  padding: 1rem;
  background: linear-gradient(135deg, #c9b8e8, #b8cce8);
  border: none;
  border-radius: 16px;
  color: white;
  font-family: inherit;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s;
  margin-top: 0.5rem;
  letter-spacing: 0.05em;
}
.setup-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(180,160,220,0.4); }
.setup-btn:active { transform: translateY(0); }

/* â”€â”€â”€ MAIN LAYOUT â”€â”€â”€ */
#app { display: flex; width: 100%; height: 100dvh; }

/* â”€â”€â”€ LEFT NAV (Desktop) â”€â”€â”€ */
#side-nav {
  width: 68px;
  background: var(--lavender-soft);
  border-right: 1px solid rgba(201,184,232,0.2);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 1.2rem 0;
  gap: 0.3rem;
  z-index: 100;
  flex-shrink: 0;
}

.nav-logo {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.1rem;
  font-style: italic;
  color: var(--lavender);
  margin-bottom: 1rem;
  writing-mode: horizontal-tb;
}

.nav-btn {
  width: 46px; height: 46px;
  border-radius: 14px;
  border: none;
  background: transparent;
  color: var(--text-light);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.3rem;
  transition: background 0.2s, color 0.2s;
  position: relative;
}
.nav-btn:hover { background: var(--lavender-light); color: var(--text-dark); }
.nav-btn.active { background: var(--lavender); color: white; }
.nav-btn .badge {
  position: absolute; top: 6px; right: 6px;
  width: 8px; height: 8px;
  background: #e8a0b8;
  border-radius: 50%;
}

.nav-spacer { flex: 1; }

/* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
#sidebar {
  width: 300px;
  background: var(--sidebar-bg);
  border-right: 1px solid rgba(201,184,232,0.25);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow: hidden;
}

.sidebar-header {
  padding: 1.2rem 1.2rem 0.8rem;
  border-bottom: 1px solid rgba(201,184,232,0.2);
}
.sidebar-title {
  font-size: 1rem;
  font-weight: 700;
  color: var(--text-dark);
  margin-bottom: 0.7rem;
}
.sidebar-search {
  display: flex; align-items: center;
  background: rgba(255,255,255,0.7);
  border-radius: 12px;
  padding: 0.5rem 0.8rem;
  gap: 0.5rem;
  border: 1px solid rgba(201,184,232,0.2);
}
.sidebar-search input {
  border: none; background: none; outline: none;
  font-family: inherit; font-size: 0.85rem;
  color: var(--text-dark); flex: 1;
}
.sidebar-search span { color: var(--text-light); font-size: 0.9rem; }

.sidebar-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
.sidebar-list::-webkit-scrollbar { width: 3px; }
.sidebar-list::-webkit-scrollbar-thumb { background: var(--lavender-light); border-radius: 2px; }

.chat-item {
  display: flex; align-items: center; gap: 0.8rem;
  padding: 0.75rem 0.8rem;
  border-radius: 16px;
  cursor: pointer;
  transition: background 0.15s;
  position: relative;
}
.chat-item:hover { background: rgba(255,255,255,0.6); }
.chat-item.active { background: rgba(255,255,255,0.85); box-shadow: 0 2px 8px var(--shadow); }

.chat-avatar {
  width: 46px; height: 46px; border-radius: 16px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 1.4rem; flex-shrink: 0;
  overflow: hidden; position: relative;
}
.chat-avatar img { width: 100%; height: 100%; object-fit: cover; }
.chat-avatar-status {
  position: absolute; bottom: 2px; right: 2px;
  width: 10px; height: 10px; border-radius: 50%;
  background: #a8d8a8; border: 2px solid white;
}

.chat-meta { flex: 1; min-width: 0; }
.chat-name { font-size: 0.9rem; font-weight: 500; color: var(--text-dark); }
.chat-preview { font-size: 0.78rem; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 0.15rem; }
.chat-time { font-size: 0.7rem; color: var(--text-light); }
.chat-unread {
  background: var(--lavender);
  color: white;
  border-radius: 10px;
  font-size: 0.7rem;
  padding: 0.15rem 0.45rem;
  font-weight: 500;
  min-width: 20px; text-align: center;
}

.add-chat-btn {
  margin: 0.5rem;
  padding: 0.7rem;
  background: linear-gradient(135deg, rgba(201,184,232,0.3), rgba(184,212,232,0.3));
  border: 1.5px dashed rgba(201,184,232,0.5);
  border-radius: 14px;
  color: var(--text-light);
  cursor: pointer;
  text-align: center;
  font-size: 0.82rem;
  font-family: inherit;
  transition: all 0.2s;
}
.add-chat-btn:hover { background: rgba(201,184,232,0.2); color: var(--text-mid); border-style: solid; }

/* â”€â”€â”€ MAIN AREA â”€â”€â”€ */
#main-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* â”€â”€â”€ CHAT HEADER â”€â”€â”€ */
#chat-header {
  padding: 0.9rem 1.2rem;
  background: var(--header-bg);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(201,184,232,0.2);
  display: flex;
  align-items: center;
  gap: 0.9rem;
  flex-shrink: 0;
}

.header-avatar {
  width: 40px; height: 40px; border-radius: 13px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem; overflow: hidden; flex-shrink: 0;
}
.header-avatar img { width: 100%; height: 100%; object-fit: cover; }
.header-info { flex: 1; }
.header-name { font-size: 0.95rem; font-weight: 500; color: var(--text-dark); }
.header-status { font-size: 0.72rem; color: var(--text-light); }

.header-actions { display: flex; gap: 0.4rem; }
.header-btn {
  width: 36px; height: 36px; border-radius: 11px;
  border: none; background: transparent; cursor: pointer;
  color: var(--text-light); font-size: 1rem;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.15s, color 0.15s;
}
.header-btn:hover { background: var(--lavender-light); color: var(--text-dark); }

/* â”€â”€â”€ MESSAGES â”€â”€â”€ */
#messages-area {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
  scroll-behavior: smooth;
}
#messages-area::-webkit-scrollbar { width: 4px; }
#messages-area::-webkit-scrollbar-thumb { background: var(--lavender-light); border-radius: 2px; }

.msg-group { display: flex; flex-direction: column; gap: 0.22rem; margin-bottom: 0.6rem; }
.msg-group.user { align-items: flex-end; }
.msg-group.ai { align-items: flex-start; }

.msg-row {
  display: flex;
  align-items: flex-end;
  gap: 0.5rem;
  max-width: 78%;
}
.msg-group.user .msg-row { flex-direction: row-reverse; }
.msg-group.ai .msg-row { }

.msg-avatar {
  width: 30px; height: 30px; border-radius: 10px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 0.9rem; flex-shrink: 0; overflow: hidden;
}
.msg-avatar img { width: 100%; height: 100%; object-fit: cover; }
.msg-avatar-spacer { width: 30px; flex-shrink: 0; }

.msg-bubble {
  padding: 0.65rem 0.95rem;
  border-radius: 18px;
  font-size: 0.9rem;
  line-height: 1.55;
  max-width: 100%;
  word-break: break-word;
  position: relative;
  animation: bubblePop 0.2s cubic-bezier(0.34,1.56,0.64,1);
}

@keyframes bubblePop {
  from { transform: scale(0.85); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.msg-group.ai .msg-bubble {
  background: var(--bubble-ai);
  color: var(--text-dark);
  border-radius: 4px 18px 18px 18px;
  box-shadow: 0 2px 8px var(--shadow);
  border: 1px solid rgba(201,184,232,0.15);
}

.msg-group.user .msg-bubble {
  background: var(--bubble-user);
  color: white;
  border-radius: 18px 18px 4px 18px;
  box-shadow: 0 2px 8px rgba(180,160,220,0.3);
}

/* only first bubble in group shows avatar */
.msg-group .msg-row:not(:first-child) .msg-avatar { visibility: hidden; }

.msg-time {
  font-size: 0.65rem;
  color: var(--text-light);
  padding: 0 0.3rem;
  margin-bottom: 0.15rem;
}

.msg-status { font-size: 0.65rem; color: var(--milk-blue); }

.date-divider {
  display: flex; align-items: center; gap: 0.8rem;
  margin: 1rem 0 0.5rem;
}
.date-divider::before, .date-divider::after {
  content: ''; flex: 1;
  height: 1px; background: rgba(201,184,232,0.3);
}
.date-divider span {
  font-size: 0.7rem; color: var(--text-light);
  background: rgba(201,184,232,0.15);
  padding: 0.2rem 0.7rem;
  border-radius: 10px;
}

/* IMAGE MESSAGES */
.msg-image {
  max-width: 220px; border-radius: 14px;
  overflow: hidden; cursor: pointer;
}
.msg-image img { width: 100%; display: block; }

/* STICKER / EMOTE */
.msg-sticker {
  font-size: 0.82rem;
  color: var(--text-mid);
  font-style: italic;
  padding: 0.4rem 0.8rem;
  background: rgba(201,184,232,0.15);
  border-radius: 12px;
  border: 1px solid rgba(201,184,232,0.25);
}

/* TYPING INDICATOR */
.typing-indicator {
  display: flex; gap: 5px; align-items: center;
  padding: 0.7rem 1rem;
}
.typing-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--lavender);
  animation: typingPulse 1.2s ease infinite;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingPulse {
  0%, 80%, 100% { transform: scale(0.7); opacity: 0.5; }
  40% { transform: scale(1); opacity: 1; }
}

/* â”€â”€â”€ INPUT AREA â”€â”€â”€ */
#input-area {
  padding: 0.8rem 1rem;
  background: var(--header-bg);
  backdrop-filter: blur(12px);
  border-top: 1px solid rgba(201,184,232,0.2);
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  flex-shrink: 0;
}

.input-toolbar {
  display: flex;
  gap: 0.3rem;
}
.toolbar-btn {
  width: 32px; height: 32px; border-radius: 9px;
  border: none; background: transparent; cursor: pointer;
  color: var(--text-light); font-size: 0.95rem;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.toolbar-btn:hover { background: var(--lavender-light); color: var(--text-dark); }
.toolbar-btn.active { background: var(--lavender); color: white; }

.input-row {
  display: flex; align-items: flex-end; gap: 0.7rem;
}

#msg-input {
  flex: 1;
  min-height: 42px; max-height: 120px;
  padding: 0.65rem 1rem;
  border: 1.5px solid rgba(201,184,232,0.3);
  border-radius: 20px;
  background: rgba(255,255,255,0.8);
  font-family: inherit;
  font-size: 0.9rem;
  color: var(--text-dark);
  outline: none;
  resize: none;
  line-height: 1.5;
  transition: border-color 0.2s, box-shadow 0.2s;
}
#msg-input:focus {
  border-color: var(--lavender);
  box-shadow: 0 0 0 3px rgba(201,184,232,0.15);
}
#msg-input::placeholder { color: var(--text-light); }

#send-btn {
  width: 42px; height: 42px;
  border-radius: 14px;
  border: none;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  color: white;
  font-size: 1rem;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: transform 0.15s, box-shadow 0.15s;
  flex-shrink: 0;
}
#send-btn:hover { transform: scale(1.08); box-shadow: 0 4px 12px rgba(180,160,220,0.4); }
#send-btn:active { transform: scale(0.95); }

/* â”€â”€â”€ PAGES â”€â”€â”€ */
.page { display: none; flex: 1; flex-direction: column; overflow: hidden; }
.page.active { display: flex; }

/* â”€â”€â”€ CHARACTERS PAGE â”€â”€â”€ */
#chars-grid {
  flex: 1; overflow-y: auto;
  padding: 1.2rem;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 1rem;
  align-content: start;
}

.char-card {
  background: rgba(255,255,255,0.85);
  border-radius: 20px;
  padding: 1.2rem 0.9rem;
  text-align: center;
  cursor: pointer;
  box-shadow: 0 2px 12px var(--shadow);
  border: 1.5px solid rgba(201,184,232,0.15);
  transition: transform 0.2s, box-shadow 0.2s;
}
.char-card:hover { transform: translateY(-3px); box-shadow: 0 6px 24px var(--shadow); }

.char-card-avatar {
  width: 72px; height: 72px; border-radius: 22px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 2rem; margin: 0 auto 0.8rem;
  overflow: hidden;
}
.char-card-avatar img { width: 100%; height: 100%; object-fit: cover; }
.char-card-name { font-size: 0.88rem; font-weight: 500; color: var(--text-dark); }
.char-card-desc { font-size: 0.73rem; color: var(--text-light); margin-top: 0.2rem; }

.char-add-card {
  border: 2px dashed rgba(201,184,232,0.4);
  background: rgba(201,184,232,0.06);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 0.5rem;
  color: var(--text-light);
  font-size: 0.82rem;
  cursor: pointer;
  border-radius: 20px;
  min-height: 130px;
  transition: all 0.2s;
}
.char-add-card:hover { border-color: var(--lavender); color: var(--text-mid); background: rgba(201,184,232,0.1); }

/* â”€â”€â”€ SOCIAL PAGE â”€â”€â”€ */
#social-page { background: var(--beige-soft); }

.social-tabs {
  display: flex;
  padding: 0 1rem;
  gap: 0.5rem;
  border-bottom: 1px solid rgba(201,184,232,0.2);
  background: var(--header-bg);
  flex-shrink: 0;
}
.social-tab {
  padding: 0.9rem 1.2rem;
  border: none; background: none;
  font-family: inherit; font-size: 0.88rem;
  color: var(--text-light); cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}
.social-tab.active { color: var(--lavender); border-bottom-color: var(--lavender); font-weight: 500; }

.social-feed { flex: 1; overflow-y: auto; padding: 1rem; }

.post-card {
  background: rgba(255,255,255,0.88);
  border-radius: 20px;
  padding: 1.2rem;
  margin-bottom: 1rem;
  box-shadow: 0 2px 10px var(--shadow);
  border: 1px solid rgba(201,184,232,0.12);
}
.post-header { display: flex; align-items: center; gap: 0.7rem; margin-bottom: 0.8rem; }
.post-avatar {
  width: 38px; height: 38px; border-radius: 12px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 1.1rem; overflow: hidden;
}
.post-avatar img { width: 100%; height: 100%; object-fit: cover; }
.post-author { font-size: 0.88rem; font-weight: 500; color: var(--text-dark); }
.post-time { font-size: 0.72rem; color: var(--text-light); }
.post-content { font-size: 0.88rem; color: var(--text-dark); line-height: 1.6; }
.post-image { margin-top: 0.8rem; border-radius: 14px; overflow: hidden; }
.post-image img { width: 100%; display: block; }
.post-actions {
  display: flex; gap: 1rem; margin-top: 0.8rem;
  padding-top: 0.8rem;
  border-top: 1px solid rgba(201,184,232,0.15);
}
.post-action-btn {
  background: none; border: none; cursor: pointer;
  font-size: 0.8rem; color: var(--text-light); font-family: inherit;
  display: flex; align-items: center; gap: 0.3rem;
  transition: color 0.15s;
}
.post-action-btn:hover { color: var(--lavender); }

.post-comments { margin-top: 0.7rem; display: flex; flex-direction: column; gap: 0.5rem; }
.comment-item {
  display: flex; gap: 0.6rem; align-items: flex-start;
}
.comment-avatar {
  width: 28px; height: 28px; border-radius: 9px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 0.8rem; flex-shrink: 0;
}
.comment-bubble {
  background: var(--lavender-soft);
  border-radius: 4px 14px 14px 14px;
  padding: 0.5rem 0.8rem;
  font-size: 0.82rem; color: var(--text-dark);
  line-height: 1.5;
}
.comment-name { font-weight: 500; font-size: 0.75rem; color: var(--lavender); margin-bottom: 0.1rem; }

.post-compose {
  background: rgba(255,255,255,0.88);
  border-radius: 20px;
  padding: 1rem;
  margin-bottom: 1rem;
  box-shadow: 0 2px 10px var(--shadow);
  border: 1px solid rgba(201,184,232,0.12);
}
.compose-input {
  width: 100%; min-height: 70px;
  border: none; outline: none; resize: none;
  font-family: inherit; font-size: 0.88rem;
  color: var(--text-dark); background: transparent;
  line-height: 1.6;
}
.compose-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 0.6rem; }
.compose-char-select {
  padding: 0.4rem 0.7rem;
  border: 1px solid var(--lavender-light);
  border-radius: 10px;
  font-family: inherit; font-size: 0.78rem;
  color: var(--text-mid);
  background: var(--lavender-soft);
  outline: none;
}
.compose-post-btn {
  padding: 0.45rem 1.1rem;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  border: none; border-radius: 12px;
  color: white; font-family: inherit;
  font-size: 0.82rem; cursor: pointer;
}

/* PLURK style */
.plurk-timeline {
  position: relative;
  padding-left: 1.5rem;
}
.plurk-timeline::before {
  content: '';
  position: absolute; left: 0.4rem; top: 0; bottom: 0;
  width: 2px; background: linear-gradient(to bottom, var(--lavender-light), transparent);
  border-radius: 1px;
}
.plurk-item {
  position: relative;
  margin-bottom: 1rem;
}
.plurk-dot {
  position: absolute; left: -1.15rem; top: 0.8rem;
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--lavender);
  border: 2px solid white;
  box-shadow: 0 0 0 2px rgba(201,184,232,0.3);
}

/* â”€â”€â”€ DIARY PAGE â”€â”€â”€ */
#diary-page { background: var(--beige-soft); }

.diary-header {
  padding: 1rem 1.2rem;
  background: var(--header-bg);
  border-bottom: 1px solid rgba(201,184,232,0.2);
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0;
}
.diary-month {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.3rem; font-weight: 300;
  color: var(--text-dark); font-style: italic;
}
.diary-nav-btn {
  width: 32px; height: 32px; border-radius: 10px;
  border: none; background: transparent; cursor: pointer;
  color: var(--text-light); font-size: 1rem;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.diary-nav-btn:hover { background: var(--lavender-light); color: var(--text-dark); }

.diary-calendar {
  display: grid; grid-template-columns: repeat(7, 1fr);
  padding: 0.8rem 1rem;
  gap: 0.3rem;
  border-bottom: 1px solid rgba(201,184,232,0.15);
  flex-shrink: 0;
}
.cal-day-name {
  text-align: center; font-size: 0.7rem;
  color: var(--text-light); padding: 0.2rem;
}
.cal-day {
  text-align: center; padding: 0.4rem;
  border-radius: 10px; font-size: 0.82rem;
  color: var(--text-mid); cursor: pointer;
  transition: all 0.15s; position: relative;
}
.cal-day:hover { background: var(--lavender-light); }
.cal-day.today { background: var(--lavender); color: white; font-weight: 500; }
.cal-day.has-entry::after {
  content: ''; position: absolute;
  bottom: 3px; left: 50%; transform: translateX(-50%);
  width: 4px; height: 4px; border-radius: 50%;
  background: var(--milk-blue);
}
.cal-day.selected { background: var(--lavender-soft); border: 1.5px solid var(--lavender); }

.diary-content { flex: 1; overflow-y: auto; padding: 1.2rem; }
.diary-entry {
  background: rgba(255,255,255,0.88);
  border-radius: 20px;
  padding: 1.5rem;
  box-shadow: 0 2px 12px var(--shadow);
  border: 1px solid rgba(201,184,232,0.15);
}
.diary-entry-date {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.1rem; font-style: italic;
  color: var(--text-mid); margin-bottom: 0.8rem;
}
.diary-entry-char {
  display: flex; align-items: center; gap: 0.6rem;
  margin-bottom: 1rem; padding-bottom: 0.8rem;
  border-bottom: 1px solid rgba(201,184,232,0.15);
}
.diary-char-avatar {
  width: 32px; height: 32px; border-radius: 10px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 0.9rem; overflow: hidden;
}
.diary-char-avatar img { width: 100%; height: 100%; object-fit: cover; }
.diary-char-name { font-size: 0.82rem; font-weight: 500; color: var(--lavender); }
.diary-entry-text {
  font-size: 0.88rem; color: var(--text-dark);
  line-height: 1.8; white-space: pre-wrap;
}
.diary-empty {
  text-align: center; color: var(--text-light);
  font-size: 0.88rem; padding: 3rem 1rem;
  font-style: italic;
}

/* Diary style picker buttons */
.diary-style-btn {
  padding: 0.35rem 0.8rem;
  border-radius: 20px;
  border: 1.5px solid var(--lavender-light);
  background: var(--lavender-soft);
  font-family: inherit;
  font-size: 0.75rem;
  color: var(--text-mid);
  cursor: pointer;
  transition: all 0.15s;
}
.diary-style-btn:hover { border-color: var(--lavender); color: var(--text-dark); }
.diary-style-btn.active {
  background: var(--lavender);
  border-color: var(--lavender);
  color: white;
  font-weight: 500;
}

/* â”€â”€â”€ SPELL STAGE PAGEï¼ˆå’’èªèˆå°ï¼ŒåŸ CCTVï¼‰ â”€â”€â”€ */
#cctv-page {
  background: var(--beige-soft);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

#spell-stage-messages::-webkit-scrollbar { width: 4px; }
#spell-stage-messages::-webkit-scrollbar-thumb { background: var(--lavender-light); border-radius: 2px; }

/* cctv legacy styles removed */

.cctv-char-select-row {
  padding: 0.6rem 1rem;
  display: flex; gap: 0.5rem; overflow-x: auto;
  border-bottom: 1px solid rgba(201,184,232,0.08);
  flex-shrink: 0;
}
.cctv-char-chip {
  display: flex; align-items: center; gap: 0.4rem;
  padding: 0.35rem 0.8rem;
  border-radius: 20px;
  background: rgba(201,184,232,0.1);
  border: 1px solid rgba(201,184,232,0.2);
  cursor: pointer; white-space: nowrap;
  font-size: 0.78rem; color: rgba(201,184,232,0.6);
  transition: all 0.15s;
}
.cctv-char-chip.active {
  background: rgba(201,184,232,0.2);
  border-color: var(--lavender);
  color: var(--lavender);
}
.cctv-chip-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(168,216,168,0.8); }

.cctv-content { flex: 1; overflow-y: auto; padding: 1rem; }

.cctv-screen {
  background: rgba(255,255,255,0.04);
  border-radius: 18px;
  border: 1px solid rgba(201,184,232,0.1);
  overflow: hidden;
  margin-bottom: 1rem;
}
.cctv-screen-header {
  padding: 0.6rem 1rem;
  background: rgba(201,184,232,0.08);
  display: flex; align-items: center; justify-content: space-between;
}
.cctv-cam-label {
  font-size: 0.72rem; color: rgba(201,184,232,0.5);
  letter-spacing: 0.08em;
}
.cctv-timestamp {
  font-size: 0.68rem; color: rgba(232,160,184,0.5);
  font-family: monospace;
}
.cctv-screen-body { padding: 1rem; }
.cctv-activity-list { display: flex; flex-direction: column; gap: 0.6rem; }
.cctv-activity-item {
  display: flex; align-items: flex-start; gap: 0.6rem;
}
.cctv-act-time {
  font-size: 0.72rem; color: rgba(201,184,232,0.4);
  font-family: monospace; white-space: nowrap;
  padding-top: 0.1rem;
}
.cctv-act-text {
  font-size: 0.82rem; color: rgba(201,184,232,0.75);
  line-height: 1.5;
}

/* â”€â”€â”€ LOREBOOK (SillyTavern Style) â”€â”€â”€ */
.lb-entry {
  border: 1.5px solid rgba(201,184,232,0.22);
  border-radius: 14px;
  overflow: hidden;
  background: white;
  transition: box-shadow 0.2s, border-color 0.2s;
}
.lb-entry:hover { box-shadow: 0 2px 12px rgba(180,160,210,0.13); }
.lb-entry.lb-open {
  border-color: var(--lavender);
  box-shadow: 0 4px 20px rgba(180,160,210,0.18);
}

.lb-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.6rem 0.85rem;
  cursor: pointer;
  background: var(--lavender-soft);
  user-select: none;
  gap: 0.5rem;
  transition: background 0.15s;
}
.lb-entry.lb-open .lb-header { background: rgba(201,184,232,0.2); border-bottom: 1px solid rgba(201,184,232,0.2); }
.lb-header:hover { background: rgba(201,184,232,0.18); }

.lb-entry-left { display: flex; align-items: center; gap: 0.5rem; min-width: 0; flex: 1; }
.lb-entry-right { display: flex; align-items: center; gap: 0.45rem; flex-shrink: 0; }

/* Enable toggle (nice visual switch) */
.lb-toggle {
  width: 28px; height: 16px;
  border-radius: 8px;
  border: none;
  background: var(--lavender-light);
  position: relative;
  cursor: pointer;
  flex-shrink: 0;
  transition: background 0.2s;
  padding: 0;
}
.lb-toggle.on { background: var(--lavender); }
.lb-toggle::after {
  content: '';
  position: absolute; top: 2px; left: 2px;
  width: 12px; height: 12px;
  border-radius: 50%; background: white;
  transition: transform 0.2s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.lb-toggle.on::after { transform: translateX(12px); }

.lb-badge { font-size: 0.63rem; padding: 0.12rem 0.4rem; border-radius: 6px; font-weight: 700; letter-spacing: 0.03em; }
.lb-const { background: rgba(168,216,168,0.35); color: #3d7a3d; }
.lb-sel   { background: rgba(184,212,232,0.45); color: #3d6080; }

.lb-name { font-size: 0.84rem; color: var(--text-dark); font-weight: 600;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
.lb-keys-preview { font-size: 0.7rem; color: var(--text-light); max-width: 120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.lb-order { font-size: 0.65rem; color: var(--lavender); font-family: monospace;
  background: rgba(201,184,232,0.25); padding: 0.1rem 0.4rem; border-radius: 5px; }
.lb-del-btn { background: none; border: none; cursor: pointer; color: rgba(200,136,136,0.7);
  font-size: 1rem; line-height: 1; padding: 0.1rem 0.2rem; border-radius: 6px; transition: all 0.15s; }
.lb-del-btn:hover { color: #e87878; background: rgba(232,120,120,0.08); }

.lb-body {
  padding: 1rem 1.1rem 0.9rem;
  border-top: none;
  display: flex; flex-direction: column; gap: 0.75rem;
  background: linear-gradient(to bottom, rgba(243,239,249,0.3), white);
}

.lb-row-2col { display: flex; gap: 0.65rem; }
.lb-row-flags { display: flex; gap: 0.6rem; flex-wrap: wrap; align-items: flex-end; }
.lb-field { display: flex; flex-direction: column; gap: 0.28rem; flex: 1; }
.lb-label {
  font-size: 0.69rem; color: var(--text-light); font-weight: 600;
  letter-spacing: 0.06em; text-transform: uppercase;
}
.lb-input {
  padding: 0.5rem 0.75rem;
  border: 1.5px solid var(--lavender-light);
  border-radius: 10px;
  font-family: inherit; font-size: 0.83rem;
  color: var(--text-dark); background: var(--lavender-soft);
  outline: none; width: 100%;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.lb-input:focus { border-color: var(--lavender); box-shadow: 0 0 0 3px rgba(201,184,232,0.15); }
.lb-select {
  padding: 0.5rem 0.75rem;
  border: 1.5px solid var(--lavender-light);
  border-radius: 10px;
  font-family: inherit; font-size: 0.83rem;
  color: var(--text-dark); background: var(--lavender-soft);
  outline: none; width: 100%;
  transition: border-color 0.15s;
}
.lb-select:focus { border-color: var(--lavender); }
.lb-textarea {
  padding: 0.6rem 0.85rem;
  border: 1.5px solid var(--lavender-light);
  border-radius: 10px;
  font-family: inherit; font-size: 0.83rem;
  color: var(--text-dark); background: var(--lavender-soft);
  outline: none; resize: vertical; min-height: 100px; line-height: 1.6; width: 100%;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.lb-textarea:focus { border-color: var(--lavender); box-shadow: 0 0 0 3px rgba(201,184,232,0.15); }

/* Flags section */
.lb-flags-group {
  display: flex; flex-wrap: wrap; gap: 0.5rem;
  padding: 0.65rem 0.8rem;
  background: rgba(201,184,232,0.07);
  border-radius: 10px;
  border: 1px solid rgba(201,184,232,0.15);
}
.lb-checkbox-label {
  display: flex; align-items: center; gap: 0.4rem;
  font-size: 0.76rem; color: var(--text-mid); cursor: pointer; white-space: nowrap;
  padding: 0.2rem 0.5rem;
  border-radius: 8px;
  transition: background 0.15s;
}
.lb-checkbox-label:hover { background: rgba(201,184,232,0.2); }
.lb-checkbox-label input { accent-color: var(--lavender); cursor: pointer; }

.lb-save-btn {
  flex: 1; padding: 0.6rem; background: linear-gradient(135deg,var(--lavender),var(--milk-blue));
  border: none; border-radius: 11px; color: white;
  font-family: inherit; font-size: 0.85rem; cursor: pointer; font-weight: 500;
  transition: opacity 0.15s, transform 0.15s;
}
.lb-save-btn:hover { opacity: 0.9; transform: translateY(-1px); }
.lb-cancel-btn {
  padding: 0.6rem 1rem;
  background: var(--lavender-soft); border: 1.5px solid var(--lavender-light);
  border-radius: 11px; color: var(--text-mid);
  font-family: inherit; font-size: 0.85rem; cursor: pointer;
  transition: background 0.15s;
}
.lb-cancel-btn:hover { background: rgba(201,184,232,0.2); }

/* ST info bar inside lorebook */
.lb-st-info {
  display: flex; gap: 0.5rem; align-items: center;
  padding: 0.5rem 0.7rem;
  background: rgba(201,184,232,0.1);
  border-radius: 8px;
  font-size: 0.7rem; color: var(--text-light);
  border: 1px dashed rgba(201,184,232,0.3);
}

/* Lorebook modal count badge */
#lb-count {
  background: rgba(201,184,232,0.2);
  border-radius: 20px;
  padding: 0.15rem 0.6rem;
  font-size: 0.72rem;
  color: var(--lavender);
  font-weight: 500;
}

/* â”€â”€â”€ SETTINGS PAGE â”€â”€â”€ */
#settings-page { background: var(--beige-soft); overflow-y: auto; }

.settings-section {
  padding: 1.2rem;
  border-bottom: 1px solid rgba(201,184,232,0.12);
}
.settings-section-title {
  font-size: 0.72rem; color: var(--text-light);
  letter-spacing: 0.12em; text-transform: uppercase;
  margin-bottom: 0.8rem;
}
.settings-item {
  background: rgba(255,255,255,0.85);
  border-radius: 14px;
  padding: 0.9rem 1rem;
  margin-bottom: 0.5rem;
  display: flex; align-items: center; gap: 0.8rem;
  cursor: pointer;
  border: 1px solid rgba(201,184,232,0.1);
  transition: background 0.15s;
}
.settings-item:hover { background: rgba(255,255,255,0.95); }
.settings-item-icon { width: 32px; height: 32px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
.settings-item-label { flex: 1; font-size: 0.88rem; color: var(--text-dark); }
.settings-item-value { font-size: 0.78rem; color: var(--text-light); }
.settings-item-arrow { color: var(--text-light); font-size: 0.8rem; }

.toggle-switch {
  width: 42px; height: 24px;
  background: var(--lavender-light);
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: background 0.2s;
}
.toggle-switch.on { background: var(--lavender); }
.toggle-switch::after {
  content: '';
  position: absolute; top: 3px; left: 3px;
  width: 18px; height: 18px;
  border-radius: 50%; background: white;
  transition: transform 0.2s;
  box-shadow: 0 1px 4px rgba(0,0,0,0.15);
}
.toggle-switch.on::after { transform: translateX(18px); }

/* â”€â”€â”€ MODALS â”€â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(61,52,80,0.4);
  backdrop-filter: blur(8px);
  z-index: 800;
  display: none; align-items: center; justify-content: center;
  padding: 1rem;
}
.modal-overlay.open { display: flex; }

.modal {
  background: white;
  border-radius: 24px;
  padding: 1.8rem;
  width: min(480px, 96vw);
  max-height: 90dvh;
  overflow-y: auto;
  box-shadow: 0 12px 48px var(--shadow-deep);
  animation: modalIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes modalIn {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
.modal-title { font-size: 1.1rem; font-weight: 700; color: var(--text-dark); margin-bottom: 1.2rem; }
.modal-field { margin-bottom: 1rem; }
.modal-label { display: block; font-size: 0.78rem; color: var(--text-mid); margin-bottom: 0.4rem; }
.modal-input, .modal-select, .modal-textarea {
  width: 100%; padding: 0.75rem 1rem;
  border: 1.5px solid var(--lavender-light);
  border-radius: 12px;
  font-family: inherit; font-size: 0.88rem;
  color: var(--text-dark);
  background: var(--lavender-soft);
  outline: none;
}
.modal-textarea { min-height: 90px; resize: vertical; }
.modal-actions { display: flex; gap: 0.5rem; margin-top: 1.2rem; }
.modal-btn {
  flex: 1; padding: 0.8rem;
  border-radius: 14px; border: none;
  font-family: inherit; font-size: 0.88rem;
  cursor: pointer; transition: all 0.15s;
}
.modal-btn.primary {
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  color: white;
}
.modal-btn.secondary {
  background: var(--lavender-soft);
  color: var(--text-mid);
  border: 1px solid var(--lavender-light);
}
.modal-btn:hover { opacity: 0.9; }

/* TABS inside modal */
.modal-tabs { display: flex; gap: 0.3rem; margin-bottom: 1rem; }
.modal-tab {
  flex: 1; padding: 0.5rem;
  border-radius: 10px; border: none;
  font-family: inherit; font-size: 0.78rem;
  cursor: pointer; transition: all 0.15s;
  background: var(--lavender-soft);
  color: var(--text-light);
}
.modal-tab.active {
  background: var(--lavender);
  color: white;
}
.modal-tab-content { display: none; }
.modal-tab-content.active { display: block; }

/* â”€â”€â”€ MEMORY PANEL â”€â”€â”€ */
#memory-panel {
  width: 260px;
  background: rgba(243,239,249,0.95);
  border-left: 1px solid rgba(201,184,232,0.2);
  display: none;
  flex-direction: column;
  flex-shrink: 0;
}
#memory-panel.open { display: flex; }

.memory-header {
  padding: 1rem 1rem 0.8rem;
  border-bottom: 1px solid rgba(201,184,232,0.15);
}
.memory-title { font-size: 0.88rem; font-weight: 500; color: var(--text-dark); }
.memory-list { flex: 1; overflow-y: auto; padding: 0.8rem; }
.memory-category {
  margin-bottom: 1rem;
}
.memory-cat-title {
  font-size: 0.68rem; color: var(--text-light);
  letter-spacing: 0.1em; text-transform: uppercase;
  margin-bottom: 0.4rem;
}
.memory-item {
  background: rgba(255,255,255,0.8);
  border-radius: 10px;
  padding: 0.5rem 0.7rem;
  margin-bottom: 0.35rem;
  font-size: 0.78rem;
  color: var(--text-dark);
  line-height: 1.4;
  border: 1px solid rgba(201,184,232,0.1);
  position: relative;
}
.memory-item .del-mem {
  position: absolute; right: 0.4rem; top: 0.3rem;
  font-size: 0.65rem; color: var(--text-light);
  cursor: pointer;
}
.memory-item .del-mem:hover { color: #e8a0b8; }

.memory-add-btn {
  margin: 0 0.8rem 0.8rem;
  padding: 0.5rem;
  background: rgba(201,184,232,0.15);
  border: 1.5px dashed rgba(201,184,232,0.35);
  border-radius: 10px;
  font-family: inherit; font-size: 0.78rem;
  color: var(--text-light); cursor: pointer;
  transition: all 0.2s;
}
.memory-add-btn:hover { background: rgba(201,184,232,0.25); color: var(--text-mid); }

/* â”€â”€â”€ EMPTY STATE â”€â”€â”€ */
.empty-state {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 1rem; color: var(--text-light);
  padding: 2rem;
}
.empty-state-icon { font-size: 3rem; opacity: 0.4; }
.empty-state-text { font-size: 0.88rem; text-align: center; line-height: 1.6; }
.empty-state-sub { font-size: 0.78rem; opacity: 0.7; }

/* â”€â”€â”€ CONTEXT MENU â”€â”€â”€ */
.ctx-menu {
  position: fixed;
  background: white;
  border-radius: 14px;
  box-shadow: 0 8px 32px var(--shadow), 0 2px 8px var(--shadow-deep);
  border: 1px solid rgba(201,184,232,0.2);
  z-index: 900;
  overflow: hidden;
  min-width: 160px;
  animation: ctxIn 0.15s ease;
  display: none;
}
.ctx-menu.open { display: block; }
@keyframes ctxIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.ctx-item {
  padding: 0.65rem 1rem;
  font-size: 0.85rem; color: var(--text-dark);
  cursor: pointer; transition: background 0.1s;
  display: flex; align-items: center; gap: 0.5rem;
}
.ctx-item:hover { background: var(--lavender-soft); }
.ctx-item.danger { color: #e87878; }
.ctx-divider { height: 1px; background: rgba(201,184,232,0.2); margin: 0.2rem 0; }

/* â”€â”€â”€ TOAST â”€â”€â”€ */
.toast {
  position: fixed;
  bottom: calc(env(safe-area-inset-bottom) + 80px);
  left: 50%; transform: translateX(-50%) translateY(20px);
  background: rgba(61,52,80,0.9);
  color: white; font-size: 0.82rem;
  padding: 0.6rem 1.2rem; border-radius: 20px;
  opacity: 0; transition: all 0.3s;
  z-index: 1000; white-space: nowrap;
  pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* â”€â”€â”€ BOTTOM NAV (Mobile) â”€â”€â”€ */
#bottom-nav {
  display: none;
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--header-bg);
  backdrop-filter: blur(12px);
  border-top: 1px solid rgba(201,184,232,0.2);
  padding: 0.5rem 0 calc(0.5rem + env(safe-area-inset-bottom));
  z-index: 200;
  justify-content: space-around;
}
.bottom-nav-btn {
  display: flex; flex-direction: column; align-items: center; gap: 0.2rem;
  background: none; border: none; cursor: pointer;
  padding: 0.3rem 0.6rem;
  color: var(--text-light); font-size: 0.62rem;
  transition: color 0.15s;
}
.bottom-nav-btn .icon { font-size: 1.3rem; }
.bottom-nav-btn.active { color: var(--lavender); }

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
@media (max-width: 768px) {
  #side-nav { display: none; }
  #sidebar {
    position: fixed; inset: 0 0 60px 0;
    width: 100%; z-index: 150;
    transform: translateX(-100%);
    transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
  }
  #sidebar.mobile-open { transform: translateX(0); }
  #bottom-nav { display: flex; }
  #main-area { padding-bottom: 60px; }
  #memory-panel { position: fixed; inset: 0; z-index: 300; width: 100%; }
  .page { padding-bottom: 0; }
}

@media (min-width: 769px) {
  #app { }
}

/* Scrollbar global */
* { scrollbar-width: thin; scrollbar-color: rgba(201,184,232,0.3) transparent; }
</style>
</head>
<body>

<!-- SETUP SCREEN -->
<div id="setup-screen">
  <div class="setup-card">
    <div class="setup-logo">erhabene</div>
    <div class="setup-tagline">your intimate ai companion</div>
    
    <div class="setup-field">
      <label class="setup-label">ğŸ”‘ Google AI API Key</label>
      <input class="setup-input" type="password" id="api-key-input" placeholder="AIza..." autocomplete="off">
    </div>
    
    <div class="setup-field">
      <label class="setup-label">ğŸ¤– æ¨¡å‹åç¨±ï¼ˆå¯è‡ªè¡Œè¼¸å…¥ï¼‰</label>
      <input class="setup-input" type="text" id="model-custom-input-setup"
        placeholder="ä¾‹ï¼šgemini-3-flash-preview"
        list="model-datalist-setup"
        value="gemini-3-flash-preview">
      <datalist id="model-datalist-setup">
        <option value="gemini-3-flash-preview">Gemini 3 Flash Previewï¼ˆæœ€æ–°ï¼‰</option>
        <option value="gemini-3-pro-preview">Gemini 3 Pro Previewï¼ˆæœ€æ–°ï¼‰</option>
        <option value="gemini-3-flash-exp">Gemini 3 Flash Exp</option>
        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
      </datalist>
      <div style="font-size:0.72rem;color:var(--text-light);margin-top:0.4rem;">ç›´æ¥è¼¸å…¥ API æ¨¡å‹ IDï¼Œæˆ–å¾ä¸‹æ‹‰æ¸…å–®é¸æ“‡</div>
    </div>
    <!-- hidden select for backward compat -->
    <select id="model-select" style="display:none">
      <option value="gemini-3-flash-preview">Gemini 3 Flash Preview</option>
    </select>
    
    <button class="setup-btn" onclick="enterApp()">é€²å…¥ erhabene âœ¦</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none;">
  
  <!-- Side Nav -->
  <nav id="side-nav">
    <div class="nav-logo">e</div>
    <button class="nav-btn active" onclick="switchPage('chat')" title="èŠå¤©" id="nav-chat">ğŸ’¬</button>
    <button class="nav-btn" onclick="switchPage('chars')" title="è§’è‰²" id="nav-chars">ğŸŒ¸</button>
    <button class="nav-btn" onclick="switchPage('social')" title="ç¤¾ç¾¤" id="nav-social">âœ¦</button>
    <button class="nav-btn" onclick="switchPage('diary')" title="æ—¥è¨˜" id="nav-diary">ğŸ“”</button>
    <button class="nav-btn" onclick="switchPage('cctv')" title="å’’èªèˆå°" id="nav-cctv">âœ¨</button>
    <div class="nav-spacer"></div>
    <button class="nav-btn" onclick="openModal('memory-modal')" title="é•·æœŸè¨˜æ†¶">ğŸ§ </button>
    <button class="nav-btn" onclick="openModal('lorebook-modal')" title="Lorebook">ğŸ“š</button>
    <button class="nav-btn" onclick="switchPage('settings')" title="è¨­å®š" id="nav-settings">âš™ï¸</button>
  </nav>

  <!-- Sidebar -->
  <aside id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title" id="sidebar-title">èŠå¤©</div>
      <div class="sidebar-search">
        <span>ğŸ”</span>
        <input placeholder="æœå°‹..." id="sidebar-search-input">
      </div>
    </div>
    <div class="sidebar-list" id="sidebar-list"></div>
    <button class="add-chat-btn" id="sidebar-add-btn" onclick="showAddChatOrChar()">ï¼‹ æ–°å¢å°è©±</button>
  </aside>

  <!-- Main Area -->
  <div id="main-area">
    
    <!-- CHAT PAGE -->
    <div class="page active" id="chat-page">
      <div id="chat-header" style="display:none;">
        <div class="header-avatar" id="header-avatar">ğŸŒ¸</div>
        <div class="header-info">
          <div class="header-name" id="header-name">é¸æ“‡è§’è‰²</div>
          <div class="header-status" id="header-status">â€” é»æ“Šè§’è‰²é–‹å§‹èŠå¤© â€”</div>
        </div>
        <div class="header-actions">
          <button class="header-btn" onclick="toggleMemoryPanel()" title="è¨˜æ†¶">ğŸ§ </button>
          <button class="header-btn" onclick="openModal('char-info-modal')" title="è§’è‰²è³‡è¨Š">ğŸ‘¤</button>
          <button class="header-btn" onclick="openChatOptions()" title="æ›´å¤š">â‹¯</button>
        </div>
      </div>
      
      <div id="messages-area">
        <div class="empty-state" id="empty-chat">
          <div class="empty-state-icon">ğŸŒ¸</div>
          <div class="empty-state-text">erhabene</div>
          <div class="empty-state-sub">é¸æ“‡ä¸€å€‹è§’è‰²é–‹å§‹å°è©±ï¼Œ<br>æˆ–æ–°å¢ä½ çš„ç¬¬ä¸€å€‹è§’è‰²å¡</div>
        </div>
      </div>
      
      <div id="input-area" style="display:none;">
        <div class="input-toolbar">
          <button class="toolbar-btn" onclick="triggerImageGen()" title="ç”Ÿæˆåœ–ç‰‡">ğŸ–¼ï¸</button>
          <button class="toolbar-btn" onclick="openStickerPicker()" title="(è¡¨æƒ…)">ğŸ­</button>
          <button class="toolbar-btn" onclick="openModal('preset-modal')" title="Preset">ğŸ“‹</button>
          <button class="toolbar-btn" id="memory-toggle-btn" onclick="toggleMemoryPanel()" title="è¨˜æ†¶">ğŸ§ </button>
          <button class="toolbar-btn" onclick="triggerAutoMsgNow()" title="è®“è§’è‰²ç«‹åˆ»å‚³è¨Šæ¯" style="margin-left:auto;">ğŸ’¬âœ¨</button>
        </div>
        <div class="input-row">
          <textarea id="msg-input" placeholder="å‚³è¨Šæ¯..." rows="1"
            onkeydown="handleInputKey(event)"
            oninput="autoResize(this)"></textarea>
          <button id="send-btn" onclick="sendMessage()">â¤</button>
        </div>
      </div>
    </div>

    <!-- CHARACTERS PAGE -->
    <div class="page" id="chars-page">
      <div id="chat-header" style="padding:1rem 1.2rem; border-bottom:1px solid rgba(201,184,232,0.2); background:var(--header-bg); display:flex; align-items:center; justify-content:space-between;">
        <div style="font-size:1rem;font-weight:700;color:var(--text-dark)">è§’è‰²ç®¡ç†</div>
        <div style="display:flex;gap:0.5rem;">
          <button class="header-btn" onclick="openImportModal()" title="åŒ¯å…¥è§’è‰²å¡">ğŸ“‚</button>
          <button class="header-btn" onclick="openModal('add-char-modal')" title="æ–°å¢è§’è‰²">ï¼‹</button>
        </div>
      </div>
      <div id="chars-grid"></div>
    </div>

    <!-- SOCIAL PAGE -->
    <div class="page" id="social-page">
      <div class="social-tabs">
        <button class="social-tab active" onclick="switchSocialTab('plurk', this)">ğŸŒŠ å™—æµª</button>
        <button class="social-tab" onclick="switchSocialTab('ig', this)">ğŸ“· Instagram</button>
      </div>
      <div class="social-feed" id="social-feed"></div>
    </div>

    <!-- DIARY PAGE -->
    <div class="page" id="diary-page">
      <div class="diary-header">
        <button class="diary-nav-btn" onclick="changeMonth(-1)">â€¹</button>
        <div class="diary-month" id="diary-month-label"></div>
        <button class="diary-nav-btn" onclick="changeMonth(1)">â€º</button>
      </div>
      <div class="diary-calendar" id="diary-calendar"></div>
      <div class="diary-content" id="diary-content">
        <div class="diary-empty">é»æ“Šæ—¥æœŸæŸ¥çœ‹è§’è‰²æ—¥è¨˜</div>
      </div>
    </div>

    <!-- SPELL STAGE PAGEï¼ˆåŸ CCTVï¼‰ -->
    <div class="page" id="cctv-page">
      <div style="padding:0.8rem 1.2rem;background:var(--header-bg);border-bottom:1px solid rgba(201,184,232,0.2);display:flex;align-items:center;gap:0.8rem;flex-shrink:0;">
        <button onclick="switchPage('chat')" style="background:var(--lavender-soft);border:1px solid var(--lavender-light);border-radius:10px;padding:0.3rem 0.7rem;font-family:inherit;font-size:0.8rem;color:var(--text-mid);cursor:pointer;">â€¹ èŠå¤©</button>
        <div style="font-size:1rem;font-weight:700;color:var(--text-dark);">âœ¨ å’’èªèˆå°</div>
        <div style="font-size:0.72rem;color:var(--text-light);flex:1">ç¨ç«‹ç©ºé–“ Â· ä¸å¥— regex Â· æ”¯æ´é•·ç¯‡å›è¦†</div>
        <button onclick="clearSpellStage()" style="background:var(--lavender-soft);border:1px solid var(--lavender-light);border-radius:10px;padding:0.3rem 0.7rem;font-family:inherit;font-size:0.75rem;color:var(--text-mid);cursor:pointer;">æ¸…ç©º</button>
      </div>
      <!-- è§’è‰²é¸æ“‡ -->
      <div class="cctv-char-select-row" id="cctv-char-row" style="padding:0.5rem 0.8rem;"></div>
      <!-- å ´æ™¯è¨­å®š -->
      <div style="padding:0.6rem 1rem;border-bottom:1px solid rgba(201,184,232,0.15);flex-shrink:0;">
        <textarea id="spell-stage-scenario" placeholder="è¼¸å…¥å ´æ™¯è¨­å®šï¼ˆå’’èªï¼‰... ä¾‹ï¼šæˆ‘å€‘åœ¨ä¸€å€‹ä¸‹åˆçš„å’–å•¡å»³ï¼Œä½ å‰›å¤±å»å·¥ä½œï¼Œæˆ‘ä¾†å®‰æ…°ä½ ..." 
          style="width:100%;min-height:70px;max-height:120px;resize:vertical;border:1.5px solid var(--lavender-light);border-radius:12px;padding:0.6rem 0.9rem;font-family:inherit;font-size:0.83rem;color:var(--text-dark);background:var(--lavender-soft);outline:none;line-height:1.5;"></textarea>
        <button onclick="startSpellStage()" style="margin-top:0.4rem;width:100%;padding:0.6rem;background:linear-gradient(135deg,var(--lavender),var(--milk-blue));border:none;border-radius:12px;color:white;font-family:inherit;font-size:0.88rem;cursor:pointer;font-weight:500;">âœ¨ é–‹å§‹å°åŠ‡å ´</button>
      </div>
      <!-- å°è©±å€ -->
      <div id="spell-stage-messages" style="flex:1;overflow-y:auto;padding:1rem;">
        <div style="text-align:center;padding:3rem 1rem;color:var(--text-light);font-size:0.85rem;">é¸æ“‡è§’è‰²ï¼Œè¼¸å…¥å ´æ™¯å¾ŒæŒ‰ã€Œé–‹å§‹å°åŠ‡å ´ã€<br><span style="font-size:0.75rem;opacity:0.7">æ­¤é é¢ä¸å¥—ç”¨ regexï¼Œå¯é–±è®€å®Œæ•´é•·ç¯‡å›è¦†</span></div>
      </div>
      <!-- å°è©±è¼¸å…¥ -->
      <div style="padding:0.6rem 1rem 0.8rem;border-top:1px solid rgba(201,184,232,0.2);background:var(--header-bg);flex-shrink:0;">
        <div style="display:flex;gap:0.5rem;align-items:flex-end;">
          <textarea id="spell-stage-input" placeholder="ç¹¼çºŒå°è©±... (Ctrl+Enter é€å‡º)" rows="2"
            onkeydown="handleSpellStageKey(event)"
            oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px'"
            style="flex:1;border:1.5px solid var(--lavender-light);border-radius:14px;padding:0.65rem 0.9rem;font-family:inherit;font-size:0.88rem;color:var(--text-dark);background:var(--lavender-soft);outline:none;resize:none;line-height:1.5;"></textarea>
          <button onclick="sendSpellStageMsg()" style="width:42px;height:42px;background:linear-gradient(135deg,var(--lavender),var(--milk-blue));border:none;border-radius:14px;color:white;font-size:1.1rem;cursor:pointer;flex-shrink:0;">â¤</button>
        </div>
      </div>
    </div>

    <!-- SETTINGS PAGE -->
    <div class="page" id="settings-page" style="overflow-y:auto;">
      <div style="padding:1rem 1.2rem; background:var(--header-bg); border-bottom:1px solid rgba(201,184,232,0.2); font-size:1rem; font-weight:700; color:var(--text-dark);">è¨­å®š</div>
      
      <div class="settings-section">
        <div class="settings-section-title">API è¨­å®š</div>
        <div class="settings-item" onclick="openApiSettings()">
          <div class="settings-item-icon" style="background:var(--lavender-soft)">ğŸ”‘</div>
          <div class="settings-item-label">API Key</div>
          <div class="settings-item-value" id="api-key-display">â€¢â€¢â€¢â€¢â€¢â€¢</div>
          <div class="settings-item-arrow">â€º</div>
        </div>
        <div class="settings-item" onclick="openModal('model-settings-modal')">
          <div class="settings-item-icon" style="background:var(--milk-blue-soft)">ğŸ¤–</div>
          <div class="settings-item-label">æ¨¡å‹é¸æ“‡</div>
          <div class="settings-item-value" id="current-model-display"></div>
          <div class="settings-item-arrow">â€º</div>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-section-title">è§’è‰²èˆ‡ Persona</div>
        <div class="settings-item" onclick="openModal('persona-modal')">
          <div class="settings-item-icon" style="background:var(--beige)">ğŸ­</div>
          <div class="settings-item-label">æˆ‘çš„ Persona</div>
          <div class="settings-item-value" id="persona-display">æœªè¨­å®š</div>
          <div class="settings-item-arrow">â€º</div>
        </div>
        <div class="settings-item" onclick="openModal('preset-modal')">
          <div class="settings-item-icon" style="background:var(--lavender-soft)">ğŸ“‹</div>
          <div class="settings-item-label">Preset / æç¤ºè©</div>
          <div class="settings-item-arrow">â€º</div>
        </div>
        <div class="settings-item" onclick="openModal('lorebook-modal')">
          <div class="settings-item-icon" style="background:var(--milk-blue-soft)">ğŸ“š</div>
          <div class="settings-item-label">Lorebook</div>
          <div class="settings-item-arrow">â€º</div>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-section-title">è§’è‰²è‡ªå‹•å‚³è¨Š</div>
        <div class="settings-item">
          <div class="settings-item-icon" style="background:var(--lavender-soft)">ğŸ’¬</div>
          <div class="settings-item-label">è¶…æ™‚è‡ªå‹•å‚³è¨Š</div>
          <div class="toggle-switch" id="automsg-toggle" onclick="toggleAutoMsg()"></div>
        </div>
        <div class="settings-item" style="cursor:default;">
          <div class="settings-item-icon" style="background:var(--milk-blue-soft)">â±ï¸</div>
          <div class="settings-item-label">ç„¡å›è¦†å¹¾å°æ™‚å¾Œè‡ªå‹•ç™¼</div>
          <input type="number" id="automsg-hours-input" min="1" max="24" value="3"
            onchange="saveAutoMsgHours()"
            style="width:56px;border:1.5px solid var(--lavender-light);border-radius:8px;padding:0.3rem 0.5rem;font-family:inherit;font-size:0.85rem;color:var(--text-dark);background:var(--lavender-soft);text-align:center;outline:none;">
          <span style="font-size:0.78rem;color:var(--text-light);">å°æ™‚</span>
        </div>
        <div class="settings-item" onclick="triggerAutoMsgNow()" style="cursor:pointer;">
          <div class="settings-item-icon" style="background:#f0fff0">ğŸ“¨</div>
          <div class="settings-item-label">ç«‹å³è®“è§’è‰²å‚³ä¸€å‰‡è¨Šæ¯</div>
          <div class="settings-item-arrow">â€º</div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">ç¾å¯¦é€£å‹•</div>
        <div class="settings-item">
          <div class="settings-item-icon" style="background:#fff0f0">ğŸ‚</div>
          <div class="settings-item-label">ç”Ÿæ—¥æé†’</div>
          <input type="date" id="birthday-input" style="border:none;background:none;font-family:inherit;font-size:0.8rem;color:var(--text-light);outline:none;">
        </div>
        <div class="settings-item" onclick="toggleRealWorldEvents()">
          <div class="settings-item-icon" style="background:#f0fff0">ğŸ’Œ</div>
          <div class="settings-item-label">ç¯€æ—¥ä¸»å‹•é‚€ç´„</div>
          <div class="toggle-switch" id="realworld-toggle"></div>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-section-title">è³‡æ–™ç®¡ç†</div>
        <div class="settings-item" onclick="exportBackup()">
          <div class="settings-item-icon" style="background:var(--lavender-soft)">ğŸ’¾</div>
          <div class="settings-item-label">åŒ¯å‡ºå‚™ä»½</div>
          <div class="settings-item-arrow">â€º</div>
        </div>
        <div class="settings-item" onclick="importBackup()">
          <div class="settings-item-icon" style="background:var(--milk-blue-soft)">ğŸ“¥</div>
          <div class="settings-item-label">åŒ¯å…¥å‚™ä»½</div>
          <div class="settings-item-arrow">â€º</div>
        </div>
        <div class="settings-item" onclick="confirmClearAll()">
          <div class="settings-item-icon" style="background:#fff0f0">ğŸ—‘ï¸</div>
          <div class="settings-item-label" style="color:#e87878">æ¸…é™¤æ‰€æœ‰è³‡æ–™</div>
          <div class="settings-item-arrow">â€º</div>
        </div>
      </div>
    </div>

  </div>

  <!-- Memory Panel -->
  <div id="memory-panel">
    <div class="memory-header">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="memory-title">ğŸ§  é•·æœŸè¨˜æ†¶</div>
        <button onclick="toggleMemoryPanel()" style="background:none;border:none;cursor:pointer;color:var(--text-light);font-size:1.1rem;">Ã—</button>
      </div>
    </div>
    <div class="memory-list" id="memory-list"></div>
    <button class="memory-add-btn" onclick="addMemoryItem()">ï¼‹ æ–°å¢è¨˜æ†¶</button>
  </div>

</div>

<!-- â”€â”€â”€ CONTEXT MENU â”€â”€â”€ -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-item" onclick="ctxAction('copy')">ğŸ“‹ è¤‡è£½</div>
  <div class="ctx-item" onclick="ctxAction('edit')">âœï¸ ç·¨è¼¯</div>
  <div class="ctx-divider"></div>
  <div class="ctx-item" onclick="ctxAction('regen')">ğŸ”„ é‡æ–°ç”Ÿæˆ</div>
  <div class="ctx-divider"></div>
  <div class="ctx-item danger" onclick="ctxAction('delete')">ğŸ—‘ï¸ åˆªé™¤è¨Šæ¯</div>
</div>

<!-- â”€â”€â”€ TOAST â”€â”€â”€ -->
<div class="toast" id="toast"></div>

<!-- â”€â”€â”€ BOTTOM NAV â”€â”€â”€ -->
<nav id="bottom-nav">
  <button class="bottom-nav-btn active" onclick="switchPage('chat')" id="bnav-chat">
    <span class="icon">ğŸ’¬</span><span>èŠå¤©</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('chars')" id="bnav-chars">
    <span class="icon">ğŸŒ¸</span><span>è§’è‰²</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('social')" id="bnav-social">
    <span class="icon">âœ¦</span><span>ç¤¾ç¾¤</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('diary')" id="bnav-diary">
    <span class="icon">ğŸ“”</span><span>æ—¥è¨˜</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('cctv')" id="bnav-cctv">
    <span class="icon">âœ¨</span><span>å’’èª</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('settings')" id="bnav-settings">
    <span class="icon">âš™ï¸</span><span>è¨­å®š</span>
  </button>
</nav>

<!-- â”€â”€â”€ MODALS â”€â”€â”€ -->

<!-- ADD / EDIT CHAR MODAL -->
<div class="modal-overlay" id="add-char-modal">
  <div class="modal">
    <div class="modal-title" id="add-char-modal-title">ğŸŒ¸ æ–°å¢è§’è‰²</div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchModalTab(this,'char-manual')">æ‰‹å‹•å»ºç«‹</button>
      <button class="modal-tab" onclick="switchModalTab(this,'char-import')">åŒ¯å…¥è§’è‰²å¡</button>
    </div>
    <div class="modal-tab-content active" id="char-manual">
      <div class="modal-field">
        <label class="modal-label">è§’è‰²åç¨±</label>
        <input class="modal-input" id="char-name-input" placeholder="ä¾‹ï¼šå°é›¨">
      </div>
      <div class="modal-field">
        <label class="modal-label">é ­åƒ</label>
        <div style="display:flex;align-items:center;gap:0.7rem;margin-bottom:0.5rem;">
          <div id="char-avatar-preview" style="width:48px;height:48px;border-radius:14px;background:var(--lavender-soft);border:1.5px solid var(--lavender-light);display:flex;align-items:center;justify-content:center;font-size:1.8rem;overflow:hidden;flex-shrink:0;"></div>
          <div style="flex:1;">
            <input class="modal-input" id="char-avatar-input" placeholder="ğŸŒ¸ æˆ–è²¼ä¸Šåœ–ç‰‡ URL" style="margin-bottom:0.4rem;">
            <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;font-size:0.78rem;color:var(--text-mid);background:var(--lavender-soft);border:1px solid var(--lavender-light);border-radius:10px;padding:0.35rem 0.7rem;width:fit-content;">
              ğŸ“· ä¸Šå‚³åœ–ç‰‡
              <input type="file" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)">
            </label>
          </div>
        </div>
      </div>
      <div class="modal-field">
        <label class="modal-label">è§’è‰²æè¿° (Character Card)</label>
        <textarea class="modal-textarea" id="char-desc-input" placeholder="æè¿°è§’è‰²çš„å€‹æ€§ã€èƒŒæ™¯ã€èªªè©±æ–¹å¼..."></textarea>
      </div>
      <div class="modal-field">
        <label class="modal-label">é–‹å ´ç™½ (First Message)</label>
        <textarea class="modal-textarea" id="char-first-msg-input" style="min-height:70px" placeholder="è§’è‰²çš„ç¬¬ä¸€å¥è©±..."></textarea>
      </div>
      <div class="modal-field">
        <label class="modal-label">ç¶å®š Persona</label>
        <select class="modal-select" id="char-persona-select">
          <option value="">ä¸ç¶å®š</option>
        </select>
      </div>
    </div>
    <div class="modal-tab-content" id="char-import">
      <div style="padding:1rem;text-align:center;color:var(--text-light);">
        <p style="margin-bottom:1rem;font-size:0.88rem;">æ”¯æ´ SillyTavern è§’è‰²å¡æ ¼å¼</p>
        <label style="cursor:pointer;">
          <div style="padding:1.5rem;border:2px dashed rgba(201,184,232,0.4);border-radius:14px;">
            <div style="font-size:2rem;margin-bottom:0.5rem;">ğŸ“‚</div>
            <div style="font-size:0.85rem;">é»æ“Šé¸æ“‡ .json æˆ– .png æª”æ¡ˆ</div>
          </div>
          <input type="file" accept=".json,.png" style="display:none" onchange="importCharCard(event)">
        </label>
      </div>
    </div>
    <div class="modal-actions" style="flex-wrap:wrap;gap:0.4rem;">
      <button class="modal-btn secondary" onclick="closeModal('add-char-modal')" style="flex:1;min-width:80px;">å–æ¶ˆ</button>
      <button id="delete-char-btn" class="modal-btn secondary" onclick="deleteCharFromModal()" style="flex:1;min-width:80px;color:#e87878;display:none;">ğŸ—‘ï¸ åˆªé™¤è§’è‰²</button>
      <button id="save-char-btn" class="modal-btn primary" onclick="saveChar()" style="flex:2;min-width:100px;">å»ºç«‹è§’è‰²</button>
    </div>
  </div>
</div>

<!-- PRESET MODAL -->
<div class="modal-overlay" id="preset-modal">
  <div class="modal">
    <div class="modal-title">ğŸ“‹ Preset æç¤ºè©è¨­å®š</div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchModalTab(this,'preset-system')">System Prompt</button>
      <button class="modal-tab" onclick="switchModalTab(this,'preset-jailbreak')">è¶Šç„æç¤ºè©</button>
      <button class="modal-tab" onclick="switchModalTab(this,'preset-regex')">Regex</button>
    </div>
    <div class="modal-tab-content active" id="preset-system">
      <div class="modal-field">
        <label class="modal-label">ä¸»è¦ System Prompt</label>
        <textarea class="modal-textarea" id="system-prompt-input" style="min-height:140px" placeholder="You are {{char}}, talking to {{user}}. Reply in Traditional Chinese..."></textarea>
      </div>
      <div class="modal-field">
        <label class="modal-label">Context Template</label>
        <select class="modal-select" id="context-template-select">
          <option>é è¨­ (LINE èŠå¤©é¢¨æ ¼)</option>
          <option>å­¸è¡“/æ­£å¼</option>
          <option>å‰µæ„å¯«ä½œ</option>
          <option>è‡ªè¨‚...</option>
        </select>
      </div>
    </div>
    <div class="modal-tab-content" id="preset-jailbreak">
      <div class="modal-field">
        <label class="modal-label">è¶Šç„æç¤ºè© (æ³¨å…¥åˆ° Context æœ«å°¾)</label>
        <textarea class="modal-textarea" id="jailbreak-input" style="min-height:140px" placeholder="[å ´æ™¯æè¿°ï¼Œå¹«åŠ© AI æ›´å¥½åœ°æ‰®æ¼”è§’è‰²...]"></textarea>
      </div>
      <div class="modal-field">
        <label class="modal-label">æ³¨å…¥ä½ç½®</label>
        <select class="modal-select" id="jailbreak-position">
          <option value="before_char">è§’è‰²æè¿°ä¹‹å‰</option>
          <option value="after_char">è§’è‰²æè¿°ä¹‹å¾Œ</option>
          <option value="before_last">æœ€å¾Œä¸€å‰‡è¨Šæ¯ä¹‹å‰</option>
          <option value="system">System å±¤</option>
        </select>
      </div>
    </div>
    <div class="modal-tab-content" id="preset-regex">
      <div class="modal-field">
        <label class="modal-label">Regex è¦å‰‡ (æ¯è¡Œä¸€æ¢ï¼Œæ ¼å¼: pattern â†’ replacement)</label>
        <textarea class="modal-textarea" id="regex-input" style="min-height:140px;font-family:monospace;font-size:0.8rem;" placeholder="\\*\\*(.*?)\\*\\* â†’ $1&#10;\*.*?\* â†’ "></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('preset-modal')">å–æ¶ˆ</button>
      <button class="modal-btn primary" onclick="savePreset()">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- LOREBOOK MODAL -->
<div class="modal-overlay" id="lorebook-modal">
  <div class="modal" style="width:min(660px,96vw);max-height:90dvh;padding:1.5rem;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.8rem;">
      <div style="display:flex;align-items:center;gap:0.6rem;">
        <div style="font-size:1.3rem;">ğŸ“š</div>
        <div>
          <div class="modal-title" style="margin:0;font-size:1rem;">Lorebook / World Info</div>
          <div style="font-size:0.68rem;color:var(--text-light);letter-spacing:0.05em;">SillyTavern ç›¸å®¹æ ¼å¼</div>
        </div>
      </div>
      <div id="lb-count"></div>
    </div>
    <!-- ST info strip -->
    <div class="lb-st-info" style="margin-bottom:0.8rem;">
      <span>ğŸ“–</span>
      <span>é—œéµå­—è§¸ç™¼è‡ªå‹•æ³¨å…¥ Â· Constant æ°¸é æ³¨å…¥ Â· Selective éœ€åŒæ™‚åŒ¹é… Secondary Keys</span>
    </div>
    <div id="lorebook-list" style="margin-bottom:0.8rem;max-height:calc(90dvh - 200px);overflow-y:auto;display:flex;flex-direction:column;gap:0.5rem;padding-right:2px;"></div>
    <div style="display:flex;gap:0.5rem;">
      <button onclick="addLorebookEntry()" style="flex:1;padding:0.65rem;background:var(--lavender-soft);border:1.5px dashed rgba(201,184,232,0.5);border-radius:12px;font-family:inherit;font-size:0.85rem;color:var(--text-mid);cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center;gap:0.4rem;">ï¼‹ æ–°å¢æ¢ç›®</button>
      <button class="modal-btn primary" onclick="saveLorebook()" style="flex:0 0 auto;padding:0.65rem 1.4rem;">å®Œæˆ</button>
    </div>
  </div>
</div>
<!-- PERSONA MODAL -->
<div class="modal-overlay" id="persona-modal">
  <div class="modal">
    <div class="modal-title">ğŸ­ Persona è¨­å®š</div>
    <div id="persona-list" style="margin-bottom:1rem;"></div>
    <button onclick="addPersona()" style="width:100%;padding:0.6rem;background:var(--lavender-soft);border:1.5px dashed rgba(201,184,232,0.4);border-radius:12px;font-family:inherit;font-size:0.85rem;color:var(--text-mid);cursor:pointer;">ï¼‹ æ–°å¢ Persona</button>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('persona-modal')">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- MODEL SETTINGS MODAL -->
<div class="modal-overlay" id="model-settings-modal">
  <div class="modal">
    <div class="modal-title">ğŸ¤– æ¨¡å‹è¨­å®š</div>
    <div class="modal-field">
      <label class="modal-label">API Key</label>
      <input class="modal-input" type="password" id="api-key-update" placeholder="AIza...">
    </div>
    <div class="modal-field">
      <label class="modal-label">æ¨¡å‹åç¨±ï¼ˆå¯è‡ªè¡Œè¼¸å…¥ä»»æ„æ¨¡å‹ IDï¼‰</label>
      <input class="modal-input" type="text" id="model-custom-input"
        placeholder="ä¾‹ï¼šgemini-3-flash-preview"
        list="model-datalist-settings">
      <datalist id="model-datalist-settings">
        <option value="gemini-3-flash-preview">Gemini 3 Flash Previewï¼ˆæœ€æ–°ï¼‰</option>
        <option value="gemini-3-pro-preview">Gemini 3 Pro Previewï¼ˆæœ€æ–°ï¼‰</option>
        <option value="gemini-3-flash-exp">Gemini 3 Flash Exp</option>
        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
      </datalist>
      <div style="font-size:0.72rem;color:var(--text-light);margin-top:0.35rem;">ç›´æ¥è¼¸å…¥æ¨¡å‹ ID å³å¯ä½¿ç”¨ä»»ä½• Gemini ç‰ˆæœ¬</div>
      <!-- hidden for backward compat -->
      <select id="model-update-select" style="display:none">
        <option value="gemini-3-flash-preview">gemini-3-flash-preview</option>
        <option value="gemini-3-pro-preview">gemini-3-pro-preview</option>
        <option value="gemini-2.0-flash">gemini-2.0-flash</option>
        <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp</option>
      </select>
    </div>
    <div class="modal-field">
      <label class="modal-label">Temperature</label>
      <input type="range" min="0" max="2" step="0.1" value="1.0" id="temp-slider" oninput="document.getElementById('temp-val').textContent=this.value" style="width:100%">
      <span id="temp-val" style="font-size:0.8rem;color:var(--text-light)">1.0</span>
    </div>
    <div class="modal-field">
      <label class="modal-label">Max Output Tokens</label>
      <input class="modal-input" type="number" id="max-tokens-input" value="2048" min="100" max="8192">
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('model-settings-modal')">å–æ¶ˆ</button>
      <button class="modal-btn primary" onclick="saveModelSettings()">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- IMAGE PREVIEW MODAL -->
<div class="modal-overlay" id="image-preview-modal" onclick="closeModal('image-preview-modal')">
  <div style="max-width:90vw;max-height:90vh;">
    <img id="preview-img" style="max-width:100%;max-height:90vh;border-radius:18px;display:block;">
  </div>
</div>

<!-- SOCIAL COMPOSE MODAL -->
<div class="modal-overlay" id="social-compose-modal">
  <div class="modal">
    <div class="modal-title" id="social-compose-title">âœ¦ è®“è§’è‰²ç™¼æ–‡</div>
    <div class="modal-field">
      <label class="modal-label">ç™¼æ–‡è§’è‰²</label>
      <select class="modal-select" id="social-post-char-select"></select>
    </div>
    <div class="modal-field">
      <label class="modal-label">ç™¼æ–‡å…§å®¹æç¤º</label>
      <textarea class="modal-textarea" id="social-post-prompt" placeholder="æè¿°ä½ å¸Œæœ›è§’è‰²ç™¼ä»€éº¼ä¸»é¡Œçš„æ–‡ç« ...ï¼ˆç•™ç©ºè®“è§’è‰²è‡ªç”±ç™¼æ®ï¼‰"></textarea>
    </div>
    <div class="modal-field">
      <label class="modal-label">åœ–ç‰‡ç”Ÿæˆ</label>
      <select class="modal-select" id="social-image-option">
        <option value="none">ä¸ç”Ÿæˆåœ–ç‰‡</option>
        <option value="auto">æ ¹æ“šå…§å®¹è‡ªå‹•ç”Ÿæˆ</option>
        <option value="selfie">è‡ªæ‹é¢¨æ ¼</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('social-compose-modal')">å–æ¶ˆ</button>
      <button class="modal-btn primary" onclick="aiPostSocial()">ç™¼å¸ƒ</button>
    </div>
  </div>
</div>

<!-- CHAR INFO MODAL (quick view) -->
<div class="modal-overlay" id="char-info-modal">
  <div class="modal">
    <div style="text-align:center;margin-bottom:1rem;">
      <div id="char-info-avatar" style="width:80px;height:80px;border-radius:24px;background:linear-gradient(135deg,var(--lavender),var(--milk-blue));display:flex;align-items:center;justify-content:center;font-size:2.5rem;margin:0 auto 0.8rem;overflow:hidden;"></div>
      <div id="char-info-name" style="font-size:1.2rem;font-weight:700;color:var(--text-dark);"></div>
    </div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchModalTab(this,'ci-desc')">æè¿°</button>
      <button class="modal-tab" onclick="switchModalTab(this,'ci-chats')">èŠå¤©çª—</button>
      <button class="modal-tab" onclick="switchModalTab(this,'ci-export')">åŒ¯å‡º</button>
    </div>
    <div class="modal-tab-content active" id="ci-desc">
      <div id="char-info-desc" style="font-size:0.85rem;color:var(--text-mid);line-height:1.7;max-height:200px;overflow-y:auto;"></div>
    </div>
    <div class="modal-tab-content" id="ci-chats">
      <div id="char-info-chats" style="display:flex;flex-direction:column;gap:0.5rem;"></div>
      <button onclick="newChatWithChar()" style="width:100%;margin-top:0.8rem;padding:0.6rem;background:var(--lavender-soft);border:1.5px dashed rgba(201,184,232,0.4);border-radius:12px;font-family:inherit;font-size:0.82rem;color:var(--text-mid);cursor:pointer;">ï¼‹ æ–°é–‹èŠå¤©çª—</button>
    </div>
    <div class="modal-tab-content" id="ci-export">
      <div style="display:flex;flex-direction:column;gap:0.5rem;">
        <button class="modal-btn secondary" onclick="exportCharAsJson()">åŒ¯å‡ºç‚º JSON è§’è‰²å¡</button>
        <button class="modal-btn secondary" onclick="exportChatHistory()">åŒ¯å‡ºèŠå¤©è¨˜éŒ„</button>
        <button class="modal-btn secondary" onclick="exportChatAsST()">åŒ¯å‡ºç‚º ST æ ¼å¼</button>
      </div>
    </div>
    <div class="modal-actions" style="flex-wrap:wrap;gap:0.4rem;">
      <button class="modal-btn secondary" onclick="closeModal('char-info-modal')" style="flex:1;">é—œé–‰</button>
      <button class="modal-btn secondary" onclick="deleteChar(state.activeCharId)" style="flex:1;color:#e87878;">ğŸ—‘ï¸ åˆªé™¤è§’è‰²</button>
      <button class="modal-btn primary" onclick="editChar()" style="flex:2;">âœï¸ ç·¨è¼¯è§’è‰²</button>
    </div>
  </div>
</div>

<script src="app.js"></script>
</body>
</html>
