<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>erhabene</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@300;400;500;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
<style>
:root {
  --lavender: #c9b8e8;
  --lavender-light: #e8e0f5;
  --lavender-soft: #f3eff9;
  --milk-blue: #b8d4e8;
  --milk-blue-light: #daeaf5;
  --milk-blue-soft: #eef5fb;
  --beige: #f0e8d8;
  --beige-dark: #d4c4a8;
  --beige-soft: #faf6f0;
  --text-dark: #3d3450;
  --text-mid: #6b5f7a;
  --text-light: #a89bb5;
  --white: #fefefe;
  --shadow: rgba(180,160,210,0.18);
  --shadow-deep: rgba(100,80,140,0.12);
  --bubble-user: linear-gradient(135deg, #c9b8e8, #b8c8e8);
  --bubble-ai: rgba(255,255,255,0.9);
  --sidebar-bg: linear-gradient(180deg, #f3eff9 0%, #eef5fb 50%, #faf6f0 100%);
  --header-bg: rgba(243,239,249,0.95);
  --nav-active: #c9b8e8;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  font-family: 'Zen Kaku Gothic New', sans-serif;
  background: var(--beige-soft);
  color: var(--text-dark);
  height: 100dvh;
  overflow: hidden;
  overflow-x: hidden;
  display: flex;
  touch-action: pan-y;
}

/* ─── SETUP SCREEN ─── */
#setup-screen {
  position: fixed; inset: 0;
  background: linear-gradient(160deg, #f3eff9 0%, #eef5fb 40%, #faf6f0 100%);
  display: flex; align-items: center; justify-content: center;
  z-index: 9999;
  flex-direction: column;
  gap: 2rem;
}

.setup-card {
  background: rgba(255,255,255,0.82);
  backdrop-filter: blur(20px);
  border-radius: 28px;
  padding: 3rem;
  width: min(460px, 92vw);
  box-shadow: 0 8px 40px var(--shadow), 0 2px 8px var(--shadow-deep);
  border: 1px solid rgba(201,184,232,0.3);
}

.setup-logo {
  font-family: 'Cormorant Garamond', serif;
  font-size: 2.8rem;
  font-weight: 300;
  font-style: italic;
  color: var(--text-dark);
  text-align: center;
  margin-bottom: 0.3rem;
  letter-spacing: 0.05em;
}
.setup-tagline {
  text-align: center;
  font-size: 0.78rem;
  color: var(--text-light);
  letter-spacing: 0.15em;
  text-transform: uppercase;
  margin-bottom: 2.2rem;
}

.setup-field { margin-bottom: 1.2rem; }
.setup-label {
  display: block;
  font-size: 0.78rem;
  color: var(--text-mid);
  margin-bottom: 0.5rem;
  letter-spacing: 0.08em;
}
.setup-input, .setup-select {
  width: 100%;
  padding: 0.85rem 1.1rem;
  border: 1.5px solid var(--lavender-light);
  border-radius: 14px;
  background: var(--lavender-soft);
  color: var(--text-dark);
  font-family: inherit;
  font-size: 0.9rem;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.setup-input:focus, .setup-select:focus {
  border-color: var(--lavender);
  box-shadow: 0 0 0 3px rgba(201,184,232,0.2);
}
.setup-select option { background: white; }

.setup-btn {
  width: 100%;
  padding: 1rem;
  background: linear-gradient(135deg, #c9b8e8, #b8cce8);
  border: none;
  border-radius: 16px;
  color: white;
  font-family: inherit;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s;
  margin-top: 0.5rem;
  letter-spacing: 0.05em;
}
.setup-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(180,160,220,0.4); }
.setup-btn:active { transform: translateY(0); }


/* ─── DARK MODE ─── */
[data-theme="dark"] {
  --lavender: #a89acc;
  --lavender-light: #3a3050;
  --lavender-soft: #2a2438;
  --milk-blue: #7aa8cc;
  --milk-blue-light: #1e3045;
  --milk-blue-soft: #1a2535;
  --beige: #2a2420;
  --beige-dark: #1a1510;
  --beige-soft: #1a1820;
  --text-dark: #e8e0f5;
  --text-mid: #b8aac8;
  --text-light: #7a6e8a;
  --white: #242030;
  --shadow: rgba(0,0,0,0.35);
  --shadow-deep: rgba(0,0,0,0.5);
  --bubble-user: linear-gradient(135deg, #6a52a8, #3a5880);
  --bubble-ai: rgba(42,36,56,0.95);
  --sidebar-bg: linear-gradient(180deg, #1e1a2a 0%, #1a2030 50%, #1c1a22 100%);
  --header-bg: rgba(26,24,32,0.97);
  --nav-active: #a89acc;
}
[data-theme="dark"] body { background: #1a1820; }
[data-theme="dark"] .modal { background: #242030; border: 1px solid rgba(168,154,204,0.15); }
[data-theme="dark"] .modal-input,
[data-theme="dark"] .modal-select,
[data-theme="dark"] .modal-textarea { background: #1a1820; color: var(--text-dark); border-color: rgba(168,154,204,0.2); }
[data-theme="dark"] .settings-item { background: rgba(255,255,255,0.03); }
[data-theme="dark"] .msg-actions { background: rgba(36,32,48,0.98); }
[data-theme="dark"] .ctx-menu { background: #242030; border-color: rgba(168,154,204,0.2); }
[data-theme="dark"] .chat-item:hover, [data-theme="dark"] .chat-item.active { background: rgba(168,154,204,0.1); }
[data-theme="dark"] #setup-screen { background: linear-gradient(160deg,#1e1a2a,#1a2030,#1c1a22); }
[data-theme="dark"] .setup-card { background: rgba(36,32,48,0.9); }
[data-theme="dark"] .char-card { background: rgba(36,32,48,0.9); border-color: rgba(168,154,204,0.12); }
[data-theme="dark"] .msg-del-btn { color: var(--text-light); }
[data-theme="dark"] input[type="date"],
[data-theme="dark"] input[type="text"],
[data-theme="dark"] input[type="password"],
[data-theme="dark"] input[type="number"] { background: #1a1820; color: var(--text-dark); }
[data-theme="dark"] .toggle-switch { background: rgba(255,255,255,0.1); }
[data-theme="dark"] .swipe-del-layer { filter: brightness(0.85); }

/* ─── DARK MODE extra: cards, social, diary ─── */
[data-theme="dark"] .post-card { background: rgba(42,36,56,0.95) !important; border-color: rgba(168,154,204,0.12) !important; }
[data-theme="dark"] .char-card { background: rgba(36,32,48,0.95) !important; }
[data-theme="dark"] .diary-entry-card { background: rgba(42,36,56,0.95) !important; border-color: rgba(168,154,204,0.12) !important; }
[data-theme="dark"] .diary-entry { background: rgba(36,30,50,0.98) !important; border-color: rgba(168,154,204,0.15) !important; }
[data-theme="dark"] .diary-entry-text { color: var(--text-dark) !important; }
[data-theme="dark"] .diary-entry-date { color: var(--text-mid) !important; }
[data-theme="dark"] .diary-entry-char { border-color: rgba(168,154,204,0.15) !important; }
[data-theme="dark"] #diary-page { background: #1a1820 !important; }
[data-theme="dark"] .diary-content { background: transparent !important; }
[data-theme="dark"] .diary-nav-btn { color: var(--text-light) !important; }
[data-theme="dark"] .cal-day { color: var(--text-mid) !important; background: transparent !important; }
[data-theme="dark"] .cal-day.has-entry { background: rgba(168,154,204,0.25) !important; color: var(--text-dark) !important; }
[data-theme="dark"] .cal-day.today { background: var(--lavender) !important; color: white !important; }
[data-theme="dark"] .cal-day.selected { background: rgba(168,154,204,0.2) !important; border-color: var(--lavender) !important; color: var(--text-dark) !important; }
[data-theme="dark"] #diary-generate-area { background: rgba(36,30,50,0.98) !important; }
[data-theme="dark"] #diary-result-section { background: rgba(36,30,50,0.98) !important; }
[data-theme="dark"] .cal-grid { background: rgba(36,32,48,0.6) !important; }
[data-theme="dark"] .cal-day { color: var(--text-mid); }
[data-theme="dark"] .cal-day:hover { background: rgba(168,154,204,0.15); }
[data-theme="dark"] .cal-day.has-entry { background: rgba(168,154,204,0.2); color: var(--text-dark); }
[data-theme="dark"] .diary-char-card { background: rgba(42,36,56,0.95) !important; border-color: rgba(168,154,204,0.12) !important; }
[data-theme="dark"] .diary-style-btn { background: rgba(42,36,56,0.9) !important; border-color: rgba(168,154,204,0.2) !important; color: var(--text-mid) !important; }
[data-theme="dark"] .diary-regen-btn { background: rgba(42,36,56,0.9) !important; border-color: rgba(168,154,204,0.2) !important; color: var(--text-mid) !important; }
[data-theme="dark"] .comment-bubble { background: rgba(36,32,48,0.95) !important; border-color: rgba(168,154,204,0.1) !important; }
[data-theme="dark"] .th-item { background: rgba(42,36,56,0.9) !important; border-color: rgba(168,154,204,0.15) !important; }
[data-theme="dark"] .achievement-card { background: rgba(42,36,56,0.95) !important; border-color: rgba(168,154,204,0.12) !important; }
[data-theme="dark"] .persona-card { background: rgba(42,36,56,0.95) !important; border-color: rgba(168,154,204,0.12) !important; }
[data-theme="dark"] .lorebook-item { background: rgba(42,36,56,0.9) !important; border-color: rgba(168,154,204,0.12) !important; }
[data-theme="dark"] .chat-item { background: transparent; }
[data-theme="dark"] .chat-item:hover { background: rgba(168,154,204,0.1) !important; }
[data-theme="dark"] .chat-item.active { background: rgba(168,154,204,0.15) !important; }
[data-theme="dark"] #messages-area { background: #1a1820; }
[data-theme="dark"] #inner-voice-panel { background: rgba(26,24,32,0.97); border-color: rgba(168,154,204,0.15); }
[data-theme="dark"] [style*="background:rgba(255,255,255,0.88)"],
[data-theme="dark"] [style*="background:rgba(255,255,255,0.95)"],
[data-theme="dark"] [style*="background:rgba(255,255,255,0.85)"],
[data-theme="dark"] [style*="background:rgba(255,255,255,0.8)"],
[data-theme="dark"] [style*="background:rgba(255,255,255,0.9)"] { background: rgba(42,36,56,0.95) !important; }
[data-theme="dark"] .settings-section { background: transparent; }
[data-theme="dark"] .settings-section-title { color: var(--text-light); }
[data-theme="dark"] .add-chat-btn { border-color: rgba(168,154,204,0.2); color: var(--text-light); }
[data-theme="dark"] select { background: #1a1820 !important; color: var(--text-dark) !important; }
[data-theme="dark"] textarea { background: #1a1820 !important; color: var(--text-dark) !important; }
[data-theme="dark"] .imagegen-type-btn,
[data-theme="dark"] .imagegen-style-btn { background: rgba(42,36,56,0.9) !important; color: var(--text-mid) !important; border-color: rgba(168,154,204,0.2) !important; }
[data-theme="dark"] .nav-btn { color: var(--text-light); }
[data-theme="dark"] .nav-btn.active { background: var(--lavender); color: white; }
[data-theme="dark"] #side-nav { background: linear-gradient(180deg, #1e1a2a, #1a2030, #1c1a22); }


/* ─── MAIN LAYOUT ─── */
#app { display: flex; width: 100%; height: 100dvh; overflow: hidden; }

/* ─── LEFT NAV (Desktop) ─── */
#side-nav {
  width: 68px;
  background: var(--lavender-soft);
  border-right: 1px solid rgba(201,184,232,0.2);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 1.2rem 0;
  gap: 0.3rem;
  z-index: 100;
  flex-shrink: 0;
}

.nav-logo {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.1rem;
  font-style: italic;
  color: var(--lavender);
  margin-bottom: 1rem;
  writing-mode: horizontal-tb;
}

.nav-btn {
  width: 46px; height: 46px;
  border-radius: 14px;
  border: none;
  background: transparent;
  color: var(--text-light);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.3rem;
  transition: background 0.2s, color 0.2s;
  position: relative;
}
.nav-btn:hover { background: var(--lavender-light); color: var(--text-dark); }
.nav-btn.active { background: var(--lavender); color: white; }
.nav-btn .badge {
  position: absolute; top: 6px; right: 6px;
  width: 8px; height: 8px;
  background: #e8a0b8;
  border-radius: 50%;
}

.nav-spacer { flex: 1; }

/* ─── SIDEBAR ─── */
#sidebar {
  width: 300px;
  background: var(--sidebar-bg);
  border-right: 1px solid rgba(201,184,232,0.25);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow: hidden;
}

.sidebar-header {
  padding: 0.75rem 1rem 0.6rem;
  border-bottom: 1px solid rgba(201,184,232,0.2);
  display: flex; align-items: center; justify-content: space-between;
}
.sidebar-title {
  font-size: 0.95rem;
  font-weight: 700;
  color: var(--text-dark);
  margin-bottom: 0;
}
/* search removed */

.sidebar-list { flex: 1; overflow-y: auto; padding: 0.3rem 0.4rem; }
.sidebar-list::-webkit-scrollbar { width: 3px; }
.sidebar-list::-webkit-scrollbar-thumb { background: var(--lavender-light); border-radius: 2px; }

.chat-item {
  display: flex; align-items: center; gap: 0.8rem;
  padding: 0.55rem 0.7rem;
  border-radius: 14px;
  cursor: pointer;
  transition: background 0.15s;
  position: relative;
}
.chat-item:hover { background: rgba(255,255,255,0.6); }
.chat-item.active { background: rgba(255,255,255,0.85); box-shadow: 0 2px 8px var(--shadow); }

.chat-avatar {
  width: 46px; height: 46px; border-radius: 16px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 1.4rem; flex-shrink: 0;
  overflow: hidden; position: relative;
}
.chat-avatar img { width: 100%; height: 100%; object-fit: cover; }
.chat-avatar-status {
  position: absolute; bottom: 2px; right: 2px;
  width: 10px; height: 10px; border-radius: 50%;
  background: #a8d8a8; border: 2px solid white;
}

.chat-meta { flex: 1; min-width: 0; }
.chat-name { font-size: 0.9rem; font-weight: 500; color: var(--text-dark); }
.chat-preview { font-size: 0.78rem; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 0.15rem; }
.chat-time { font-size: 0.7rem; color: var(--text-light); }
.chat-unread {
  background: var(--lavender);
  color: white;
  border-radius: 10px;
  font-size: 0.7rem;
  padding: 0.15rem 0.45rem;
  font-weight: 500;
  min-width: 20px; text-align: center;
}

.add-chat-btn {
  margin: 0.5rem;
  padding: 0.7rem;
  background: linear-gradient(135deg, rgba(201,184,232,0.3), rgba(184,212,232,0.3));
  border: 1.5px dashed rgba(201,184,232,0.5);
  border-radius: 14px;
  color: var(--text-light);
  cursor: pointer;
  text-align: center;
  font-size: 0.82rem;
  font-family: inherit;
  transition: all 0.2s;
}
.add-chat-btn:hover { background: rgba(201,184,232,0.2); color: var(--text-mid); border-style: solid; }

/* ─── MAIN AREA ─── */
#main-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  overflow-x: hidden;
  min-width: 0;
}

/* ─── CHAT HEADER ─── */
#chat-header {
  padding: 0.9rem 1.2rem;
  background: var(--header-bg);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(201,184,232,0.2);
  display: flex;
  align-items: center;
  gap: 0.9rem;
  flex-shrink: 0;
}

.header-avatar {
  width: 40px; height: 40px; border-radius: 13px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem; overflow: hidden; flex-shrink: 0;
}
.header-avatar img { width: 100%; height: 100%; object-fit: cover; }
.header-info { flex: 1; }
.header-name { font-size: 0.95rem; font-weight: 500; color: var(--text-dark); }
.header-status { font-size: 0.72rem; color: var(--text-light); }

.header-actions { display: flex; gap: 0.4rem; }
.header-btn {
  width: 36px; height: 36px; border-radius: 11px;
  border: none; background: transparent; cursor: pointer;
  color: var(--text-light); font-size: 1rem;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.15s, color 0.15s;
}
.header-btn:hover { background: var(--lavender-light); color: var(--text-dark); }

/* ─── MESSAGES ─── */
#messages-area {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
  scroll-behavior: smooth;
  touch-action: pan-y;
  overscroll-behavior: contain;
}
#messages-area::-webkit-scrollbar { width: 4px; }
#messages-area::-webkit-scrollbar-thumb { background: var(--lavender-light); border-radius: 2px; }

.msg-group { display: flex; flex-direction: column; gap: 0.22rem; margin-bottom: 0.6rem; width: 100%; }
.msg-group.user { align-items: flex-end; }
.msg-group.ai { align-items: flex-start; }

.msg-row {
  display: flex;
  align-items: flex-end;
  gap: 0.5rem;
  max-width: 82%;
}
.msg-group.user .msg-row { margin-left: auto; }
.msg-group.ai .msg-row { margin-right: auto; }
.msg-group.user .msg-row { flex-direction: row-reverse; }
.msg-group.ai .msg-row { }

.msg-avatar {
  width: 30px; height: 30px; border-radius: 10px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 0.9rem; flex-shrink: 0; overflow: hidden;
}
.msg-avatar img { width: 100%; height: 100%; object-fit: cover; }
.msg-avatar-spacer { width: 30px; flex-shrink: 0; }

.msg-bubble {
  padding: 0.65rem 0.95rem;
  border-radius: 18px;
  font-size: 0.9rem;
  line-height: 1.55;
  max-width: 100%;
  word-break: break-word;
  position: relative;
  animation: bubblePop 0.2s cubic-bezier(0.34,1.56,0.64,1);
}

@keyframes bubblePop {
  from { transform: scale(0.85); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.msg-group.ai .msg-bubble {
  background: var(--bubble-ai);
  color: var(--text-dark);
  border-radius: 4px 18px 18px 18px;
  box-shadow: 0 2px 8px var(--shadow);
  border: 1px solid rgba(201,184,232,0.15);
}

.msg-group.user .msg-bubble {
  background: var(--bubble-user);
  color: white;
  border-radius: 18px 18px 4px 18px;
  box-shadow: 0 2px 8px rgba(180,160,220,0.3);
}

/* only first bubble in group shows avatar */
.msg-group .msg-row:not(:first-child) .msg-avatar { visibility: hidden; }

.msg-time {
  font-size: 0.65rem;
  color: var(--text-light);
  padding: 0 0.3rem;
  margin-bottom: 0.15rem;
}

.msg-status { font-size: 0.65rem; color: var(--milk-blue); }

.date-divider {
  display: flex; align-items: center; gap: 0.8rem;
  margin: 1rem 0 0.5rem;
}
.date-divider::before, .date-divider::after {
  content: ''; flex: 1;
  height: 1px; background: rgba(201,184,232,0.3);
}
.date-divider span {
  font-size: 0.7rem; color: var(--text-light);
  background: rgba(201,184,232,0.15);
  padding: 0.2rem 0.7rem;
  border-radius: 10px;
}

/* IMAGE MESSAGES */
.msg-image {
  max-width: 220px; border-radius: 14px;
  overflow: hidden; cursor: pointer;
}
.msg-image img { width: 100%; display: block; }

/* STICKER / EMOTE */
.msg-sticker {
  font-size: 0.82rem;
  color: var(--text-mid);
  font-style: italic;
  padding: 0.4rem 0.8rem;
  background: rgba(201,184,232,0.15);
  border-radius: 12px;
  border: 1px solid rgba(201,184,232,0.25);
}

/* TYPING INDICATOR */
.typing-indicator {
  display: flex; gap: 5px; align-items: center;
  padding: 0.7rem 1rem;
}
.typing-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--lavender);
  animation: typingPulse 1.2s ease infinite;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingPulse {
  0%, 80%, 100% { transform: scale(0.7); opacity: 0.5; }
  40% { transform: scale(1); opacity: 1; }
}

@keyframes slideUp {
  from { transform: translateY(100%); opacity: 0; }
  to   { transform: translateY(0);    opacity: 1; }
}

/* ─── 關係 Banner 動畫 ─── */
@keyframes relBannerIn {
  from { transform: translateY(-100%); opacity: 0; }
  to   { transform: translateY(0);     opacity: 1; }
}
@keyframes relBannerOut {
  from { transform: translateY(0);     opacity: 1; }
  to   { transform: translateY(-100%); opacity: 0; }
}
@keyframes momentBannerIn {
  from { transform: translateX(-50%) translateY(20px) scale(0.9); opacity: 0; }
  to   { transform: translateX(-50%) translateY(0)    scale(1);   opacity: 1; }
}
@keyframes momentBannerOut {
  from { transform: translateX(-50%) scale(1);   opacity: 1; }
  to   { transform: translateX(-50%) scale(0.85); opacity: 0; }
}
@keyframes slideDown {
  from { transform: translateY(-100%); opacity: 0; }
  to   { transform: translateY(0);    opacity: 1; }
}

/* ─── IMAGE GEN MODAL ─── */
.imagegen-type-btn, .imagegen-style-btn {
  border: 2px solid rgba(201,184,232,0.25);
  border-radius: 14px;
  background: rgba(255,255,255,0.7);
  padding: 0.75rem 0.5rem;
  cursor: pointer;
  font-family: inherit;
  color: var(--text-mid);
  text-align: center;
  transition: all 0.15s;
}
.imagegen-type-btn:hover, .imagegen-style-btn:hover {
  border-color: var(--lavender);
  background: var(--lavender-soft);
}
.imagegen-type-btn.active, .imagegen-style-btn.active {
  border-color: var(--lavender);
  background: linear-gradient(135deg, rgba(201,184,232,0.25), rgba(184,204,232,0.18));
  color: var(--text-dark);
  box-shadow: 0 2px 8px var(--shadow), inset 0 0 0 1.5px var(--lavender);
  font-weight: 600;
  transform: translateY(-1px);
}


.chat-img-thumb {
  position: relative;
  width: 52px; height: 52px;
  border-radius: 10px;
  overflow: hidden;
  flex-shrink: 0;
  border: 1.5px solid rgba(201,184,232,0.4);
}
.chat-img-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
.chat-img-thumb .thumb-del {
  position: absolute; top: 2px; right: 2px;
  width: 18px; height: 18px;
  background: rgba(60,40,80,0.7);
  border: none; border-radius: 50%;
  color: white; font-size: 0.65rem;
  cursor: pointer; display: flex;
  align-items: center; justify-content: center;
  line-height: 1;
}


#input-area {
  padding: 0.8rem 1rem;
  background: var(--header-bg);
  backdrop-filter: blur(12px);
  border-top: 1px solid rgba(201,184,232,0.2);
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  flex-shrink: 0;
}

.input-toolbar {
  display: flex;
  gap: 0.3rem;
}
.toolbar-btn {
  width: 32px; height: 32px; border-radius: 9px;
  border: none; background: transparent; cursor: pointer;
  color: var(--text-light); font-size: 0.95rem;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.toolbar-btn:hover { background: var(--lavender-light); color: var(--text-dark); }
.toolbar-btn.active { background: var(--lavender); color: white; }

.input-row {
  display: flex; align-items: flex-end; gap: 0.7rem;
}

#msg-input {
  flex: 1;
  min-height: 42px; max-height: 120px;
  padding: 0.65rem 1rem;
  border: 1.5px solid rgba(201,184,232,0.3);
  border-radius: 20px;
  background: rgba(255,255,255,0.8);
  font-family: inherit;
  font-size: 0.9rem;
  color: var(--text-dark);
  outline: none;
  resize: none;
  line-height: 1.5;
  transition: border-color 0.2s, box-shadow 0.2s;
}
#msg-input:focus {
  border-color: var(--lavender);
  box-shadow: 0 0 0 3px rgba(201,184,232,0.15);
}
#msg-input::placeholder { color: var(--text-light); }

#send-btn {
  width: 42px; height: 42px;
  border-radius: 14px;
  border: none;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  color: white;
  font-size: 1rem;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: transform 0.15s, box-shadow 0.15s;
  flex-shrink: 0;
}
#send-btn:hover { transform: scale(1.08); box-shadow: 0 4px 12px rgba(180,160,220,0.4); }
#send-btn:active { transform: scale(0.95); }

/* ─── PAGES ─── */
.page { display: none; flex: 1; flex-direction: column; overflow: hidden; }
.page.active { display: flex; }

/* ─── CHARACTERS PAGE ─── */
#chars-grid {
  flex: 1; overflow-y: auto;
  padding: 1.2rem;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 1rem;
  align-content: start;
}

.char-card {
  background: rgba(255,255,255,0.85);
  border-radius: 20px;
  padding: 1.2rem 0.9rem;
  text-align: center;
  cursor: pointer;
  box-shadow: 0 2px 12px var(--shadow);
  border: 1.5px solid rgba(201,184,232,0.15);
  transition: transform 0.2s, box-shadow 0.2s;
}
.char-card:hover { transform: translateY(-3px); box-shadow: 0 6px 24px var(--shadow); }

.char-card-avatar {
  width: 72px; height: 72px; border-radius: 22px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 2rem; margin: 0 auto 0.8rem;
  overflow: hidden;
}
.char-card-avatar img { width: 100%; height: 100%; object-fit: cover; }
.char-card-name { font-size: 0.88rem; font-weight: 500; color: var(--text-dark); }
.char-card-desc { font-size: 0.73rem; color: var(--text-light); margin-top: 0.2rem; }

.char-add-card {
  border: 2px dashed rgba(201,184,232,0.4);
  background: rgba(201,184,232,0.06);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 0.5rem;
  color: var(--text-light);
  font-size: 0.82rem;
  cursor: pointer;
  border-radius: 20px;
  min-height: 130px;
  transition: all 0.2s;
}
.char-add-card:hover { border-color: var(--lavender); color: var(--text-mid); background: rgba(201,184,232,0.1); }

/* ─── SHARED: Char Filter Tabs ─── */
.char-filter-tabs {
  display: flex; padding: 0 0.4rem; gap: 0.2rem;
  background: var(--header-bg);
  border-bottom: 1px solid rgba(201,184,232,0.2);
  flex-shrink: 0; overflow-x: auto; scrollbar-width: none;
}
.char-filter-tabs::-webkit-scrollbar { display: none; }
.cft-btn {
  display: flex; align-items: center; gap: 0.32rem;
  padding: 0.65rem 0.8rem;
  border: none; background: none;
  font-family: inherit; font-size: 0.8rem;
  color: var(--text-light); cursor: pointer;
  border-bottom: 2.5px solid transparent;
  white-space: nowrap; flex-shrink: 0;
  transition: color 0.15s, border-color 0.15s;
}
.cft-btn.active { color: var(--lavender); border-bottom-color: var(--lavender); font-weight: 500; }
.cft-av {
  width: 19px; height: 19px; border-radius: 6px;
  background: linear-gradient(135deg,var(--lavender),var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 0.65rem; overflow: hidden; flex-shrink: 0;
}
.cft-av img { width: 100%; height: 100%; object-fit: cover; }

/* ─── SOCIAL PAGE ─── */
#social-page { background: var(--beige-soft); }
.social-feed { flex: 1; overflow-y: auto; padding: 1rem; }

.post-card {
  background: rgba(255,255,255,0.88);
  border-radius: 20px;
  padding: 1.2rem;
  margin-bottom: 1rem;
  box-shadow: 0 2px 10px var(--shadow);
  border: 1px solid rgba(201,184,232,0.12);
}
.post-header { display: flex; align-items: center; gap: 0.7rem; margin-bottom: 0.8rem; }
.post-avatar {
  width: 38px; height: 38px; border-radius: 12px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 1.1rem; overflow: hidden;
}
.post-avatar img { width: 100%; height: 100%; object-fit: cover; }
.post-author { font-size: 0.88rem; font-weight: 500; color: var(--text-dark); }
.post-time { font-size: 0.72rem; color: var(--text-light); }
.post-content { font-size: 0.88rem; color: var(--text-dark); line-height: 1.6; }
.post-image { margin-top: 0.8rem; border-radius: 14px; overflow: hidden; max-width: 320px; }
.post-image img { width: 100%; max-height: 280px; object-fit: cover; display: block; }
.post-actions {
  display: flex; gap: 1rem; margin-top: 0.8rem;
  padding-top: 0.8rem;
  border-top: 1px solid rgba(201,184,232,0.15);
}
.post-action-btn {
  background: none; border: none; cursor: pointer;
  font-size: 0.8rem; color: var(--text-light); font-family: inherit;
  display: flex; align-items: center; gap: 0.3rem;
  transition: color 0.15s;
}
.post-action-btn:hover { color: var(--lavender); }

.post-comments { margin-top: 0.7rem; display: flex; flex-direction: column; gap: 0.5rem; }
.comment-item {
  display: flex; gap: 0.6rem; align-items: flex-start;
}
.comment-avatar {
  width: 28px; height: 28px; border-radius: 9px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 0.8rem; flex-shrink: 0;
}
.comment-bubble {
  background: var(--lavender-soft);
  border-radius: 4px 14px 14px 14px;
  padding: 0.5rem 0.8rem;
  font-size: 0.82rem; color: var(--text-dark);
  line-height: 1.5;
}
.comment-name { font-weight: 500; font-size: 0.75rem; color: var(--lavender); margin-bottom: 0.1rem; }

/* ─── Comment actions (edit / delete) ─── */
.comment-item { position: relative; }
.comment-body { flex: 1; min-width: 0; }
.comment-actions {
  display: flex; gap: 0.22rem; margin-top: 0.18rem;
  opacity: 0; transition: opacity 0.13s;
}
.comment-item:hover .comment-actions { opacity: 1; }
@media (hover: none) { .comment-actions { opacity: 1; } }
.cmt-act-btn {
  background: none; border: none; cursor: pointer;
  font-size: 0.68rem; color: var(--text-light);
  padding: 0.06rem 0.28rem; border-radius: 5px;
  font-family: inherit; transition: background 0.1s, color 0.1s;
}
.cmt-act-btn:hover { background: var(--lavender-light); color: var(--text-dark); }
.cmt-act-btn.del:hover { background: rgba(220,80,80,0.12); color: #c04040; }
.cmt-edit-ta {
  width: 100%; border: 1.5px solid var(--lavender-light); border-radius: 8px;
  outline: none; resize: none; font-family: inherit;
  font-size: 0.82rem; color: var(--text-dark);
  background: white; line-height: 1.5; padding: 0.25rem 0.45rem;
  min-height: 2.3em;
}
.cmt-edit-row { display: flex; gap: 0.3rem; margin-top: 0.25rem; }
.cmt-edit-save {
  padding: 0.18rem 0.62rem; background: var(--lavender); color: white;
  border: none; border-radius: 8px; font-family: inherit;
  font-size: 0.73rem; cursor: pointer;
}
.cmt-edit-cancel {
  padding: 0.18rem 0.62rem; background: var(--lavender-soft); color: var(--text-mid);
  border: 1px solid var(--lavender-light); border-radius: 8px;
  font-family: inherit; font-size: 0.73rem; cursor: pointer;
}

/* ─── Theater history ─── */
.th-item {
  display: flex; align-items: flex-start; gap: 0.5rem;
  padding: 0.55rem 0.7rem; border-radius: 12px;
  border: 1px solid rgba(201,184,232,0.22);
  background: var(--lavender-soft);
  margin-bottom: 0.4rem; cursor: pointer;
  transition: border-color 0.13s, background 0.13s;
}
.th-item:hover { border-color: var(--lavender); background: var(--lavender-light); }
.th-item-body { flex: 1; min-width: 0; }
.th-meta { display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.18rem; }
.th-style { font-size: 0.7rem; color: var(--lavender); font-weight: 500; }
.th-date { font-size: 0.68rem; color: var(--text-light); margin-left: auto; }
.th-del {
  background: none; border: none; cursor: pointer;
  color: var(--text-light); font-size: 0.82rem; padding: 0 0.12rem;
  border-radius: 4px; flex-shrink: 0; line-height: 1;
}
.th-del:hover { background: rgba(220,80,80,0.12); color: #c04040; }
.th-prompt { font-size: 0.78rem; color: var(--text-mid); line-height: 1.4; }

.post-compose {
  background: rgba(255,255,255,0.88);
  border-radius: 20px;
  padding: 1rem;
  margin-bottom: 1rem;
  box-shadow: 0 2px 10px var(--shadow);
  border: 1px solid rgba(201,184,232,0.12);
}
.compose-input {
  width: 100%; min-height: 70px;
  border: none; outline: none; resize: none;
  font-family: inherit; font-size: 0.88rem;
  color: var(--text-dark); background: transparent;
  line-height: 1.6;
}
.compose-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 0.6rem; }
.compose-char-select {
  padding: 0.4rem 0.7rem;
  border: 1px solid var(--lavender-light);
  border-radius: 10px;
  font-family: inherit; font-size: 0.78rem;
  color: var(--text-mid);
  background: var(--lavender-soft);
  outline: none;
}
.compose-post-btn {
  padding: 0.45rem 1.1rem;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  border: none; border-radius: 12px;
  color: white; font-family: inherit;
  font-size: 0.82rem; cursor: pointer;
}

/* PLURK style */
.plurk-timeline {
  position: relative;
  padding-left: 1.5rem;
}
.plurk-timeline::before {
  content: '';
  position: absolute; left: 0.4rem; top: 0; bottom: 0;
  width: 2px; background: linear-gradient(to bottom, var(--lavender-light), transparent);
  border-radius: 1px;
}
.plurk-item {
  position: relative;
  margin-bottom: 1rem;
}
.plurk-dot {
  position: absolute; left: -1.15rem; top: 0.8rem;
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--lavender);
  border: 2px solid white;
  box-shadow: 0 0 0 2px rgba(201,184,232,0.3);
}

/* ─── DIARY PAGE ─── */
#diary-page { background: var(--beige-soft); }

.diary-header {
  padding: 1rem 1.2rem;
  background: var(--header-bg);
  border-bottom: 1px solid rgba(201,184,232,0.2);
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0;
}
.diary-month {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.3rem; font-weight: 300;
  color: var(--text-dark); font-style: italic;
}
.diary-nav-btn {
  width: 32px; height: 32px; border-radius: 10px;
  border: none; background: transparent; cursor: pointer;
  color: var(--text-light); font-size: 1rem;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.diary-nav-btn:hover { background: var(--lavender-light); color: var(--text-dark); }

.diary-calendar {
  display: grid; grid-template-columns: repeat(7, 1fr);
  padding: 0.8rem 1rem;
  gap: 0.3rem;
  border-bottom: 1px solid rgba(201,184,232,0.15);
  flex-shrink: 0;
}
.cal-day-name {
  text-align: center; font-size: 0.7rem;
  color: var(--text-light); padding: 0.2rem;
}
.cal-day {
  text-align: center; padding: 0.4rem;
  border-radius: 10px; font-size: 0.82rem;
  color: var(--text-mid); cursor: pointer;
  transition: all 0.15s; position: relative;
}
.cal-day:hover { background: var(--lavender-light); }
.cal-day.today { background: var(--lavender); color: white; font-weight: 500; }
.cal-day.has-entry::after {
  content: ''; position: absolute;
  bottom: 3px; left: 50%; transform: translateX(-50%);
  width: 4px; height: 4px; border-radius: 50%;
  background: var(--milk-blue);
}
.cal-day.selected { background: var(--lavender-soft); border: 1.5px solid var(--lavender); }

.diary-content { flex: 1; overflow-y: auto; padding: 1.2rem; }
.diary-entry {
  background: rgba(255,255,255,0.88);
  border-radius: 20px;
  padding: 1.5rem;
  box-shadow: 0 2px 12px var(--shadow);
  border: 1px solid rgba(201,184,232,0.15);
}
.diary-entry-date {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.1rem; font-style: italic;
  color: var(--text-mid);
}
.diary-entry-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 0.8rem;
}
.diary-regen-btn {
  padding: 0.3rem 0.75rem;
  background: var(--lavender-soft);
  border: 1.5px solid var(--lavender-light);
  border-radius: 20px;
  font-family: inherit; font-size: 0.72rem;
  color: var(--text-mid); cursor: pointer;
  transition: all 0.15s; white-space: nowrap;
}
.diary-regen-btn:hover {
  background: var(--lavender-light);
  color: var(--text-dark);
  border-color: var(--lavender);
}
.diary-entry-char {
  display: flex; align-items: center; gap: 0.6rem;
  margin-bottom: 1rem; padding-bottom: 0.8rem;
  border-bottom: 1px solid rgba(201,184,232,0.15);
}
.diary-char-avatar {
  width: 32px; height: 32px; border-radius: 10px;
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 0.9rem; overflow: hidden;
}
.diary-char-avatar img { width: 100%; height: 100%; object-fit: cover; }
.diary-char-name { font-size: 0.82rem; font-weight: 500; color: var(--lavender); }
.diary-entry-text {
  font-size: 0.88rem; color: var(--text-dark);
  line-height: 1.8; white-space: pre-wrap;
}
.diary-empty {
  text-align: center; color: var(--text-light);
  font-size: 0.88rem; padding: 3rem 1rem;
  font-style: italic;
}

/* Diary style picker buttons */
.diary-style-btn {
  padding: 0.35rem 0.8rem;
  border-radius: 20px;
  border: 1.5px solid var(--lavender-light);
  background: var(--lavender-soft);
  font-family: inherit;
  font-size: 0.75rem;
  color: var(--text-mid);
  cursor: pointer;
  transition: all 0.15s;
}
.diary-style-btn:hover { border-color: var(--lavender); color: var(--text-dark); }
.diary-style-btn.active {
  background: var(--lavender);
  border-color: var(--lavender);
  color: white;
  font-weight: 500;
}

/* ─── LOREBOOK (SillyTavern Style) ─── */
.lb-entry {
  border: 1.5px solid rgba(201,184,232,0.22);
  border-radius: 14px;
  overflow: hidden;
  background: white;
  transition: box-shadow 0.2s, border-color 0.2s;
}
.lb-entry:hover { box-shadow: 0 2px 12px rgba(180,160,210,0.13); }
.lb-entry.lb-open {
  border-color: var(--lavender);
  box-shadow: 0 4px 20px rgba(180,160,210,0.18);
}

.lb-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.6rem 0.85rem;
  cursor: pointer;
  background: var(--lavender-soft);
  user-select: none;
  gap: 0.5rem;
  transition: background 0.15s;
}
.lb-entry.lb-open .lb-header { background: rgba(201,184,232,0.2); border-bottom: 1px solid rgba(201,184,232,0.2); }
.lb-header:hover { background: rgba(201,184,232,0.18); }

.lb-entry-left { display: flex; align-items: center; gap: 0.5rem; min-width: 0; flex: 1; }
.lb-entry-right { display: flex; align-items: center; gap: 0.45rem; flex-shrink: 0; }

/* Enable toggle (nice visual switch) */
.lb-toggle {
  width: 28px; height: 16px;
  border-radius: 8px;
  border: none;
  background: var(--lavender-light);
  position: relative;
  cursor: pointer;
  flex-shrink: 0;
  transition: background 0.2s;
  padding: 0;
}
.lb-toggle.on { background: var(--lavender); }
.lb-toggle::after {
  content: '';
  position: absolute; top: 2px; left: 2px;
  width: 12px; height: 12px;
  border-radius: 50%; background: white;
  transition: transform 0.2s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.lb-toggle.on::after { transform: translateX(12px); }

.lb-badge { font-size: 0.63rem; padding: 0.12rem 0.4rem; border-radius: 6px; font-weight: 700; letter-spacing: 0.03em; }
.lb-const { background: rgba(168,216,168,0.35); color: #3d7a3d; }
.lb-sel   { background: rgba(184,212,232,0.45); color: #3d6080; }

.lb-name { font-size: 0.84rem; color: var(--text-dark); font-weight: 600;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
.lb-keys-preview { font-size: 0.7rem; color: var(--text-light); max-width: 120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.lb-order { font-size: 0.65rem; color: var(--lavender); font-family: monospace;
  background: rgba(201,184,232,0.25); padding: 0.1rem 0.4rem; border-radius: 5px; }
.lb-del-btn { background: none; border: none; cursor: pointer; color: rgba(200,136,136,0.7);
  font-size: 1rem; line-height: 1; padding: 0.1rem 0.2rem; border-radius: 6px; transition: all 0.15s; }
.lb-del-btn:hover { color: #e87878; background: rgba(232,120,120,0.08); }

.lb-body {
  padding: 1rem 1.1rem 0.9rem;
  border-top: none;
  display: flex; flex-direction: column; gap: 0.75rem;
  background: linear-gradient(to bottom, rgba(243,239,249,0.3), white);
}

.lb-row-2col { display: flex; gap: 0.65rem; }
.lb-row-flags { display: flex; gap: 0.6rem; flex-wrap: wrap; align-items: flex-end; }
.lb-field { display: flex; flex-direction: column; gap: 0.28rem; flex: 1; }
.lb-label {
  font-size: 0.69rem; color: var(--text-light); font-weight: 600;
  letter-spacing: 0.06em; text-transform: uppercase;
}
.lb-input {
  padding: 0.5rem 0.75rem;
  border: 1.5px solid var(--lavender-light);
  border-radius: 10px;
  font-family: inherit; font-size: 0.83rem;
  color: var(--text-dark); background: var(--lavender-soft);
  outline: none; width: 100%;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.lb-input:focus { border-color: var(--lavender); box-shadow: 0 0 0 3px rgba(201,184,232,0.15); }
.lb-select {
  padding: 0.5rem 0.75rem;
  border: 1.5px solid var(--lavender-light);
  border-radius: 10px;
  font-family: inherit; font-size: 0.83rem;
  color: var(--text-dark); background: var(--lavender-soft);
  outline: none; width: 100%;
  transition: border-color 0.15s;
}
.lb-select:focus { border-color: var(--lavender); }
.lb-textarea {
  padding: 0.6rem 0.85rem;
  border: 1.5px solid var(--lavender-light);
  border-radius: 10px;
  font-family: inherit; font-size: 0.83rem;
  color: var(--text-dark); background: var(--lavender-soft);
  outline: none; resize: vertical; min-height: 100px; line-height: 1.6; width: 100%;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.lb-textarea:focus { border-color: var(--lavender); box-shadow: 0 0 0 3px rgba(201,184,232,0.15); }

/* Flags section */
.lb-flags-group {
  display: flex; flex-wrap: wrap; gap: 0.5rem;
  padding: 0.65rem 0.8rem;
  background: rgba(201,184,232,0.07);
  border-radius: 10px;
  border: 1px solid rgba(201,184,232,0.15);
}
.lb-checkbox-label {
  display: flex; align-items: center; gap: 0.4rem;
  font-size: 0.76rem; color: var(--text-mid); cursor: pointer; white-space: nowrap;
  padding: 0.2rem 0.5rem;
  border-radius: 8px;
  transition: background 0.15s;
}
.lb-checkbox-label:hover { background: rgba(201,184,232,0.2); }
.lb-checkbox-label input { accent-color: var(--lavender); cursor: pointer; }

.lb-save-btn {
  flex: 1; padding: 0.6rem; background: linear-gradient(135deg,var(--lavender),var(--milk-blue));
  border: none; border-radius: 11px; color: white;
  font-family: inherit; font-size: 0.85rem; cursor: pointer; font-weight: 500;
  transition: opacity 0.15s, transform 0.15s;
}
.lb-save-btn:hover { opacity: 0.9; transform: translateY(-1px); }
.lb-cancel-btn {
  padding: 0.6rem 1rem;
  background: var(--lavender-soft); border: 1.5px solid var(--lavender-light);
  border-radius: 11px; color: var(--text-mid);
  font-family: inherit; font-size: 0.85rem; cursor: pointer;
  transition: background 0.15s;
}
.lb-cancel-btn:hover { background: rgba(201,184,232,0.2); }

/* ST info bar inside lorebook */
.lb-st-info {
  display: flex; gap: 0.5rem; align-items: center;
  padding: 0.5rem 0.7rem;
  background: rgba(201,184,232,0.1);
  border-radius: 8px;
  font-size: 0.7rem; color: var(--text-light);
  border: 1px dashed rgba(201,184,232,0.3);
}

/* Lorebook modal count badge */
#lb-count {
  background: rgba(201,184,232,0.2);
  border-radius: 20px;
  padding: 0.15rem 0.6rem;
  font-size: 0.72rem;
  color: var(--lavender);
  font-weight: 500;
}

/* ─── SETTINGS PAGE ─── */
#settings-page { background: var(--beige-soft); overflow-y: auto; }

.settings-section {
  padding: 1.2rem;
  border-bottom: 1px solid rgba(201,184,232,0.12);
}
.settings-section-title {
  font-size: 0.72rem; color: var(--text-light);
  letter-spacing: 0.12em; text-transform: uppercase;
  margin-bottom: 0.8rem;
}
.settings-item {
  background: rgba(255,255,255,0.85);
  border-radius: 14px;
  padding: 0.9rem 1rem;
  margin-bottom: 0.5rem;
  display: flex; align-items: center; gap: 0.8rem;
  cursor: pointer;
  border: 1px solid rgba(201,184,232,0.1);
  transition: background 0.15s;
}
.settings-item:hover { background: rgba(255,255,255,0.95); }
.settings-item-icon { width: 32px; height: 32px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
.settings-item-label { flex: 1; font-size: 0.88rem; color: var(--text-dark); }
.settings-item-value { font-size: 0.78rem; color: var(--text-light); }
.settings-item-arrow { color: var(--text-light); font-size: 0.8rem; }

.toggle-switch {
  width: 42px; height: 24px;
  background: var(--lavender-light);
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: background 0.2s;
}
.toggle-switch.on { background: var(--lavender); }
.toggle-switch::after {
  content: '';
  position: absolute; top: 3px; left: 3px;
  width: 18px; height: 18px;
  border-radius: 50%; background: white;
  transition: transform 0.2s;
  box-shadow: 0 1px 4px rgba(0,0,0,0.15);
}
.toggle-switch.on::after { transform: translateX(18px); }

/* ─── MODALS ─── */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(61,52,80,0.4);
  backdrop-filter: blur(8px);
  z-index: 800;
  display: none; align-items: center; justify-content: center;
  padding: 1rem;
}
.modal-overlay.open { display: flex; }

.modal {
  background: white;
  border-radius: 24px;
  padding: 1.8rem;
  width: min(480px, 96vw);
  max-height: 90dvh;
  overflow-y: auto;
  box-shadow: 0 12px 48px var(--shadow-deep);
  animation: modalIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes modalIn {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
.modal-title { font-size: 1.1rem; font-weight: 700; color: var(--text-dark); margin-bottom: 1.2rem; }
.modal-field { margin-bottom: 1rem; }
.modal-label { display: block; font-size: 0.78rem; color: var(--text-mid); margin-bottom: 0.4rem; }
.modal-input, .modal-select, .modal-textarea {
  width: 100%; padding: 0.75rem 1rem;
  border: 1.5px solid var(--lavender-light);
  border-radius: 12px;
  font-family: inherit; font-size: 0.88rem;
  color: var(--text-dark);
  background: var(--lavender-soft);
  outline: none;
}
.modal-textarea { min-height: 90px; resize: vertical; }
.modal-actions { display: flex; gap: 0.5rem; margin-top: 1.2rem; }
.modal-btn {
  flex: 1; padding: 0.8rem;
  border-radius: 14px; border: none;
  font-family: inherit; font-size: 0.88rem;
  cursor: pointer; transition: all 0.15s;
}
.modal-btn.primary {
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  color: white;
}
.modal-btn.secondary {
  background: var(--lavender-soft);
  color: var(--text-mid);
  border: 1px solid var(--lavender-light);
}
.modal-btn:hover { opacity: 0.9; }

/* TABS inside modal */
.modal-tabs { display: flex; gap: 0.3rem; margin-bottom: 1rem; }
.modal-tab {
  flex: 1; padding: 0.5rem;
  border-radius: 10px; border: none;
  font-family: inherit; font-size: 0.78rem;
  cursor: pointer; transition: all 0.15s;
  background: var(--lavender-soft);
  color: var(--text-light);
}
.modal-tab.active {
  background: var(--lavender);
  color: white;
}
.modal-tab-content { display: none; }
.modal-tab-content.active { display: block; }

/* ─── MEMORY PANEL ─── */
#memory-panel {
  width: 260px;
  background: rgba(243,239,249,0.95);
  border-left: 1px solid rgba(201,184,232,0.2);
  display: none;
  flex-direction: column;
  flex-shrink: 0;
}
#memory-panel.open { display: flex; }

.memory-header {
  padding: 1rem 1rem 0.8rem;
  border-bottom: 1px solid rgba(201,184,232,0.15);
}
.memory-title { font-size: 0.88rem; font-weight: 500; color: var(--text-dark); }
.memory-list { flex: 1; overflow-y: auto; padding: 0.8rem; }
.memory-category {
  margin-bottom: 1rem;
}
.memory-cat-title {
  font-size: 0.68rem; color: var(--text-light);
  letter-spacing: 0.1em; text-transform: uppercase;
  margin-bottom: 0.4rem;
}
.memory-item {
  background: rgba(255,255,255,0.8);
  border-radius: 10px;
  padding: 0.5rem 0.7rem;
  margin-bottom: 0.35rem;
  font-size: 0.78rem;
  color: var(--text-dark);
  line-height: 1.4;
  border: 1px solid rgba(201,184,232,0.1);
  position: relative;
}
.memory-item .del-mem {
  position: absolute; right: 0.4rem; top: 0.3rem;
  font-size: 0.65rem; color: var(--text-light);
  cursor: pointer;
}
.memory-item .del-mem:hover { color: #e8a0b8; }

.memory-add-btn {
  margin: 0 0.8rem 0.8rem;
  padding: 0.5rem;
  background: rgba(201,184,232,0.15);
  border: 1.5px dashed rgba(201,184,232,0.35);
  border-radius: 10px;
  font-family: inherit; font-size: 0.78rem;
  color: var(--text-light); cursor: pointer;
  transition: all 0.2s;
}
.memory-add-btn:hover { background: rgba(201,184,232,0.25); color: var(--text-mid); }

/* ─── EMPTY STATE ─── */
.empty-state {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 1rem; color: var(--text-light);
  padding: 2rem;
}
.empty-state-icon { font-size: 3rem; opacity: 0.4; }
.empty-state-text { font-size: 0.88rem; text-align: center; line-height: 1.6; }
.empty-state-sub { font-size: 0.78rem; opacity: 0.7; }

/* ─── CONTEXT MENU ─── */
.ctx-menu {
  position: fixed;
  background: white;
  border-radius: 14px;
  box-shadow: 0 8px 32px var(--shadow), 0 2px 8px var(--shadow-deep);
  border: 1px solid rgba(201,184,232,0.2);
  z-index: 900;
  overflow: hidden;
  min-width: 160px;
  animation: ctxIn 0.15s ease;
  display: none;
}
.ctx-menu.open { display: block; }
@keyframes ctxIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.ctx-item {
  padding: 0.65rem 1rem;
  font-size: 0.85rem; color: var(--text-dark);
  cursor: pointer; transition: background 0.1s;
  display: flex; align-items: center; gap: 0.5rem;
}
.ctx-item:hover { background: var(--lavender-soft); }
.ctx-item.danger { color: #e87878; }
.ctx-divider { height: 1px; background: rgba(201,184,232,0.2); margin: 0.2rem 0; }

/* ─── TOAST ─── */
.toast {
  position: fixed;
  bottom: calc(env(safe-area-inset-bottom) + 80px);
  left: 50%; transform: translateX(-50%) translateY(20px);
  background: rgba(61,52,80,0.9);
  color: white; font-size: 0.82rem;
  padding: 0.6rem 1.2rem; border-radius: 20px;
  opacity: 0; transition: all 0.3s;
  z-index: 1000; white-space: nowrap;
  pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ─── BOTTOM NAV (Mobile) ─── */
#bottom-nav {
  display: none;
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--header-bg);
  backdrop-filter: blur(12px);
  border-top: 1px solid rgba(201,184,232,0.2);
  padding: 0.5rem 0 calc(0.5rem + env(safe-area-inset-bottom));
  z-index: 200;
  justify-content: space-around;
}
.bottom-nav-btn {
  display: flex; flex-direction: column; align-items: center; gap: 0.2rem;
  background: none; border: none; cursor: pointer;
  padding: 0.3rem 0.6rem;
  color: var(--text-light); font-size: 0.62rem;
  transition: color 0.15s;
}
.bottom-nav-btn .icon { font-size: 1.3rem; }
.bottom-nav-btn.active { color: var(--lavender); }

/* ─── RESPONSIVE ─── */
@media (max-width: 768px) {
  #side-nav { display: none; }
  #sidebar {
    position: fixed;
    top: 0; left: 0; right: 0;
    bottom: 60px; /* above bottom-nav */
    width: 100%; z-index: 150;
    transform: translateX(-100%);
    transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
    overflow-y: auto;
  }
  #sidebar.mobile-open { transform: translateX(0); }
  #bottom-nav { display: flex; }
  #main-area { padding-bottom: 60px; }
  #memory-panel { position: fixed; inset: 0; z-index: 300; width: 100%; }
  .page { padding-bottom: 0; }
  /* 手機版聊天列表項目加大點擊區域 */
  .chat-item { padding: 0.65rem 0.7rem; }
  /* add-chat-btn 在 header 裡已是 ＋ 小按鈕，不需要底部大按鈕 */
  .add-chat-btn { display: none; }
  /* 手機版返回按鈕顯示 */
  #mobile-back-btn { display: block !important; }
}

@media (min-width: 769px) {
  #app { }
}

/* Scrollbar global */
* { scrollbar-width: thin; scrollbar-color: rgba(201,184,232,0.3) transparent; }

/* ─── THEATER PAGE ─── */
#theater-page { background: var(--beige-soft); }

/* ─── ACHIEVEMENTS ─── */
#achievements-page { background: var(--beige-soft); }
.achievement-stat-card {
  background: rgba(255,255,255,0.88);
  border-radius: 16px;
  padding: 0.8rem;
  text-align: center;
  box-shadow: 0 2px 8px var(--shadow);
  border: 1px solid rgba(201,184,232,0.12);
}
.achievement-stat-num {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.8rem; font-weight: 300;
  color: var(--lavender);
}
.achievement-stat-label {
  font-size: 0.65rem; color: var(--text-light);
  letter-spacing: 0.06em; margin-top: 0.2rem;
}
.achievement-item {
  background: rgba(255,255,255,0.88);
  border-radius: 16px;
  padding: 1rem;
  display: flex; align-items: center; gap: 0.9rem;
  box-shadow: 0 2px 8px var(--shadow);
  border: 1px solid rgba(201,184,232,0.12);
  transition: all 0.2s;
  position: relative; overflow: hidden;
}
.achievement-item.locked {
  opacity: 0.5; filter: grayscale(0.6);
}
.achievement-item.unlocked {
  border-color: rgba(201,184,232,0.4);
  box-shadow: 0 4px 16px rgba(180,160,210,0.2);
}
.achievement-item.unlocked::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--lavender), var(--milk-blue));
}
.achievement-icon {
  width: 48px; height: 48px; border-radius: 14px;
  background: linear-gradient(135deg, var(--lavender-soft), var(--milk-blue-soft));
  display: flex; align-items: center; justify-content: center;
  font-size: 1.5rem; flex-shrink: 0;
  border: 1.5px solid rgba(201,184,232,0.2);
}
.achievement-item.unlocked .achievement-icon {
  background: linear-gradient(135deg, var(--lavender), var(--milk-blue));
  border-color: transparent;
}
.achievement-info { flex: 1; }
.achievement-name {
  font-size: 0.88rem; font-weight: 600; color: var(--text-dark);
  margin-bottom: 0.2rem;
}
.achievement-desc { font-size: 0.75rem; color: var(--text-light); line-height: 1.4; }
.achievement-progress {
  margin-top: 0.4rem;
  height: 4px; background: rgba(201,184,232,0.2);
  border-radius: 2px; overflow: hidden;
}
.achievement-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--lavender), var(--milk-blue));
  border-radius: 2px;
  transition: width 0.6s ease;
}
.achievement-badge {
  font-size: 0.65rem; font-weight: 700;
  padding: 0.2rem 0.5rem; border-radius: 8px;
  background: var(--lavender); color: white;
  white-space: nowrap; flex-shrink: 0;
}
.achievement-item.locked .achievement-badge {
  background: var(--lavender-light); color: var(--text-light);
}

/* ─── ANNIVERSARY ITEM ─── */
.anniversary-item {
  background: rgba(255,255,255,0.85);
  border-radius: 14px;
  padding: 0.8rem 1rem;
  display: flex; align-items: center; gap: 0.8rem;
  border: 1px solid rgba(201,184,232,0.15);
  margin-bottom: 0.4rem;
}
.anniversary-icon {
  font-size: 1.3rem; flex-shrink: 0;
}
.anniversary-info { flex: 1; }
.anniversary-name { font-size: 0.85rem; font-weight: 500; color: var(--text-dark); }
.anniversary-days {
  font-size: 0.72rem; color: var(--lavender);
  margin-top: 0.1rem;
}
.anniversary-del {
  background: none; border: none; cursor: pointer;
  color: var(--text-light); font-size: 0.9rem;
  padding: 0.2rem; border-radius: 6px;
  transition: color 0.15s;
}
.anniversary-del:hover { color: #e87878; }

/* ─── INLINE MESSAGE EDIT ─── */
.msg-edit-area {
  width: 100%;
  padding: 0.5rem 0.8rem;
  border: 1.5px solid var(--lavender);
  border-radius: 14px;
  font-family: inherit; font-size: 0.88rem;
  color: var(--text-dark);
  background: rgba(255,255,255,0.9);
  outline: none; resize: none;
  min-height: 40px; max-height: 120px;
  line-height: 1.5;
}
.msg-edit-actions {
  display: flex; gap: 0.4rem; margin-top: 0.3rem; justify-content: flex-end;
}
.msg-edit-btn {
  padding: 0.3rem 0.8rem;
  border-radius: 10px; border: none;
  font-family: inherit; font-size: 0.78rem;
  cursor: pointer; transition: all 0.15s;
}
.msg-edit-btn.confirm {
  background: var(--lavender); color: white;
}
.msg-edit-btn.cancel {
  background: var(--lavender-soft); color: var(--text-mid);
  border: 1px solid var(--lavender-light);
}

/* ── Message Hover Actions ── */
.msg-row {
  position: relative;
}
.msg-actions {
  position: absolute;
  top: 50%; transform: translateY(-50%);
  display: flex; gap: 0.2rem; align-items: center;
  opacity: 0; pointer-events: none;
  transition: opacity 0.15s;
  z-index: 10;
  background: rgba(255,255,255,0.97);
  border: 1px solid rgba(201,184,232,0.3);
  border-radius: 12px; padding: 0.25rem 0.3rem;
  box-shadow: 0 2px 10px rgba(180,160,210,0.2);
  backdrop-filter: blur(8px);
  white-space: nowrap;
}
.msg-actions-left  { right: calc(100% + 6px); }
.msg-actions-right { left: calc(100% + 6px); }
@media (hover: hover) {
  .msg-row:hover .msg-actions { opacity: 1; pointer-events: auto; }
}
/* Mobile long-press: 固定在氣泡正下方，不會超出螢幕 */
.msg-actions.mobile-show {
  opacity: 1; pointer-events: auto;
  position: fixed;
  top: auto !important; bottom: 80px;
  left: 50% !important; right: auto !important;
  transform: translateX(-50%) !important;
  z-index: 999;
  box-shadow: 0 4px 24px rgba(150,120,200,0.25);
  border-radius: 16px;
  padding: 0.4rem 0.5rem;
  gap: 0.4rem;
}
.msg-actions.mobile-show .msg-action-btn {
  font-size: 1rem; padding: 0.35rem 0.5rem;
}
.msg-action-btn {
  background: none; border: none; cursor: pointer;
  font-size: 0.82rem; padding: 0.2rem 0.3rem;
  border-radius: 7px; line-height: 1;
  transition: background 0.12s;
  color: var(--text-mid);
}
.msg-action-btn:hover { background: var(--lavender-soft); }
.msg-action-btn.danger:hover { background: #fff0f0; }

/* 每則訊息旁的小刪除鍵（始終可見，mobile 友善） */
.msg-del-btn {
  flex-shrink: 0;
  width: 20px; height: 20px;
  border-radius: 50%;
  border: none;
  background: rgba(201,184,232,0.0);
  color: var(--text-light);
  font-size: 0.85rem;
  line-height: 1;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  align-self: center;
  opacity: 0.3;
  transition: opacity 0.15s, background 0.15s, color 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.msg-row:hover .msg-del-btn,
.msg-del-btn:focus {
  opacity: 1;
  background: rgba(232,120,120,0.12);
  color: #e87878;
}
.msg-del-btn:active {
  background: rgba(232,120,120,0.25);
  color: #d04040;
}

/* ── Persona UI ── */
.persona-card {
  display: flex; align-items: center; gap: 0.9rem;
  background: rgba(255,255,255,0.88);
  border: 1.5px solid rgba(201,184,232,0.2);
  border-radius: 16px; padding: 0.9rem;
  transition: border-color 0.15s;
}
.persona-card:hover { border-color: rgba(201,184,232,0.5); }
.persona-card.active-persona { border-color: var(--lavender); background: var(--lavender-soft); }
.persona-avatar {
  width: 52px; height: 52px; border-radius: 16px;
  background: linear-gradient(135deg,var(--lavender),var(--milk-blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 1.6rem; overflow: hidden; flex-shrink: 0;
}
.persona-avatar img { width: 100%; height: 100%; object-fit: cover; }
.persona-tag {
  font-size: 0.67rem; background: rgba(201,184,232,0.25);
  color: var(--lavender); padding: 0.12rem 0.45rem;
  border-radius: 8px; white-space: nowrap;
}

/* ── Lorebook Tabs ── */
.lb-scope-badge {
  display: inline-flex; align-items: center; gap: 0.3rem;
  font-size: 0.68rem; padding: 0.2rem 0.6rem;
  border-radius: 8px; font-weight: 500;
}
.lb-scope-badge.global { background: rgba(100,180,100,0.12); color: #4a9a4a; }
.lb-scope-badge.char   { background: rgba(201,184,232,0.25); color: var(--lavender); }
.lb-scope-badge.chat   { background: rgba(100,150,220,0.12); color: #4470bb; }

/* ─── FRAGMENT GALLERY ─── */
.fragment-card {
  background: rgba(255,255,255,0.9);
  border-radius: 18px;
  padding: 1rem 0.8rem;
  text-align: center;
  border: 1.5px solid rgba(201,184,232,0.15);
  box-shadow: 0 2px 8px var(--shadow);
  position: relative; overflow: hidden;
  transition: all 0.2s;
}
.fragment-card.unlocked {
  cursor: pointer;
  border-color: rgba(201,184,232,0.45);
  box-shadow: 0 4px 16px rgba(180,160,210,0.25);
}
.fragment-card.unlocked:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(180,160,210,0.35); }
.fragment-card.locked { opacity: 0.55; }
.fragment-card-glow {
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, var(--lavender), var(--milk-blue));
}
.moment-card {
  background: rgba(255,255,255,0.9);
  border-radius: 18px; padding: 1rem; text-align: center;
  border: 1.5px solid rgba(201,184,232,0.2);
  box-shadow: 0 2px 8px var(--shadow);
  cursor: pointer; transition: all 0.2s;
}
.moment-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(180,160,210,0.3); }
.daily-topic-chip:hover { background: rgba(201,184,232,0.28); border-color: var(--lavender); }
.achievement-tab-content { display: none; }
.achievement-tab-content.active { display: block; }
@keyframes fragmentPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* ─── DAILY TOPICS BAR ─── */
.daily-topics-bar {
  padding: 0.7rem 1rem 0.6rem;
  background: var(--lavender-soft);
  border-top: 1px solid rgba(201,184,232,0.2);
  border-bottom: 1px solid rgba(201,184,232,0.12);
}
.dt-title {
  font-size: 0.72rem;
  font-weight: 700;
  color: var(--lavender);
  letter-spacing: 0.07em;
}
.dt-loading {
  font-size: 0.78rem;
  color: var(--text-light);
  padding: 0.2rem 0;
  font-style: italic;
}
.dt-close-btn {
  background: none;
  border: none;
  color: var(--text-light);
  cursor: pointer;
  font-size: 0.95rem;
  padding: 0.1rem 0.25rem;
  border-radius: 6px;
  line-height: 1;
  transition: color 0.15s;
}
.dt-close-btn:hover { color: var(--text-dark); }
.dt-regen-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 0.82rem;
  padding: 0.1rem 0.3rem;
  border-radius: 6px;
  opacity: 0.6;
  transition: opacity 0.15s;
  line-height: 1;
}
.dt-regen-btn:hover { opacity: 1; }
.daily-topic-chip {
  display: flex;
  align-items: baseline;
  gap: 0.35rem;
  padding: 0.5rem 0.8rem;
  background: rgba(255,255,255,0.75);
  border: 1px solid rgba(201,184,232,0.3);
  border-radius: 14px;
  cursor: pointer;
  transition: all 0.15s;
  line-height: 1.45;
}
.daily-topic-chip:hover {
  background: rgba(201,184,232,0.2);
  border-color: var(--lavender);
  transform: translateX(2px);
}
.dt-chip-icon { font-size: 1rem; flex-shrink: 0; }
.dt-chip-label {
  font-size: 0.62rem;
  font-weight: 700;
  color: var(--lavender);
  white-space: nowrap;
  flex-shrink: 0;
  letter-spacing: 0.04em;
}
.dt-chip-text {
  font-size: 0.8rem;
  color: var(--text-dark);
  line-height: 1.45;
}

/* ─── DAILY TOPICS DARK MODE ─── */
[data-theme="dark"] .daily-topics-bar {
  background: rgba(30,26,42,0.97);
  border-color: rgba(168,154,204,0.15);
}
[data-theme="dark"] .dt-title { color: #b8a8d8; }
[data-theme="dark"] .dt-loading { color: #7a6e8a; }
[data-theme="dark"] .dt-close-btn { color: #6a5e7a; }
[data-theme="dark"] .dt-close-btn:hover { color: #b8a8d8; }
[data-theme="dark"] .daily-topic-chip {
  background: rgba(42,36,56,0.9);
  border-color: rgba(168,154,204,0.2);
}
[data-theme="dark"] .daily-topic-chip:hover {
  background: rgba(60,50,80,0.95);
  border-color: rgba(168,154,204,0.5);
}
[data-theme="dark"] .dt-chip-text { color: #d4c8e8; }
[data-theme="dark"] .dt-chip-label { color: #b8a0d8; }
</style>
</head>
<body>

<!-- SETUP SCREEN -->
<div id="setup-screen">
  <div class="setup-card">
    <div class="setup-logo">erhabene</div>
    <div class="setup-tagline">your intimate ai companion</div>
    
    <div class="setup-field">
      <label class="setup-label">🔑 Google AI API Key</label>
      <input class="setup-input" type="password" id="api-key-input" placeholder="AIza..." autocomplete="off">
    </div>
    
    <div class="setup-field">
      <label class="setup-label">🤖 模型名稱（可自行輸入）</label>
      <input class="setup-input" type="text" id="model-custom-input-setup"
        placeholder="例：gemini-3-flash-preview"
        list="model-datalist-setup"
        value="gemini-3-flash-preview">
      <datalist id="model-datalist-setup">
        <option value="gemini-3-flash-preview">Gemini 3 Flash Preview（最新）</option>
        <option value="gemini-3-pro-preview">Gemini 3 Pro Preview（最新）</option>
        <option value="gemini-3-flash-exp">Gemini 3 Flash Exp</option>
        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
      </datalist>
      <div style="font-size:0.72rem;color:var(--text-light);margin-top:0.4rem;">直接輸入 API 模型 ID，或從下拉清單選擇</div>
    </div>
    <!-- hidden select for backward compat -->
    <select id="model-select" style="display:none">
      <option value="gemini-3-flash-preview">Gemini 3 Flash Preview</option>
    </select>
    
    <button class="setup-btn" onclick="enterApp()">進入 erhabene ✦</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none;">
  
  <!-- Side Nav -->
  <nav id="side-nav">
    <div class="nav-logo">e</div>
    <button class="nav-btn active" onclick="switchPage('foyer')" title="玄關" id="nav-foyer">🏠</button>
    <button class="nav-btn" onclick="switchPage('chat')" title="聊天" id="nav-chat">💬</button>
    <button class="nav-btn" onclick="switchPage('chars')" title="角色" id="nav-chars">🌸</button>
    <button class="nav-btn" onclick="switchPage('social')" title="社群" id="nav-social">✦</button>
    <button class="nav-btn" onclick="switchPage('diary')" title="日記" id="nav-diary">📔</button>
    <button class="nav-btn" onclick="switchPage('theater')" title="小劇場" id="nav-theater">🎭</button>
    <button class="nav-btn" onclick="switchPage('achievements')" title="成就" id="nav-achievements">🏆</button>
    <div class="nav-spacer"></div>
    <button class="nav-btn" onclick="openModal('memory-modal')" title="長期記憶">🧠</button>
    <button class="nav-btn" onclick="openModal('lorebook-modal')" title="Lorebook">📚</button>
    <button class="nav-btn" onclick="switchPage('settings')" title="設定" id="nav-settings">⚙️</button>
  </nav>

  <!-- Sidebar -->
  <aside id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title" id="sidebar-title">聊天</div>
      <button id="sidebar-add-btn" onclick="showAddChatOrChar()" style="border:none;background:none;font-size:1.35rem;cursor:pointer;color:var(--lavender);line-height:1;padding:0 0.1rem;" title="新增對話">＋</button>
    </div>
    <div class="sidebar-list" id="sidebar-list"></div>
  </aside>

  <!-- Main Area -->
  <div id="main-area">

    <!-- FOYER PAGE 玄關 -->
    <div class="page active" id="foyer-page" style="overflow-y:auto;position:relative;">
      <style>
        #foyer-page {
          background: linear-gradient(160deg, #1e1630 0%, #2a1f40 40%, #1a2535 100%);
          min-height: 100%;
        }
        .foyer-bg {
          position: absolute;
          inset: 0;
          background-image: url('');
          background-size: cover;
          background-position: center;
          opacity: 0.35;
          transition: opacity 0.5s;
          pointer-events: none;
          z-index: 0;
        }
        .foyer-content {
          position: relative;
          z-index: 1;
          padding: 2.5rem 1.4rem 7rem;
          display: flex;
          flex-direction: column;
          gap: 1.4rem;
          max-width: 520px;
          margin: 0 auto;
        }
        .foyer-logo {
          font-family: 'Cormorant Garamond', serif;
          font-style: italic;
          font-size: 1.7rem;
          color: rgba(255,255,255,0.88);
          letter-spacing: 0.04em;
        }
        .foyer-section-label {
          font-size: 0.6rem;
          letter-spacing: 0.2em;
          text-transform: uppercase;
          color: rgba(255,255,255,0.38);
          margin-bottom: 0.5rem;
        }
        .foyer-paper-card {
          display: flex;
          align-items: center;
          gap: 0.85rem;
          background: rgba(255,255,255,0.1);
          backdrop-filter: blur(18px);
          -webkit-backdrop-filter: blur(18px);
          border: 1px solid rgba(255,255,255,0.18);
          border-radius: 16px;
          padding: 0.85rem 1rem;
          cursor: pointer;
          transition: all 0.2s;
          position: relative;
          margin-bottom: 0.6rem;
        }
        .foyer-paper-card:hover { background: rgba(255,255,255,0.16); transform: translateY(-1px); }
        .foyer-paper-card.read { opacity: 0.5; }
        .foyer-paper-unread { position:absolute;top:10px;right:10px;width:7px;height:7px;border-radius:50%;background:#e8a0a0;box-shadow:0 0 8px rgba(232,160,160,0.8); }
        .foyer-char-row {
          display: flex;
          gap: 0.8rem;
        }
        .foyer-char-card {
          flex: 1;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 0.5rem;
          background: rgba(255,255,255,0.1);
          backdrop-filter: blur(18px);
          -webkit-backdrop-filter: blur(18px);
          border: 1px solid rgba(255,255,255,0.18);
          border-radius: 18px;
          padding: 1rem 0.5rem 0.8rem;
          cursor: pointer;
          transition: all 0.2s;
        }
        .foyer-char-card:hover { background: rgba(255,255,255,0.18); transform: translateY(-2px); }
        .foyer-char-avatar {
          width: 50px; height: 50px;
          border-radius: 50%;
          border: 2px solid rgba(255,255,255,0.3);
          background: linear-gradient(135deg,#c9b8e8,#b8cce8);
          display: flex;align-items:center;justify-content:center;
          font-size: 1.3rem;
          overflow: hidden;
          position: relative;
        }
        .foyer-char-avatar img { width:100%;height:100%;object-fit:cover; }
        .foyer-char-name { font-size:0.8rem;color:rgba(255,255,255,0.88);font-weight:500; }
        .foyer-char-sub { font-size:0.63rem;color:rgba(255,255,255,0.4);text-align:center; }
        .foyer-status-badge {
          display: inline-flex;
          align-items: center;
          gap: 0.35rem;
          background: rgba(255,255,255,0.12);
          border: 1px solid rgba(255,255,255,0.2);
          border-radius: 20px;
          padding: 0.3rem 0.7rem;
          cursor: pointer;
          font-size: 0.7rem;
          color: rgba(255,255,255,0.8);
          transition: background 0.15s;
        }
        .foyer-status-badge:hover { background: rgba(255,255,255,0.18); }
        .foyer-clock {
          font-family: 'Cormorant Garamond', serif;
          font-size: 3.2rem;
          color: rgba(255,255,255,0.85);
          line-height: 1;
          text-shadow: 0 4px 24px rgba(0,0,0,0.4);
          letter-spacing: -0.02em;
        }
        .foyer-date { font-size: 0.72rem; color: rgba(255,255,255,0.42); letter-spacing: 0.1em; margin-top: 0.15rem; }
      </style>

      <div class="foyer-bg" id="foyer-bg"></div>

      <div class="foyer-content">
        <!-- Header row -->
        <div style="display:flex;align-items:flex-start;justify-content:space-between;">
          <div>
            <div class="foyer-logo">erhabene</div>
          </div>
          <button class="foyer-status-badge user-status-badge" onclick="openStatusMenu()">🕒 自動</button>
        </div>

        <!-- 時鐘 -->
        <div>
          <div class="foyer-clock" id="foyer-clock">--:--</div>
          <div class="foyer-date" id="foyer-date"></div>
        </div>

        <!-- 派報亭 -->
        <div id="foyer-newsstand">
          <div class="foyer-section-label">📮 今日情報</div>
          <div id="foyer-papers"></div>
        </div>

        <!-- 核心角色 -->
        <div id="foyer-inner-circle">
          <div class="foyer-section-label">✦ 常用角色</div>
          <div class="foyer-char-row" id="foyer-char-row"></div>
        </div>
      </div>
    </div>

    <!-- CHAT PAGE -->
    <div class="page" id="chat-page">
      <div id="chat-header" style="display:none;">
        <!-- 手機版返回按鈕（桌機隱藏） -->
        <button id="mobile-back-btn" onclick="showMobileChatList()"
          style="display:none;border:none;background:none;font-size:1.3rem;cursor:pointer;
            color:var(--text-mid);padding:0 0.3rem 0 0;flex-shrink:0;"
          title="返回列表">‹</button>
        <div class="header-avatar" id="header-avatar">🌸</div>
        <div class="header-info">
          <div class="header-name" id="header-name">選擇角色</div>
          <div style="display:flex;align-items:center;gap:0.4rem;flex-wrap:wrap;">
            <div class="header-status" id="header-status">— 點擊角色開始聊天 —</div>
            <span id="pacing-badge" style="display:none;font-size:0.62rem;background:rgba(201,184,232,0.3);color:var(--text-mid);padding:0.1rem 0.45rem;border-radius:8px;border:1px solid rgba(201,184,232,0.4);cursor:pointer;white-space:nowrap;font-weight:600;" onclick="openChatOptions()" title="點擊變更節奏"></span>
          </div>
        </div>
        <div class="header-actions">
          <button class="header-btn" onclick="openChatOptions()" title="更多">⋯</button>
        </div>
      </div>
      
      <!-- 手機專用：內嵌聊天列表（不用覆蓋式 sidebar） -->
      <div id="mobile-chat-list" style="display:none;flex-direction:column;flex:1;overflow-y:auto;background:var(--sidebar-bg);"></div>

      <div id="messages-area">
        <div class="empty-state" id="empty-chat">
          <div class="empty-state-icon">🌸</div>
          <div class="empty-state-text">erhabene</div>
          <div class="empty-state-sub">選擇一個角色開始對話，<br>或新增你的第一個角色卡</div>
        </div>
      </div>
      
      <!-- 心聲面板 -->
      <div id="inner-voice-panel" style="display:none;padding:0.8rem 1rem 0.4rem;background:var(--header-bg);border-top:1px solid rgba(201,184,232,0.15);animation:slideUp 0.2s ease;">
        <div style="display:flex;align-items:flex-start;gap:0.7rem;">
          <div id="iv-avatar" style="width:28px;height:28px;border-radius:9px;background:linear-gradient(135deg,var(--lavender),var(--milk-blue));display:flex;align-items:center;justify-content:center;font-size:0.85rem;flex-shrink:0;overflow:hidden;opacity:0.7;"></div>
          <div style="flex:1;">
            <div style="font-size:0.65rem;color:var(--text-light);margin-bottom:0.25rem;font-style:italic;">💭 心聲（僅你可見）</div>
            <div id="iv-text" style="font-size:0.82rem;color:var(--text-mid);line-height:1.65;font-style:italic;white-space:pre-wrap;"></div>
          </div>
          <button onclick="closeInnerVoice()" style="background:none;border:none;color:var(--text-light);font-size:1rem;cursor:pointer;flex-shrink:0;padding:0;">×</button>
        </div>
      </div>

      <div id="input-area" style="display:none;">
        <div class="input-toolbar">
          <button class="toolbar-btn" onclick="triggerImageGen()" title="生成圖片">🖼️</button>
          <button class="toolbar-btn" onclick="document.getElementById('chat-img-upload').click()" title="上傳圖片">📷</button>
          <input type="file" id="chat-img-upload" accept="image/*" style="display:none" onchange="handleChatImageUpload(event)">
          <button class="toolbar-btn" onclick="openStickerPicker()" title="貼圖表情">🎭</button>
          <button class="toolbar-btn" id="memory-toggle-btn" onclick="toggleMemoryPanel()" title="記憶">🧠</button>
          <button class="toolbar-btn" onclick="generateInnerVoice()" title="心聲">💭</button>
          <button class="toolbar-btn" onclick="triggerDailyTopics()" title="今日話題">📰</button>
          <button class="toolbar-btn" onclick="triggerDailyReport()" title="每日早報">🗞️</button>
          <button class="toolbar-btn" id="holiday-btn" onclick="openHolidayModal()" title="節日劇情" style="position:relative;display:none;">🎉<span id="holiday-dot" style="position:absolute;top:2px;right:2px;width:6px;height:6px;border-radius:50%;background:#e8787a;display:none;"></span></button>
          <button class="toolbar-btn" onclick="switchPage('chars')" title="角色管理">🌸</button>
        </div>
        <!-- 今日話題欄 -->
        <div id="daily-topics-bar" class="daily-topics-bar" style="display:none;"></div>
        <!-- Image preview strip -->
        <div id="chat-img-preview-strip" style="display:none;padding:0.4rem 0;display:flex;flex-wrap:wrap;gap:0.4rem;align-items:center;"></div>
        <div class="input-row">
          <textarea id="msg-input" placeholder="傳訊息..." rows="1"
            onkeydown="handleInputKey(event)"
            oninput="autoResize(this)"></textarea>
          <button id="send-btn" onclick="sendMessage()">➤</button>
        </div>
      </div>
    </div>

    <!-- CHARACTERS PAGE -->
    <div class="page" id="chars-page">
      <div id="chat-header" style="padding:1rem 1.2rem; border-bottom:1px solid rgba(201,184,232,0.2); background:var(--header-bg); display:flex; align-items:center; justify-content:space-between;">
        <div style="font-size:1rem;font-weight:700;color:var(--text-dark)">角色管理</div>
        <div style="display:flex;gap:0.5rem;">
          <button class="header-btn" onclick="openImportModal()" title="匯入角色卡">📂</button>
          <button class="header-btn" onclick="openModal('add-char-modal')" title="新增角色">＋</button>
        </div>
      </div>
      <div id="chars-grid"></div>
    </div>

    <!-- SOCIAL PAGE -->
    <div class="page" id="social-page">
      <div class="char-filter-tabs" id="social-char-tabs"></div>
      <div class="social-feed" id="social-feed"></div>
    </div>

    <!-- DIARY PAGE -->
    <div class="page" id="diary-page">
      <div class="diary-header">
        <button class="diary-nav-btn" onclick="changeMonth(-1)">‹</button>
        <div class="diary-month" id="diary-month-label"></div>
        <button class="diary-nav-btn" onclick="changeMonth(1)">›</button>
      </div>
      <div class="char-filter-tabs" id="diary-char-tabs"></div>
      <div class="diary-calendar" id="diary-calendar"></div>
      <div class="diary-content" id="diary-content">
        <div class="diary-empty">點擊日期查看角色日記</div>
      </div>
    </div>

    <!-- THEATER PAGE 小劇場 -->
    <div class="page" id="theater-page">
      <div class="diary-header">
        <div style="font-size:1rem;font-weight:700;color:var(--text-dark);">🎭 小劇場</div>
        <div style="font-size:0.72rem;color:var(--text-light);">獨立敘事・不影響聊天</div>
      </div>
      <div class="char-filter-tabs" id="theater-char-tabs"></div>
      <div style="flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:1rem;">
        <div id="theater-compose-panel" style="background:rgba(255,255,255,0.88);border-radius:20px;padding:1.2rem;box-shadow:0 2px 10px var(--shadow);border:1px solid rgba(201,184,232,0.12);">
          <div class="modal-label" style="margin-bottom:0.6rem;">選擇角色</div>
          <select class="modal-select" id="theater-char-select" style="margin-bottom:0.8rem;" onchange="syncTheaterTabFromSelect(this.value)"></select>
          <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.4rem;">
            <div class="modal-label" style="margin-bottom:0;flex:1;">劇場情境描述</div>
            <div style="display:flex;gap:0.3rem;align-items:center;">
              <select class="modal-select" id="theater-template-select" style="font-size:0.75rem;padding:0.3rem 0.5rem;border-radius:8px;width:auto;" onchange="loadTheaterTemplate(this.value)">
                <option value="">📋 載入模板...</option>
              </select>
              <button onclick="openTheaterTemplateManager()" style="padding:0.3rem 0.55rem;background:var(--lavender-soft);border:1px solid var(--lavender-light);border-radius:8px;font-size:0.75rem;cursor:pointer;color:var(--text-mid);white-space:nowrap;" title="管理模板">⚙️</button>
            </div>
          </div>
          <textarea class="modal-textarea" id="theater-prompt" style="min-height:90px;margin-bottom:0.8rem;" placeholder="例：我們在咖啡廳突然下起大雨，被迫長時間等待...&#10;例：角色在我不知情的情況下一直暗戀著我...&#10;例：我生氣了，角色試圖哄我..."></textarea>
          <div class="modal-label" style="margin-bottom:0.6rem;">文風</div>
          <div style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:0.8rem;" id="theater-style-picker">
            <button onclick="setTheaterStyle('none',this)" class="diary-style-btn" data-style="none">（無）自由發揮</button>
            <button onclick="setTheaterStyle('romantic',this)" class="diary-style-btn active">💕 浪漫甜蜜</button>
            <button onclick="setTheaterStyle('dark',this)" class="diary-style-btn">🌑 陰暗深沉</button>
            <button onclick="setTheaterStyle('spicy',this)" class="diary-style-btn">🔥 色色撩人</button>
            <button onclick="setTheaterStyle('funny',this)" class="diary-style-btn">😂 輕鬆搞笑</button>
            <button onclick="setTheaterStyle('angsty',this)" class="diary-style-btn">💔 虐心虐戀</button>
          </div>
          <button onclick="generateTheater()" style="width:100%;padding:0.8rem;background:linear-gradient(135deg,var(--lavender),var(--milk-blue));border:none;border-radius:14px;color:white;font-family:inherit;font-size:0.9rem;cursor:pointer;font-weight:500;">✨ 生成小劇場</button>
        </div>
        <div id="theater-result" style="display:none;background:rgba(255,255,255,0.95);border-radius:20px;padding:1.5rem;box-shadow:0 2px 12px var(--shadow);border:1px solid rgba(201,184,232,0.15);">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
            <div style="font-size:0.78rem;color:var(--lavender);font-weight:500;" id="theater-result-title">✨ 小劇場</div>
            <div style="display:flex;gap:0.5rem;align-items:center;">
              <button onclick="saveCurrentTheater()" class="diary-regen-btn" style="background:linear-gradient(135deg,var(--lavender),var(--milk-blue));color:white;border:none;">💾 儲存</button>
              <button onclick="regenerateTheater()" class="diary-regen-btn">🔄 重新生成</button>
            </div>
          </div>
          <div id="theater-result-text" style="font-size:0.9rem;color:var(--text-dark);line-height:1.9;white-space:pre-wrap;"></div>
        </div>
        <div style="background:rgba(255,255,255,0.88);border-radius:20px;padding:1.2rem;box-shadow:0 2px 10px var(--shadow);border:1px solid rgba(201,184,232,0.12);">
          <div style="font-size:0.82rem;font-weight:600;color:var(--text-mid);margin-bottom:0.7rem;">📚 已儲存的小劇場</div>
          <div id="theater-history-list"><div style="font-size:0.8rem;color:var(--text-light);text-align:center;padding:0.8rem 0;">選擇角色後顯示歷史記錄</div></div>
        </div>
      </div>
    </div>

    <!-- ACHIEVEMENTS PAGE 成就系統 -->
    <div class="page" id="achievements-page">
      <div class="diary-header">
        <div style="font-size:1rem;font-weight:700;color:var(--text-dark);">🏆 成就系統</div>
        <button onclick="refreshAchievements()" class="diary-nav-btn" title="刷新成就">🔄</button>
      </div>
      <div style="flex:1;overflow-y:auto;padding:1rem;">
        <div style="margin-bottom:1rem;">
          <select class="modal-select" id="achievement-char-select" onchange="onAchievementCharChange()" style="width:100%;"></select>
        </div>
        <!-- 分頁 tabs -->
        <div style="display:flex;gap:0.4rem;margin-bottom:1rem;background:rgba(201,184,232,0.1);border-radius:14px;padding:0.3rem;">
          <button class="achievement-tab-btn active" id="achievement-tab-achieve" onclick="switchAchievementTab('achieve')" style="flex:1;padding:0.5rem;border:none;border-radius:10px;font-family:inherit;font-size:0.78rem;cursor:pointer;background:white;color:var(--text-dark);font-weight:600;box-shadow:0 1px 4px rgba(180,160,210,0.2);transition:all 0.15s;">🏆 成就</button>
          <button class="achievement-tab-btn" id="achievement-tab-moments" onclick="switchAchievementTab('moments')" style="flex:1;padding:0.5rem;border:none;border-radius:10px;font-family:inherit;font-size:0.78rem;cursor:pointer;background:transparent;color:var(--text-light);transition:all 0.15s;">✨ 特別時刻</button>
          <button class="achievement-tab-btn" id="achievement-tab-fragment" onclick="switchAchievementTab('fragment')" style="flex:1;padding:0.5rem;border:none;border-radius:10px;font-family:inherit;font-size:0.78rem;cursor:pointer;background:transparent;color:var(--text-light);transition:all 0.15s;">🔮 碎片畫廊</button>
        </div>
        <!-- 成就 tab -->
        <div class="achievement-tab-content active" id="achievement-content-achieve">
          <div id="achievement-stats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.6rem;margin-bottom:1rem;"></div>
          <div id="achievement-list" style="display:flex;flex-direction:column;gap:0.7rem;"></div>
        </div>
        <!-- 特別時刻 tab -->
        <div class="achievement-tab-content" id="achievement-content-moments" style="display:none;">
          <div id="moments-gallery"></div>
        </div>
        <!-- 碎片畫廊 tab -->
        <div class="achievement-tab-content" id="achievement-content-fragment" style="display:none;">
          <div id="fragment-gallery"></div>
        </div>
      </div>
    </div>

    <!-- SETTINGS PAGE -->
    <div class="page" id="settings-page" style="overflow-y:auto;">
      <div style="padding:1rem 1.2rem; background:var(--header-bg); border-bottom:1px solid rgba(201,184,232,0.2); font-size:1rem; font-weight:700; color:var(--text-dark);">設定</div>
      
      <div class="settings-section">
        <div class="settings-section-title">API 設定</div>
        <div class="settings-item" onclick="openApiSettings()">
          <div class="settings-item-icon" style="background:var(--lavender-soft)">🔑</div>
          <div class="settings-item-label">API Key</div>
          <div class="settings-item-value" id="api-key-display">••••••</div>
          <div class="settings-item-arrow">›</div>
        </div>
        <div class="settings-item" onclick="openModal('model-settings-modal')">
          <div class="settings-item-icon" style="background:var(--milk-blue-soft)">🤖</div>
          <div class="settings-item-label">全域模型設定</div>
          <div class="settings-item-value" id="current-model-display"></div>
          <div class="settings-item-arrow">›</div>
        </div>
        <div class="settings-item" onclick="openFeatureModelsModal()">
          <div class="settings-item-icon" style="background:var(--lavender-soft)">🎛️</div>
          <div class="settings-item-label">各功能獨立模型</div>
          <div class="settings-item-value" style="font-size:0.72rem;">聊天/社群/日記/劇場…</div>
          <div class="settings-item-arrow">›</div>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-section-title">角色與 Persona</div>
        <div class="settings-item" onclick="openModal('persona-modal')">
          <div class="settings-item-icon" style="background:var(--beige)">🎭</div>
          <div class="settings-item-label">我的 Persona</div>
          <div class="settings-item-value" id="persona-display">未設定</div>
          <div class="settings-item-arrow">›</div>
        </div>
        <div class="settings-item" onclick="openModal('preset-modal')">
          <div class="settings-item-icon" style="background:var(--lavender-soft)">📋</div>
          <div class="settings-item-label">Preset / 提示詞</div>
          <div class="settings-item-arrow">›</div>
        </div>
        <div class="settings-item" onclick="openModal('lorebook-modal')">
          <div class="settings-item-icon" style="background:var(--milk-blue-soft)">📚</div>
          <div class="settings-item-label">Lorebook</div>
          <div class="settings-item-arrow">›</div>
        </div>
      </div>
      

      <div class="settings-section">
        <div class="settings-section-title">介面操作</div>
        <div class="settings-item" onclick="toggleDarkMode()">
          <div class="settings-item-icon" style="background:var(--lavender-soft)">🌙</div>
          <div style="flex:1;">
            <div class="settings-item-label">黑暗模式</div>
            <div style="font-size:0.72rem;color:var(--text-light);margin-top:2px;">減少夜間閱讀的眼睛疲勞</div>
          </div>
          <div class="toggle-switch" id="dark-mode-toggle"></div>
        </div>
        <div class="settings-item" onclick="toggleSwipeDelete()">
          <div class="settings-item-icon" style="background:var(--lavender-soft)">👈</div>
          <div style="flex:1;">
            <div class="settings-item-label">左滑刪除訊息</div>
            <div style="font-size:0.72rem;color:var(--text-light);margin-top:2px;">關閉時顯示側邊 × 按鈕</div>
          </div>
          <div class="toggle-switch" id="swipe-delete-toggle"></div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">現實連動</div>
        <div class="settings-item">
          <div class="settings-item-icon" style="background:#fff0f0">🎂</div>
          <div class="settings-item-label">生日提醒</div>
          <input type="date" id="birthday-input" style="border:none;background:none;font-family:inherit;font-size:0.8rem;color:var(--text-light);outline:none;">
        </div>
        <div class="settings-item" onclick="toggleRealWorldEvents()">
          <div class="settings-item-icon" style="background:#f0fff0">💌</div>
          <div class="settings-item-label">節日主動邀約</div>
          <div class="toggle-switch" id="realworld-toggle"></div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">💍 紀念日管理</div>
        <div id="anniversary-list" style="display:flex;flex-direction:column;gap:0.5rem;margin-bottom:0.8rem;"></div>
        <div class="settings-item" onclick="openAnniversaryModal()" style="border:1.5px dashed rgba(201,184,232,0.4);background:rgba(201,184,232,0.06);">
          <div class="settings-item-icon" style="background:var(--lavender-soft)">＋</div>
          <div class="settings-item-label" style="color:var(--text-light)">新增紀念日</div>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-section-title">資料管理</div>
        <div class="settings-item" onclick="exportBackup()">
          <div class="settings-item-icon" style="background:var(--lavender-soft)">💾</div>
          <div class="settings-item-label">匯出備份</div>
          <div class="settings-item-arrow">›</div>
        </div>
        <div class="settings-item" onclick="importBackup()">
          <div class="settings-item-icon" style="background:var(--milk-blue-soft)">📥</div>
          <div class="settings-item-label">匯入備份</div>
          <div class="settings-item-arrow">›</div>
        </div>
        <div class="settings-item" onclick="confirmClearAll()">
          <div class="settings-item-icon" style="background:#fff0f0">🗑️</div>
          <div class="settings-item-label" style="color:#e87878">清除所有資料</div>
          <div class="settings-item-arrow">›</div>
        </div>
      </div>
    </div>

  </div>

  <!-- Memory Panel -->
  <div id="memory-panel">
    <div class="memory-header">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="memory-title">🧠 長期記憶</div>
        <button onclick="toggleMemoryPanel()" style="background:none;border:none;cursor:pointer;color:var(--text-light);font-size:1.1rem;">×</button>
      </div>
    </div>
    <div class="memory-list" id="memory-list"></div>
    <button class="memory-add-btn" onclick="addMemoryItem()">＋ 新增記憶</button>
  </div>

</div>

<!-- ─── CONTEXT MENU ─── -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-item" onclick="ctxAction('copy')">📋 複製</div>
  <div class="ctx-item" onclick="ctxAction('edit')">✏️ 編輯</div>
  <div class="ctx-divider"></div>
  <div class="ctx-item" onclick="ctxAction('regen')">🔄 重新生成</div>
  <div class="ctx-divider"></div>
  <div class="ctx-item danger" onclick="ctxAction('delete')">🗑️ 刪除訊息</div>
</div>

<!-- ─── TOAST ─── -->
<div class="toast" id="toast"></div>

<!-- ─── BOTTOM NAV ─── -->
<nav id="bottom-nav">
  <button class="bottom-nav-btn active" onclick="switchPage('foyer')" id="bnav-foyer">
    <span class="icon">🏠</span><span>玄關</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('chat')" id="bnav-chat">
    <span class="icon">💬</span><span>聊天</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('social')" id="bnav-social">
    <span class="icon">✦</span><span>社群</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('diary')" id="bnav-diary">
    <span class="icon">📔</span><span>日記</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('theater')" id="bnav-theater">
    <span class="icon">🎭</span><span>小劇場</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('achievements')" id="bnav-achievements">
    <span class="icon">🏆</span><span>成就</span>
  </button>
  <button class="bottom-nav-btn" onclick="switchPage('settings')" id="bnav-settings">
    <span class="icon">⚙️</span><span>設定</span>
  </button>
</nav>

<!-- ─── MODALS ─── -->

<!-- ADD / EDIT CHAR MODAL -->
<div class="modal-overlay" id="add-char-modal">
  <div class="modal">
    <div class="modal-title" id="add-char-modal-title">🌸 新增角色</div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchModalTab(this,'char-manual')">手動建立</button>
      <button class="modal-tab" onclick="switchModalTab(this,'char-import')">匯入角色卡</button>
    </div>
    <div class="modal-tab-content active" id="char-manual">
      <div class="modal-field">
        <label class="modal-label">角色名稱</label>
        <input class="modal-input" id="char-name-input" placeholder="例：小雨">
      </div>
      <div class="modal-field">
        <label class="modal-label">頭像</label>
        <div style="display:flex;align-items:center;gap:0.7rem;margin-bottom:0.5rem;">
          <div id="char-avatar-preview" style="width:48px;height:48px;border-radius:14px;background:var(--lavender-soft);border:1.5px solid var(--lavender-light);display:flex;align-items:center;justify-content:center;font-size:1.8rem;overflow:hidden;flex-shrink:0;"></div>
          <div style="flex:1;">
            <input class="modal-input" id="char-avatar-input" placeholder="🌸 或貼上圖片 URL" style="margin-bottom:0.4rem;">
            <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;font-size:0.78rem;color:var(--text-mid);background:var(--lavender-soft);border:1px solid var(--lavender-light);border-radius:10px;padding:0.35rem 0.7rem;width:fit-content;">
              📷 上傳圖片
              <input type="file" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)">
            </label>
          </div>
        </div>
      </div>
      <div class="modal-field">
        <label class="modal-label">角色描述 (Character Card)</label>
        <textarea class="modal-textarea" id="char-desc-input" placeholder="描述角色的個性、背景、說話方式..."></textarea>
      </div>
      <div class="modal-field">
        <label class="modal-label">開場白 (First Message)</label>
        <textarea class="modal-textarea" id="char-first-msg-input" style="min-height:70px" placeholder="角色的第一句話..."></textarea>
      </div>
      <div class="modal-field">
        <label class="modal-label">綁定 Persona</label>
        <select class="modal-select" id="char-persona-select">
          <option value="">不綁定</option>
        </select>
      </div>
      <div class="modal-field">
        <label class="modal-label">初始關係狀態 <span style="font-size:0.7rem;color:var(--text-light);">（決定開局時 AI 的互動方式）</span></label>
        <select class="modal-select" id="char-rel-select">
          <option value="stranger">👤 陌生人</option>
          <option value="acquaint">🤝 普通朋友</option>
          <option value="friend">😊 好朋友</option>
          <option value="close">💛 摯友</option>
          <option value="ambiguous">💫 曖昧中</option>
          <option value="crush">💕 心動</option>
          <option value="lover">❤️ 戀人</option>
          <option value="devoted">💍 摯愛</option>
        </select>
        <div style="font-size:0.72rem;color:var(--text-light);margin-top:0.3rem;">之後會根據對話內容動態演變。若要重置或手動調整，可在角色設定中修改。</div>
      </div>
      <div class="modal-field">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
          <label class="modal-label" style="margin:0;">🕐 作息模擬 <span style="font-size:0.7rem;color:var(--text-light);">（讓 AI 知道角色的時間表）</span></label>
          <div class="toggle-switch" id="char-schedule-toggle" onclick="this.classList.toggle('on')"></div>
        </div>
        <textarea class="modal-textarea" id="char-schedule-input" style="min-height:60px" placeholder="例：freelancer，凌晨2點才睡，中午12點前不起床，下午是工作高峰&#10;例：平日9-18上班，晚上10點洗澡睡覺，假日比較晚起"></textarea>
        <div style="font-size:0.68rem;color:var(--text-light);margin-top:0.2rem;">開啟後，每次對話 AI 都會知道現在幾點、角色的作息，並自然融入回應</div>
      </div>
    </div>
    <div class="modal-tab-content" id="char-import">
      <div style="padding:1rem;text-align:center;color:var(--text-light);">
        <p style="margin-bottom:1rem;font-size:0.88rem;">支援 SillyTavern 角色卡格式</p>
        <label style="cursor:pointer;">
          <div style="padding:1.5rem;border:2px dashed rgba(201,184,232,0.4);border-radius:14px;">
            <div style="font-size:2rem;margin-bottom:0.5rem;">📂</div>
            <div style="font-size:0.85rem;">點擊選擇 .json 或 .png 檔案</div>
          </div>
          <input type="file" accept=".json,.png" style="display:none" onchange="importCharCard(event)">
        </label>
      </div>
    </div>
    <div class="modal-actions" style="flex-wrap:wrap;gap:0.4rem;">
      <button class="modal-btn secondary" onclick="closeModal('add-char-modal')" style="flex:1;min-width:80px;">取消</button>
      <button id="delete-char-btn" class="modal-btn secondary" onclick="deleteCharFromModal()" style="flex:1;min-width:80px;color:#e87878;display:none;">🗑️ 刪除角色</button>
      <button id="save-char-btn" class="modal-btn primary" onclick="saveChar()" style="flex:2;min-width:100px;">建立角色</button>
    </div>
  </div>
</div>

<!-- PRESET MODAL -->
<div class="modal-overlay" id="preset-modal">
  <div class="modal">
    <div class="modal-title">📋 Preset 提示詞設定</div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchModalTab(this,'preset-system')">System Prompt</button>
      <button class="modal-tab" onclick="switchModalTab(this,'preset-jailbreak')">越獄提示詞</button>
      <button class="modal-tab" onclick="switchModalTab(this,'preset-regex')">Regex</button>
    </div>
    <div class="modal-tab-content active" id="preset-system">
      <div class="modal-field">
        <label class="modal-label">主要 System Prompt</label>
        <textarea class="modal-textarea" id="system-prompt-input" style="min-height:140px" placeholder="You are {{char}}, talking to {{user}}. Reply in Traditional Chinese..."></textarea>
      </div>
      <div class="modal-field">
        <label class="modal-label">對話風格模式 <span style="font-size:0.7rem;color:var(--text-light);">（切換後自動更新 System Prompt）</span></label>
        <select class="modal-select" id="chat-style-select" onchange="onChatStyleChange(this.value)">
          <option value="line">📱 LINE 模式（短訊息、分段傳送）</option>
          <option value="prose">📖 長篇模式（一段式、情感豐富）</option>
          <option value="custom">✏️ 自訂（手動編輯 System Prompt）</option>
        </select>
        <div style="font-size:0.72rem;color:var(--text-light);margin-top:0.3rem;">選擇模式後，下方 System Prompt 會自動填入對應內容，可再自行微調。</div>
      </div>
    </div>
    <div class="modal-tab-content" id="preset-jailbreak">
      <div class="modal-field">
        <label class="modal-label">越獄提示詞 (注入到 Context 末尾)</label>
        <textarea class="modal-textarea" id="jailbreak-input" style="min-height:140px" placeholder="[場景描述，幫助 AI 更好地扮演角色...]"></textarea>
      </div>
      <div class="modal-field">
        <label class="modal-label">注入位置</label>
        <select class="modal-select" id="jailbreak-position">
          <option value="before_char">角色描述之前</option>
          <option value="after_char">角色描述之後</option>
          <option value="before_last">最後一則訊息之前</option>
          <option value="system">System 層</option>
        </select>
      </div>
    </div>
    <div class="modal-tab-content" id="preset-regex">
      <div class="modal-field">
        <label class="modal-label">Regex 規則 (每行一條，格式: pattern → replacement)</label>
        <textarea class="modal-textarea" id="regex-input" style="min-height:140px;font-family:monospace;font-size:0.8rem;" placeholder="\\*\\*(.*?)\\*\\* → $1&#10;\*.*?\* → "></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('preset-modal')">取消</button>
      <button class="modal-btn primary" onclick="savePreset()">儲存</button>
    </div>
  </div>
</div>

<!-- LOREBOOK MODAL -->
<div class="modal-overlay" id="lorebook-modal">
  <div class="modal" style="width:min(660px,96vw);max-height:90dvh;padding:1.5rem;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.8rem;">
      <div style="display:flex;align-items:center;gap:0.6rem;">
        <div style="font-size:1.3rem;">📚</div>
        <div>
          <div class="modal-title" style="margin:0;font-size:1rem;">Lorebook / World Info</div>
          <div style="font-size:0.68rem;color:var(--text-light);letter-spacing:0.05em;">SillyTavern 相容格式</div>
        </div>
      </div>
      <div id="lb-count"></div>
    </div>
    <!-- Scope Tabs -->
    <div class="modal-tabs" style="margin-bottom:0.8rem;">
      <button class="modal-tab active" id="lb-tab-global" onclick="switchLbTab('global',this)">🌍 全域 Lorebook</button>
      <button class="modal-tab" id="lb-tab-char" onclick="switchLbTab('char',this)">🌸 角色 Lorebook</button>
      <button class="modal-tab" id="lb-tab-chat" onclick="switchLbTab('chat',this)">💬 聊天 Lorebook</button>
    </div>
    <!-- Scope description -->
    <div class="lb-st-info" style="margin-bottom:0.8rem;" id="lb-scope-info">
      <span>🌍</span><span>全域：對所有對話生效 · 關鍵字觸發自動注入 · Constant 永遠注入</span>
    </div>
    <!-- Char selector (for char tab) -->
    <div id="lb-char-selector" style="display:none;margin-bottom:0.8rem;">
      <select class="lb-select" id="lb-char-sel" onchange="renderLorebookList()">
        <option value="">選擇角色...</option>
      </select>
    </div>
    <div id="lorebook-list" style="margin-bottom:0.8rem;max-height:calc(90dvh - 260px);overflow-y:auto;display:flex;flex-direction:column;gap:0.5rem;padding-right:2px;"></div>
    <div style="display:flex;gap:0.5rem;">
      <button onclick="addLorebookEntry()" style="flex:1;padding:0.65rem;background:var(--lavender-soft);border:1.5px dashed rgba(201,184,232,0.5);border-radius:12px;font-family:inherit;font-size:0.85rem;color:var(--text-mid);cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center;gap:0.4rem;">＋ 新增條目</button>
      <button class="modal-btn primary" onclick="saveLorebook()" style="flex:0 0 auto;padding:0.65rem 1.4rem;">完成</button>
    </div>
  </div>
</div>
<!-- PERSONA MODAL -->
<div class="modal-overlay" id="persona-modal">
  <div class="modal" style="width:min(560px,96vw);max-height:90dvh;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem;">
      <div class="modal-title" style="margin:0;">🎭 我的 Persona</div>
      <button onclick="openAddPersonaPanel()" style="padding:0.4rem 0.9rem;background:linear-gradient(135deg,var(--lavender),var(--milk-blue));border:none;border-radius:10px;color:white;font-family:inherit;font-size:0.78rem;cursor:pointer;" id="persona-add-btn">＋ 新增</button>
    </div>
    <!-- Persona List -->
    <div id="persona-list" style="max-height:calc(90dvh - 220px);overflow-y:auto;display:flex;flex-direction:column;gap:0.6rem;margin-bottom:1rem;"></div>
    <!-- Add/Edit Panel -->
    <div id="persona-edit-panel" style="display:none;background:var(--lavender-soft);border-radius:16px;padding:1.1rem;border:1.5px solid rgba(201,184,232,0.3);margin-bottom:0.8rem;">
      <div style="font-size:0.82rem;font-weight:600;color:var(--lavender);margin-bottom:0.8rem;" id="persona-panel-title">＋ 新增 Persona</div>
      <div style="display:flex;gap:0.8rem;margin-bottom:0.8rem;align-items:flex-start;">
        <!-- Avatar -->
        <div style="display:flex;flex-direction:column;align-items:center;gap:0.4rem;flex-shrink:0;">
          <div id="persona-avatar-preview" style="width:60px;height:60px;border-radius:18px;background:var(--lavender-light);display:flex;align-items:center;justify-content:center;font-size:2rem;overflow:hidden;border:2px solid rgba(201,184,232,0.4);cursor:pointer;" onclick="document.getElementById('persona-avatar-file').click()">🎭</div>
          <input type="file" id="persona-avatar-file" accept="image/*" style="display:none" onchange="handlePersonaAvatarUpload(event)">
          <div style="font-size:0.62rem;color:var(--text-light);">點擊上傳</div>
        </div>
        <div style="flex:1;display:flex;flex-direction:column;gap:0.5rem;">
          <input class="lb-input" id="persona-name-input" placeholder="Persona 名稱（你的角色名）" style="font-weight:500;">
          <textarea class="lb-textarea" id="persona-desc-input" placeholder="描述你自己的個性、說話方式、背景..." style="min-height:60px;font-size:0.82rem;"></textarea>
        </div>
      </div>
      <!-- Bound chars -->
      <div style="margin-bottom:0.7rem;">
        <div style="font-size:0.72rem;color:var(--text-light);margin-bottom:0.4rem;letter-spacing:0.05em;">綁定角色（可多選）</div>
        <div id="persona-char-checkboxes" style="display:flex;flex-wrap:wrap;gap:0.4rem;"></div>
      </div>
      <div style="display:flex;gap:0.4rem;">
        <button onclick="cancelPersonaEdit()" class="msg-edit-btn cancel" style="flex:1;">取消</button>
        <button onclick="savePersonaFromPanel()" class="msg-edit-btn confirm" style="flex:2;">✓ 儲存</button>
      </div>
    </div>
    <div class="modal-actions" style="margin-top:0;">
      <button class="modal-btn secondary" onclick="closeModal('persona-modal')">關閉</button>
    </div>
  </div>
</div>

<!-- MODEL SETTINGS MODAL -->
<div class="modal-overlay" id="model-settings-modal">
  <div class="modal">
    <div class="modal-title">🤖 模型設定</div>
    <div class="modal-field">
      <label class="modal-label">API Key</label>
      <input class="modal-input" type="password" id="api-key-update" placeholder="AIza...">
    </div>
    <div class="modal-field">
      <label class="modal-label">模型名稱（可自行輸入任意模型 ID）</label>
      <input class="modal-input" type="text" id="model-custom-input"
        placeholder="例：gemini-3-flash-preview"
        list="model-datalist-settings">
      <datalist id="model-datalist-settings">
        <option value="gemini-3-flash-preview">Gemini 3 Flash Preview（最新）</option>
        <option value="gemini-3-pro-preview">Gemini 3 Pro Preview（最新）</option>
        <option value="gemini-3-flash-exp">Gemini 3 Flash Exp</option>
        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
      </datalist>
      <div style="font-size:0.72rem;color:var(--text-light);margin-top:0.35rem;">直接輸入模型 ID 即可使用任何 Gemini 版本</div>
      <!-- hidden for backward compat -->
      <select id="model-update-select" style="display:none">
        <option value="gemini-3-flash-preview">gemini-3-flash-preview</option>
        <option value="gemini-3-pro-preview">gemini-3-pro-preview</option>
        <option value="gemini-2.0-flash">gemini-2.0-flash</option>
        <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp</option>
      </select>
    </div>
    <div class="modal-field">
      <label class="modal-label">Temperature</label>
      <input type="range" min="0" max="2" step="0.1" value="1.0" id="temp-slider" oninput="document.getElementById('temp-val').textContent=this.value" style="width:100%">
      <span id="temp-val" style="font-size:0.8rem;color:var(--text-light)">1.0</span>
    </div>
    <div class="modal-field">
      <label class="modal-label">Max Output Tokens <span style="font-size:0.7rem;color:var(--text-light);">（每次回覆最多輸出幾個 token）</span></label>
      <input class="modal-input" type="number" id="max-tokens-input" value="2048" min="100" max="65536">
    </div>
    <div class="modal-field">
      <label class="modal-label">上下文訊息數量 <span style="font-size:0.7rem;color:var(--text-light);">（送出幾則歷史訊息作為上下文，越大越耗 token）</span></label>
      <input class="modal-input" type="number" id="context-msgs-input" value="30" min="1" max="200">
      <div style="font-size:0.72rem;color:var(--text-light);margin-top:0.35rem;">建議值：10～50 則。調小可節省 token 用量，調大可讓 AI 記得更久遠的對話。</div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('model-settings-modal')">取消</button>
      <button class="modal-btn primary" onclick="saveModelSettings()">儲存</button>
    </div>
  </div>
</div>

<!-- FEATURE MODELS MODAL -->
<div class="modal-overlay" id="model-features-modal">
  <div class="modal" style="width:min(520px,96vw);max-height:85vh;overflow-y:auto;">
    <div class="modal-title">🎛️ 各功能獨立模型設定</div>
    <div style="font-size:0.75rem;color:var(--text-light);margin-bottom:1rem;">空白 = 使用全域模型。可輸入任意 Gemini 模型 ID。</div>
    
    <div class="modal-field">
      <label class="modal-label">💬 一般聊天（Chat）</label>
      <input class="modal-input" type="text" id="model-feat-chat" placeholder="空白=使用全域模型" list="feat-model-list">
      <div class="modal-label" id="model-feat-hint-chat" style="margin-top:0.2rem;"></div>
    </div>
    <div class="modal-field">
      <label class="modal-label">🌊 社群貼文（Social Post）</label>
      <input class="modal-input" type="text" id="model-feat-social" placeholder="空白=使用全域模型" list="feat-model-list">
      <div class="modal-label" id="model-feat-hint-social" style="margin-top:0.2rem;"></div>
    </div>
    <div class="modal-field">
      <label class="modal-label">💬 社群留言回覆（Comment）</label>
      <input class="modal-input" type="text" id="model-feat-socialcomment" placeholder="空白=使用全域模型" list="feat-model-list">
      <div class="modal-label" id="model-feat-hint-socialcomment" style="margin-top:0.2rem;"></div>
    </div>
    <div class="modal-field">
      <label class="modal-label">📔 日記生成（Diary）</label>
      <input class="modal-input" type="text" id="model-feat-diary" placeholder="空白=使用全域模型" list="feat-model-list">
      <div class="modal-label" id="model-feat-hint-diary" style="margin-top:0.2rem;"></div>
    </div>
    <div class="modal-field">
      <label class="modal-label">🎭 小劇場（Theater）</label>
      <input class="modal-input" type="text" id="model-feat-theater" placeholder="空白=使用全域模型" list="feat-model-list">
      <div class="modal-label" id="model-feat-hint-theater" style="margin-top:0.2rem;"></div>
    </div>
    <div class="modal-field">
      <label class="modal-label">🧠 長期記憶提取（Memory）</label>
      <input class="modal-input" type="text" id="model-feat-memory" placeholder="空白=使用全域模型" list="feat-model-list">
      <div class="modal-label" id="model-feat-hint-memory" style="margin-top:0.2rem;"></div>
    </div>
    <div class="modal-field">
      <label class="modal-label">💭 心聲系統（Inner Voice）</label>
      <input class="modal-input" type="text" id="model-feat-innervoice" placeholder="空白=使用全域模型" list="feat-model-list">
      <div class="modal-label" id="model-feat-hint-innervoice" style="margin-top:0.2rem;"></div>
    </div>

    <datalist id="feat-model-list">
      <option value="gemini-3-flash-preview">Gemini 3 Flash Preview</option>
      <option value="gemini-3-pro-preview">Gemini 3 Pro Preview</option>
      <option value="gemini-3-flash-exp">Gemini 3 Flash Exp</option>
      <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
      <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
      <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
      <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
    </datalist>

    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('model-features-modal')">取消</button>
      <button class="modal-btn primary" onclick="saveFeatureModels()">儲存</button>
    </div>
  </div>
</div>

<!-- IMAGE PREVIEW MODAL -->
<div class="modal-overlay" id="image-preview-modal" onclick="closeModal('image-preview-modal')">
  <div style="max-width:90vw;max-height:90vh;">
    <img id="preview-img" style="max-width:100%;max-height:90vh;border-radius:18px;display:block;">
  </div>
</div>

<!-- IMAGE GEN OPTIONS MODAL (聊天視窗) -->
<div class="modal-overlay" id="imagegen-modal">
  <div class="modal" style="width:min(480px,96vw);">
    <div class="modal-title">🖼️ 生成圖片</div>
    <div class="modal-field">
      <label class="modal-label">構圖類型</label>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.5rem;" id="imagegen-type-picker">
        <button class="imagegen-type-btn active" data-type="solo" onclick="selectImageGenType('solo',this)">
          <div style="font-size:1.4rem;margin-bottom:0.3rem;">👤</div>
          <div style="font-size:0.82rem;font-weight:500;">角色獨照</div>
        </button>
        <button class="imagegen-type-btn" data-type="duo" onclick="selectImageGenType('duo',this)">
          <div style="font-size:1.4rem;margin-bottom:0.3rem;">👥</div>
          <div style="font-size:0.82rem;font-weight:500;">雙人合照</div>
        </button>
        <button class="imagegen-type-btn" data-type="scene" onclick="selectImageGenType('scene',this)">
          <div style="font-size:1.4rem;margin-bottom:0.3rem;">🌅</div>
          <div style="font-size:0.82rem;font-weight:500;">純場景</div>
        </button>
      </div>
    </div>
    <div class="modal-field">
      <label class="modal-label">畫風</label>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.4rem;" id="imagegen-style-picker">
        <button class="imagegen-style-btn active" data-style="anime" onclick="selectImageGenStyle('anime',this)">
          <div style="font-size:1.2rem;">🎌</div><div style="font-size:0.75rem;margin-top:0.2rem;">動漫插畫</div>
        </button>
        <button class="imagegen-style-btn" data-style="watercolor" onclick="selectImageGenStyle('watercolor',this)">
          <div style="font-size:1.2rem;">🎨</div><div style="font-size:0.75rem;margin-top:0.2rem;">水彩軟萌</div>
        </button>
        <button class="imagegen-style-btn" data-style="chibi" onclick="selectImageGenStyle('chibi',this)">
          <div style="font-size:1.2rem;">🌸</div><div style="font-size:0.75rem;margin-top:0.2rem;">Q版可愛</div>
        </button>
        <button class="imagegen-style-btn" data-style="sketch" onclick="selectImageGenStyle('sketch',this)">
          <div style="font-size:1.2rem;">✏️</div><div style="font-size:0.75rem;margin-top:0.2rem;">線稿風格</div>
        </button>
        <button class="imagegen-style-btn" data-style="fantasy" onclick="selectImageGenStyle('fantasy',this)">
          <div style="font-size:1.2rem;">✨</div><div style="font-size:0.75rem;margin-top:0.2rem;">奇幻插畫</div>
        </button>
        <button class="imagegen-style-btn" data-style="lofi" onclick="selectImageGenStyle('lofi',this)">
          <div style="font-size:1.2rem;">🌙</div><div style="font-size:0.75rem;margin-top:0.2rem;">Lo-Fi 氛圍</div>
        </button>
      </div>
    </div>
    <div class="modal-field">
      <label class="modal-label">額外描述（選填）</label>
      <input class="modal-input" id="imagegen-extra-prompt" placeholder="例：笑著看窗外、下雨天、校服...">
    </div>
    <div id="imagegen-ref-info" style="font-size:0.75rem;color:var(--text-light);padding:0.4rem 0.6rem;background:var(--lavender-soft);border-radius:8px;margin-top:-0.3rem;"></div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('imagegen-modal')">取消</button>
      <button class="modal-btn primary" onclick="doTriggerImageGen()">✨ 生成</button>
    </div>
  </div>
</div>

<!-- SOCIAL COMPOSE MODAL -->
<div class="modal-overlay" id="social-compose-modal">
  <div class="modal" style="width:min(520px,96vw);">
    <div class="modal-title" id="social-compose-title">✦ 讓角色發文</div>

    <div class="modal-field">
      <label class="modal-label">發文角色</label>
      <select class="modal-select" id="social-post-char-select" onchange="socialUpdatePersonaInfo()"></select>
    </div>

    <!-- Persona 資訊顯示 -->
    <div id="social-persona-info" style="display:none;padding:0.5rem 0.8rem;background:var(--lavender-soft);border-radius:10px;border:1px solid rgba(201,184,232,0.25);font-size:0.78rem;color:var(--text-mid);margin-bottom:0.6rem;display:flex;align-items:center;gap:0.5rem;">
      <span>🎭</span><span id="social-persona-name-display"></span>
    </div>

    <div class="modal-field">
      <label class="modal-label">發文內容提示</label>
      <textarea class="modal-textarea" id="social-post-prompt" placeholder="描述你希望角色發什麼主題的文章...（留空讓角色自由發揮）"></textarea>
    </div>

    <div class="modal-field">
      <label class="modal-label">圖片生成</label>
      <select class="modal-select" id="social-image-option" onchange="socialToggleImageStyleField()">
        <option value="none">不生成圖片</option>
        <option value="solo_anime">獨照 · 動漫插畫風</option>
        <option value="solo_watercolor">獨照 · 水彩軟萌風</option>
        <option value="solo_chibi">獨照 · Q版可愛風</option>
        <option value="duo_anime">雙人照 · 動漫插畫風</option>
        <option value="duo_watercolor">雙人照 · 水彩軟萌風</option>
        <option value="selfie_anime">自拍 · 動漫風</option>
        <option value="auto">根據貼文內容自動生成</option>
      </select>
    </div>

    <div class="modal-field">
      <label class="modal-label">使用模型</label>
      <input class="modal-input" type="text" id="social-model-input"
        placeholder="例：gemini-3-flash-preview"
        list="social-model-datalist">
      <datalist id="social-model-datalist">
        <option value="gemini-3-flash-preview">Gemini 3 Flash Preview</option>
        <option value="gemini-3-pro-preview">Gemini 3 Pro Preview</option>
        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
      </datalist>
      <div style="font-size:0.7rem;color:var(--text-light);margin-top:0.3rem;">留空則使用主模型設定（<span id="social-main-model-hint"></span>）</div>
    </div>

    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('social-compose-modal')">取消</button>
      <button class="modal-btn primary" onclick="aiPostSocial()">✦ 發布</button>
    </div>
  </div>
</div>

<!-- CHAR INFO MODAL (quick view) -->
<div class="modal-overlay" id="char-info-modal">
  <div class="modal">
    <div style="text-align:center;margin-bottom:1rem;">
      <div id="char-info-avatar" style="width:80px;height:80px;border-radius:24px;background:linear-gradient(135deg,var(--lavender),var(--milk-blue));display:flex;align-items:center;justify-content:center;font-size:2.5rem;margin:0 auto 0.8rem;overflow:hidden;"></div>
      <div id="char-info-name" style="font-size:1.2rem;font-weight:700;color:var(--text-dark);"></div>
    </div>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchModalTab(this,'ci-desc')">描述</button>
      <button class="modal-tab" onclick="switchModalTab(this,'ci-chats')">聊天窗</button>
      <button class="modal-tab" onclick="switchModalTab(this,'ci-export')">匯出</button>
    </div>
    <div class="modal-tab-content active" id="ci-desc">
      <div id="char-info-desc" style="font-size:0.85rem;color:var(--text-mid);line-height:1.7;max-height:200px;overflow-y:auto;"></div>
    </div>
    <div class="modal-tab-content" id="ci-chats">
      <div id="char-info-chats" style="display:flex;flex-direction:column;gap:0.5rem;"></div>
      <button onclick="newChatWithChar()" style="width:100%;margin-top:0.8rem;padding:0.6rem;background:var(--lavender-soft);border:1.5px dashed rgba(201,184,232,0.4);border-radius:12px;font-family:inherit;font-size:0.82rem;color:var(--text-mid);cursor:pointer;">＋ 新開聊天窗</button>
    </div>
    <div class="modal-tab-content" id="ci-export">
      <div style="display:flex;flex-direction:column;gap:0.5rem;">
        <button class="modal-btn secondary" onclick="exportCharAsJson()">匯出為 JSON 角色卡</button>
        <button class="modal-btn secondary" onclick="exportChatHistory()">匯出聊天記錄</button>
        <button class="modal-btn secondary" onclick="exportChatAsST()">匯出為 ST 格式</button>
      </div>
    </div>
    <div class="modal-actions" style="flex-wrap:wrap;gap:0.4rem;">
      <button class="modal-btn secondary" onclick="closeModal('char-info-modal')" style="flex:1;">關閉</button>
      <button class="modal-btn secondary" onclick="deleteChar(state.activeCharId)" style="flex:1;color:#e87878;">🗑️ 刪除角色</button>
      <button class="modal-btn primary" onclick="editChar()" style="flex:2;">✏️ 編輯角色</button>
    </div>
  </div>
</div>

<!-- ANNIVERSARY MODAL -->
<div class="modal-overlay" id="anniversary-modal">
  <div class="modal">
    <div class="modal-title">💍 新增紀念日</div>
    <div class="modal-field">
      <label class="modal-label">紀念日類型</label>
      <select class="modal-select" id="anniv-type" onchange="toggleAnnivCustomField()">
        <option value="confession">💌 告白日</option>
        <option value="dating">💕 交往紀念日</option>
        <option value="wedding">💍 結婚紀念日</option>
        <option value="firstmeet">🌸 初次相遇</option>
        <option value="custom">✨ 自訂</option>
      </select>
    </div>
    <div class="modal-field" id="anniv-custom-field" style="display:none;">
      <label class="modal-label">自訂名稱</label>
      <input class="modal-input" id="anniv-custom-name" placeholder="例：第一次約會">
    </div>
    <div class="modal-field">
      <label class="modal-label">綁定角色</label>
      <select class="modal-select" id="anniv-char-select"></select>
    </div>
    <div class="modal-field">
      <label class="modal-label">日期</label>
      <input class="modal-input" type="date" id="anniv-date">
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('anniversary-modal')">取消</button>
      <button class="modal-btn primary" onclick="saveAnniversary()">儲存</button>
    </div>
  </div>
</div>

<script src="app.js"></script>
</body>
</html>
